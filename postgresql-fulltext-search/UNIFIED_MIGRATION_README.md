# 统一迁移脚本说明

## 概述

本文档说明了 `AttachCatalogueTemplate` 相关迁移脚本的合并情况。为了简化维护和提高一致性，我们将多个分散的迁移脚本合并为一个统一的脚本。

## 合并的脚本

### 1. 原始脚本

-   `complete-migration-script.sql` - 完整的模板迁移脚本
-   `attach-catalogue-template-permissions-migration.sql` - 模板权限字段迁移
-   `attach-catalogue-templates-migration.sql` - 模板增强迁移

### 2. 统一后的脚本

-   `unified-attach-catalogue-template-migration.sql` - 统一的模板迁移脚本

## 合并内容

### 表结构创建

-   完整的表创建语句
-   所有必要字段的定义
-   主键和约束设置

### 字段管理

-   `TEMPLATE_TYPE` - 模板类型
-   `TEMPLATE_PURPOSE` - 模板用途
-   `TEXT_VECTOR` - 文本向量
-   `VECTOR_DIMENSION` - 向量维度
-   `PERMISSIONS` - 权限集合（JSONB 格式）

### 数据清理

-   NULL 值处理
-   空字符串标准化
-   无效 JSON 数据修复

### 约束和验证

-   向量维度范围检查 (0-2048)
-   模板类型枚举值验证
-   模板用途枚举值验证
-   权限格式验证（JSONB 数组）

### 索引体系

-   基础业务索引
-   模板标识索引
-   向量维度索引
-   权限集合 GIN 索引
-   全文搜索索引

### 外键关系

-   自引用外键（父子关系）
-   级联删除设置

### 注释和文档

-   表注释
-   字段注释
-   执行状态提示

### 示例数据

-   通用附件分类模板
-   项目级附件分类模板
-   阶段级附件分类模板
-   智能数据插入（仅当表为空时）

## 使用方法

### 1. 执行统一迁移脚本

```sql
-- 在PostgreSQL中执行
\i unified-attach-catalogue-template-migration.sql
```

### 2. 验证执行结果

脚本会自动显示：

-   执行状态和进度
-   数据统计信息
-   表结构信息
-   约束和索引状态
-   示例数据插入结果

## 优势

### 1. 维护性

-   单一文件管理
-   避免重复和冲突
-   统一的执行逻辑

### 2. 可靠性

-   事务保护
-   存在性检查
-   错误处理和回滚

### 3. 完整性

-   覆盖所有功能
-   统一的约束和索引
-   完整的数据清理
-   智能示例数据

### 4. 可读性

-   清晰的步骤划分
-   详细的注释说明
-   统一的命名规范

## 注意事项

### 1. 执行顺序

-   建议在数据库初始化后执行
-   确保相关依赖表已存在
-   建议在维护窗口期间执行

### 2. 数据备份

-   执行前建议备份数据库
-   生产环境谨慎操作
-   测试环境先验证

### 3. 权限要求

-   需要数据库管理员权限
-   需要创建表和索引的权限
-   需要修改表结构的权限

### 4. 示例数据

-   仅在表为空时插入
-   包含三种典型模板类型
-   使用合理的默认值

## 后续维护

### 1. 版本管理

-   保持脚本版本记录
-   记录修改历史
-   定期审查和更新

### 2. 测试验证

-   在测试环境验证
-   检查所有功能正常
-   验证性能影响

### 3. 文档更新

-   及时更新本文档
-   记录已知问题
-   提供故障排除指南

## 联系信息

如有问题或建议，请联系开发团队或查看项目文档。
