# å¤šç»´çŸ¥è¯†å›¾è°±ç³»ç»ŸæŠ€æœ¯æ–¹æ¡ˆæŠ¥å‘Š

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

å¤šç»´çŸ¥è¯†å›¾è°±ç³»ç»Ÿæ—¨åœ¨æ„å»ºä¸€ä¸ªä»¥é™„ä»¶ç®¡ç†ç³»ç»Ÿä¸ºæ ¸å¿ƒçš„äº”ç»´çŸ¥è¯†ç½‘ç»œå¯è§†åŒ–å¹³å°ï¼Œé€šè¿‡å…³ç³»å›¾è°±ã€æ—¶é—´è½´è¿½æº¯ã€å½±å“åˆ†æç­‰åŠŸèƒ½ï¼Œå®ç°ä¸šåŠ¡å…³ç³»çš„ç›´è§‚å‘ˆç°å’Œæ™ºèƒ½åˆ†æã€‚ç³»ç»Ÿä»¥**åˆ†ç±»ï¼ˆCatalogueï¼‰**ä¸ºæ ¸å¿ƒå®ä½“ï¼Œé€šè¿‡**äººå‘˜ï¼ˆPersonï¼‰**ã€**éƒ¨é—¨ï¼ˆDepartmentï¼‰**ã€**ä¸šåŠ¡å®ä½“ï¼ˆBusinessEntityï¼‰**å’Œ**å·¥ä½œæµï¼ˆWorkflowï¼‰**ç­‰ç»´åº¦æ„å»ºå®Œæ•´çš„çŸ¥è¯†ç½‘ç»œã€‚åˆ†ç±»ä¸åˆ†ç±»ä¹‹é—´çš„å…³ç³»ï¼ˆå¦‚é¡¹ç›®é˜¶æ®µä¸åŒæ—¶æœŸçš„æ¡£æ¡ˆã€æŒ‰æ—¶é—´æˆ–ä¸šåŠ¡åˆ’åˆ†çš„åˆ†ç±»ï¼‰æ˜¯å›¾è°±çš„æ ¸å¿ƒå…³ç³»ã€‚å·¥ä½œæµç»´åº¦ç”¨äºç®¡ç†æ¡£æ¡ˆçš„åˆ›å»ºã€å®¡æ ¸ã€å½’æ¡£ç­‰ä¸šåŠ¡æµç¨‹ã€‚

### 1.2 æ ¸å¿ƒç›®æ ‡

-   **å¯è§†åŒ–å±•ç¤º**ï¼šç›´è§‚å‘ˆç°äº”ç»´å®ä½“ï¼ˆåˆ†ç±»ã€äººå‘˜ã€éƒ¨é—¨ã€ä¸šåŠ¡å®ä½“ã€å·¥ä½œæµï¼‰é—´çš„å¤æ‚ä¸šåŠ¡å…³ç³»ç½‘ç»œï¼Œé‡ç‚¹å±•ç¤ºåˆ†ç±»ä¸åˆ†ç±»ä¹‹é—´çš„å…³ç³»ï¼ˆæ—¶é—´ç»´åº¦ã€ä¸šåŠ¡ç»´åº¦ç­‰ï¼‰ä»¥åŠå·¥ä½œæµå¯¹åˆ†ç±»ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†
-   **æ™ºèƒ½æœç´¢**ï¼šæ”¯æŒå¤šç»´åº¦èŠ‚ç‚¹æœç´¢å’Œç²¾ç¡®å®šä½ï¼ŒåŒ…æ‹¬åˆ†ç±»åç§°ã€æ ‡ç­¾ã€å·¥ä½œæµåç§°ç­‰
-   **æ—¶é—´è¿½æº¯**ï¼šæŒ‰ä¸šåŠ¡é˜¶æ®µå±•ç¤ºå®ä½“å˜åŒ–å’Œå…³ç³»æ¼”è¿›ï¼Œè¿½è¸ªåˆ†ç±»çš„åˆ›å»ºã€æ›´æ–°å†å²ã€åˆ†ç±»é—´çš„æ—¶é—´å…³ç³»ä»¥åŠå·¥ä½œæµæ‰§è¡Œå†å²
-   **å½±å“åˆ†æ**ï¼šè‡ªåŠ¨è®¡ç®—èŠ‚ç‚¹å˜æ›´çš„å½±å“èŒƒå›´å’Œé£é™©ç­‰çº§ï¼Œåˆ†æåˆ†ç±»å˜æ›´å¯¹å…¶ä»–åˆ†ç±»ã€äººå‘˜ã€éƒ¨é—¨ã€ä¸šåŠ¡å®ä½“ã€å·¥ä½œæµçš„å½±å“
-   **é£é™©é¢„è­¦**ï¼šå®æ—¶ç›‘æ§å’Œåˆ†çº§é¢„è­¦ï¼Œç¼©çŸ­å“åº”æ—¶é—´ï¼Œé‡ç‚¹å…³æ³¨åˆ†ç±»å®Œæ•´æ€§ã€å…³ç³»ä¸€è‡´æ€§ã€å·¥ä½œæµæ‰§è¡Œå¼‚å¸¸ç­‰

### 1.3 æŠ€æœ¯ç‰¹ç‚¹

-   åŸºäºå›¾æ•°æ®åº“çš„é«˜æ€§èƒ½å…³ç³»æŸ¥è¯¢
-   å®æ—¶æ•°æ®åŒæ­¥å’Œå¢é‡æ›´æ–°
-   å¤šç»´åº¦æ•°æ®èšåˆå’Œç»Ÿè®¡åˆ†æ
-   æ™ºèƒ½å½±å“åŠå¾„è®¡ç®—ç®—æ³•
-   åˆ†çº§é£é™©é¢„è­¦æœºåˆ¶

---

## 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯å±•ç¤ºå±‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ å›¾è°±è§†å›¾  â”‚  â”‚ æœç´¢é¢æ¿  â”‚  â”‚ æ—¶é—´è½´   â”‚  â”‚ è¯¦æƒ…é¢æ¿  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†• HTTP/WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIç½‘å…³å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è®¤è¯æˆæƒ  â”‚  â”‚ é™æµç†”æ–­  â”‚  â”‚ æ—¥å¿—ç›‘æ§  â”‚  â”‚ è·¯ç”±è½¬å‘  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ä¸šåŠ¡æœåŠ¡å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ å›¾è°±æœåŠ¡      â”‚  â”‚ æœç´¢æœåŠ¡      â”‚  â”‚ åˆ†ææœåŠ¡      â”‚      â”‚
â”‚  â”‚ - å…³ç³»æŸ¥è¯¢    â”‚  â”‚ - å…¨æ–‡æ£€ç´¢    â”‚  â”‚ - å½±å“åˆ†æ    â”‚      â”‚
â”‚  â”‚ - è·¯å¾„è®¡ç®—    â”‚  â”‚ - æ’åºç®—æ³•    â”‚  â”‚ - é£é™©è¯„ä¼°    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ æ—¶é—´è½´æœåŠ¡    â”‚  â”‚ é¢„è­¦æœåŠ¡      â”‚  â”‚ é€šçŸ¥æœåŠ¡      â”‚      â”‚
â”‚  â”‚ - é˜¶æ®µåˆ’åˆ†    â”‚  â”‚ - è§„åˆ™å¼•æ“    â”‚  â”‚ - æ¶ˆæ¯æ¨é€    â”‚      â”‚
â”‚  â”‚ - å˜åŒ–è¿½è¸ª    â”‚  â”‚ - åˆ†çº§é¢„è­¦    â”‚  â”‚ - è´£ä»»äººé€šçŸ¥  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å­˜å‚¨å±‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ PostgreSQL + Apache AGEï¼ˆç»Ÿä¸€æ•°æ®åº“ï¼‰   â”‚                 â”‚
â”‚  â”‚ - ä¸šåŠ¡æ•°æ®ï¼ˆAPPATTACH_CATALOGUESç­‰ï¼‰   â”‚                 â”‚
â”‚  â”‚ - å›¾æ•°æ®ï¼ˆé€šè¿‡ AGE æ‰©å±•ï¼‰              â”‚                 â”‚
â”‚  â”‚ - å…³ç³»æ•°æ®ï¼ˆAPPKG_RELATIONSHIPSï¼‰      â”‚                 â”‚
â”‚  â”‚ - å…¨æ–‡æœç´¢ï¼ˆPostgreSQL å†…ç½®ï¼‰          â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©

#### 2.2.1 å‰ç«¯æŠ€æœ¯æ ˆ

-   **æ¡†æ¶**ï¼šReact 18+
-   **å›¾è°±å¯è§†åŒ–**ï¼šCytoscape.jsï¼ˆå¼ºå¤§çš„å›¾å¸ƒå±€ç®—æ³•ï¼Œæ”¯æŒå¤æ‚å…³ç³»ç½‘ç»œï¼‰
-   **çŠ¶æ€ç®¡ç†**ï¼šZustand
-   **UI ç»„ä»¶åº“**ï¼šAnt Design
-   **æ—¶é—´è½´ç»„ä»¶**ï¼švis-timeline
-   **WebSocket å®¢æˆ·ç«¯**ï¼šSocket.io-clientï¼ˆå®æ—¶æ•°æ®æ¨é€ï¼‰

#### 2.2.2 åç«¯æŠ€æœ¯æ ˆ

-   **æ¡†æ¶**ï¼šASP.NET Core 8.0ï¼ˆåŸºäºç°æœ‰ ABP æ¡†æ¶ï¼‰
-   **æ•°æ®åº“**ï¼šPostgreSQL 14+ï¼ˆç»Ÿä¸€å­˜å‚¨ä¸šåŠ¡æ•°æ®å’Œå›¾æ•°æ®ï¼‰
-   **å›¾æ•°æ®åº“æ‰©å±•**ï¼šApache AGEï¼ˆPostgreSQL å›¾æ•°æ®åº“æ‰©å±•ï¼Œæ”¯æŒ Cypher æŸ¥è¯¢è¯­è¨€ï¼‰
-   **å…¨æ–‡æœç´¢**ï¼šPostgreSQL å…¨æ–‡æœç´¢ï¼ˆåˆ©ç”¨ PostgreSQL å†…ç½®å…¨æ–‡æœç´¢åŠŸèƒ½ï¼Œæ— éœ€é¢å¤–æœç´¢å¼•æ“ï¼‰
-   **æ¶ˆæ¯é˜Ÿåˆ—**ï¼šRabbitMQ / Redis Streamsï¼ˆå¼‚æ­¥å¤„ç†å’Œé€šçŸ¥ï¼‰
-   **ç¼“å­˜**ï¼šRedisï¼ˆçƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼‰

> **æŠ€æœ¯é€‰å‹è¯´æ˜**ï¼šé€‰æ‹© Apache AGE è€Œé Neo4j çš„åŸå› ï¼š
>
> -   âœ… **ç»Ÿä¸€æ•°æ®å­˜å‚¨**ï¼šä¸ç°æœ‰ PostgreSQL æ•°æ®åº“ç»Ÿä¸€ï¼Œå‡å°‘è¿ç»´å¤æ‚åº¦
> -   âœ… **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šåŸç”Ÿæ”¯æŒ ACID äº‹åŠ¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
> -   âœ… **Cypher å…¼å®¹**ï¼šæ”¯æŒ Cypher æŸ¥è¯¢è¯­è¨€ï¼Œè¿ç§»æˆæœ¬ä½
> -   âœ… **æˆæœ¬æ•ˆç›Š**ï¼šå¼€æºå…è´¹ï¼Œé™ä½å¼€å‘å’Œè¿ç»´æˆæœ¬
> -   âœ… **æ€§èƒ½è¶³å¤Ÿ**ï¼šæ»¡è¶³ä¸­å°å‹é¡¹ç›®çš„æ€§èƒ½éœ€æ±‚
> -   ğŸ“– è¯¦ç»†åˆ†æè¯·å‚è€ƒï¼š[PostgreSQL å›¾æ•°æ®åº“æ‰©å±•æŠ€æœ¯åˆ†ææŠ¥å‘Š](./PostgreSQL-Graph-Extension-Analysis.md)

#### 2.2.3 æ•°æ®åŒæ­¥

-   **é¢†åŸŸäº‹ä»¶**ï¼šä½¿ç”¨ ABP æ¡†æ¶çš„é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰æœºåˆ¶ç›‘å¬å®ä½“å˜æ›´
-   **åå°æœåŠ¡**ï¼šä½¿ç”¨ ABP æ¡†æ¶çš„åå°ä½œä¸šï¼ˆBackground Jobsï¼‰è¿›è¡Œå¼‚æ­¥å›¾æ•°æ®æ›´æ–°
-   **äº‹ä»¶æ€»çº¿**ï¼šä½¿ç”¨ ABP æ¡†æ¶çš„æœ¬åœ°äº‹ä»¶æ€»çº¿ï¼ˆLocal Event Busï¼‰å¤„ç†é¢†åŸŸäº‹ä»¶
-   **ç»Ÿä¸€äº‹åŠ¡**ï¼šä¸šåŠ¡æ•°æ®å’Œå›¾æ•°æ®åœ¨åŒä¸€ PostgreSQL æ•°æ®åº“ä¸­ï¼Œæ”¯æŒç»Ÿä¸€äº‹åŠ¡ç®¡ç†ï¼ˆæ— éœ€è·¨æ•°æ®åº“åŒæ­¥ï¼‰

---

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 å®ä½“æ¨¡å‹ï¼ˆEntity Modelï¼‰

#### 3.1.1 äº”ç»´å®ä½“å®šä¹‰ï¼ˆä¼˜åŒ–åï¼‰

> **é‡è¦è¯´æ˜**ï¼šçŸ¥è¯†å›¾è°±çš„å®ä½“å®šä¹‰é‡‡ç”¨**å¼•ç”¨æ¨¡å¼**ï¼Œä¸é‡å¤å®šä¹‰å·²æœ‰å®ä½“çš„æ‰€æœ‰å­—æ®µã€‚
>
> -   **å·²æœ‰å®ä½“**ï¼š`AttachCatalogue`ï¼ˆåˆ†ç±»ï¼‰
> -   **çŸ¥è¯†å›¾è°±å®ä½“**ï¼šåªå®šä¹‰å›¾è°±æŸ¥è¯¢å’Œåˆ†æéœ€è¦çš„æ ¸å¿ƒå­—æ®µï¼Œé€šè¿‡ `Id` å…³è”åˆ°ç°æœ‰å®ä½“
> -   **æ•°æ®è·å–**ï¼šå®ä½“çš„å®Œæ•´ä¿¡æ¯é€šè¿‡ JOIN ç°æœ‰å®ä½“è¡¨è·å–ï¼Œé¿å…æ•°æ®å†—ä½™
> -   **ç»´åº¦è¯´æ˜**ï¼š
>     -   **åˆ†ç±»ï¼ˆCatalogueï¼‰**ï¼šæ ¸å¿ƒç»´åº¦ï¼Œæ–‡ä»¶é€šè¿‡åˆ†ç±»ç›´æ¥è®¿é—®ï¼Œæ¨¡æ¿å’Œåˆ†é¢ä¿¡æ¯å·²ä½“ç°åœ¨åˆ†ç±»ä¸­
>     -   **äººå‘˜ï¼ˆPersonï¼‰**ï¼šé€šè¿‡å®¡è®¡å­—æ®µå…³è”ï¼Œè¡¨ç¤ºåˆ›å»ºã€ç®¡ç†åˆ†ç±»çš„äººå‘˜
>     -   **éƒ¨é—¨ï¼ˆDepartmentï¼‰**ï¼šç»„ç»‡ç»´åº¦ï¼Œè¡¨ç¤ºåˆ†ç±»æ‰€å±çš„éƒ¨é—¨
>     -   **ä¸šåŠ¡å®ä½“ï¼ˆBusinessEntityï¼‰**ï¼šä¸šåŠ¡ç»´åº¦ï¼Œè¡¨ç¤ºé¡¹ç›®ã€æµç¨‹ã€åˆåŒç­‰ä¸šåŠ¡å®ä½“
>     -   **å·¥ä½œæµï¼ˆWorkflowï¼‰**ï¼šæµç¨‹ç»´åº¦ï¼Œç®¡ç†æ¡£æ¡ˆçš„åˆ›å»ºã€å®¡æ ¸ã€å½’æ¡£ç­‰ä¸šåŠ¡æµç¨‹ï¼Œå®šä¹‰åˆ†ç±»çš„ç”Ÿå‘½å‘¨æœŸå’Œå®¡æ‰¹æµç¨‹

> **âœ… å·²åˆ›å»ºè§†å›¾æ¨¡å‹**ï¼šä»¥ä¸‹è§†å›¾æ¨¡å‹å·²åœ¨é¡¹ç›®ä¸­åˆ›å»ºï¼Œä½äº `Hx.Abp.Attachment.Application.Contracts/KnowledgeGraph/` å‘½åç©ºé—´ä¸‹ã€‚

```csharp
// å®ä½“åŸºç±»ï¼ˆå›¾è°±æŸ¥è¯¢è§†å›¾æ¨¡å‹ï¼‰
// æ³¨æ„ï¼šè¿™æ˜¯å›¾è°±æŸ¥è¯¢çš„è§†å›¾æ¨¡å‹ï¼Œä¸æ˜¯æ•°æ®åº“å®ä½“
// å®é™…æ•°æ®å­˜å‚¨åœ¨ç°æœ‰å®ä½“è¡¨ä¸­ï¼ˆAPPATTACH_CATALOGUESç­‰ï¼‰
// é€šè¿‡ EntityId å…³è”åˆ°ç°æœ‰å®ä½“çš„ Id å­—æ®µï¼Œé¿å…ä¸ç»§æ‰¿ç±»çš„æ ‡è¯†å­—æ®µå†²çª
// æ–‡ä»¶ä½ç½®ï¼šKnowledgeGraphEntityViewModel.cs
public abstract class KnowledgeGraphEntityViewModel
{
    /// <summary>
    /// å…³è”åˆ°ç°æœ‰å®ä½“è¡¨çš„IDï¼ˆå¦‚ AttachCatalogue.Idï¼‰
    /// ä½¿ç”¨ EntityId è€Œä¸æ˜¯ Idï¼Œé¿å…ä¸ç»§æ‰¿ç±»çš„æ ‡è¯†å­—æ®µå†²çª
    /// </summary>
    public Guid EntityId { get; set; }

    public string EntityType { get; set; } // å®ä½“ç±»å‹ï¼ˆCatalogue, Person, Department, BusinessEntity, Workflowï¼‰
    public string Name { get; set; } // å®ä½“åç§°ï¼ˆä»ç°æœ‰å®ä½“è¡¨è·å–ï¼‰
    public List<string> Tags { get; set; } // æ ‡ç­¾åˆ—è¡¨ï¼ˆä»ç°æœ‰å®ä½“è¡¨è·å–ï¼‰
    public string Status { get; set; } // ç»Ÿä¸€çŠ¶æ€ç®¡ç†ï¼ˆACTIVE, ARCHIVED, DELETEDç­‰ï¼‰
    public Dictionary<string, object> GraphProperties { get; set; } // å›¾è°±ç‰¹æœ‰å±æ€§ï¼ˆå¦‚é‡è¦æ€§è¯„åˆ†ã€ä¸­å¿ƒåº¦ç­‰ï¼‰
    // æ³¨æ„ï¼šå…¶ä»–ä¸šåŠ¡å­—æ®µï¼ˆå¦‚CatalogueNameç­‰ï¼‰é€šè¿‡JOINç°æœ‰å®ä½“è¡¨è·å–
    // CreatedBy/UpdatedByç­‰ä¿¡æ¯é€šè¿‡ABPæ¡†æ¶çš„å®¡è®¡å­—æ®µè·å–
}

// åˆ†ç±»å®ä½“è§†å›¾æ¨¡å‹ï¼ˆæ ¸å¿ƒï¼‰- å¼•ç”¨AttachCatalogue
// åªåŒ…å«å›¾è°±æŸ¥è¯¢éœ€è¦çš„æ ¸å¿ƒå­—æ®µ
// æ–‡ä»¶ä½ç½®ï¼šCatalogueEntityViewModel.cs
public class CatalogueEntityViewModel : KnowledgeGraphEntityViewModel
{
    // æ ¸å¿ƒå…³è”å­—æ®µï¼ˆç”¨äºå›¾è°±æŸ¥è¯¢ï¼‰
    public string Reference { get; set; } // ä¸šåŠ¡å¼•ç”¨IDï¼ˆç”¨äºå…³è”BusinessEntityï¼‰
    public int ReferenceType { get; set; } // ä¸šåŠ¡ç±»å‹æ ‡è¯†ï¼ˆç”¨äºå…³è”BusinessEntityï¼‰
    public Guid? ParentId { get; set; } // çˆ¶åˆ†ç±»IDï¼ˆç”¨äºå»ºç«‹æ ‘å½¢å…³ç³»å’Œåˆ†ç±»é—´å…³ç³»ï¼‰

    // å›¾è°±æŸ¥è¯¢ä¼˜åŒ–å­—æ®µï¼ˆå¯é€‰ï¼Œå­˜å‚¨åœ¨kg_entity_graph_metadataè¡¨ï¼‰
    public double? ImportanceScore { get; set; } // é‡è¦æ€§è¯„åˆ†ï¼ˆç”¨äºå½±å“åˆ†æï¼‰
    public int? RelationshipCount { get; set; } // å…³ç³»æ•°é‡ï¼ˆç”¨äºä¸­å¿ƒåº¦è®¡ç®—ï¼‰

    // æ³¨æ„ï¼šå…¶ä»–å­—æ®µï¼ˆCatalogueNameã€FacetTypeã€AttachCountç­‰ï¼‰é€šè¿‡JOIN APPATTACH_CATALOGUESè¡¨è·å–
    // æ¨¡æ¿å’Œåˆ†é¢ä¿¡æ¯å·²ä½“ç°åœ¨åˆ†ç±»çš„FacetTypeç­‰å­—æ®µä¸­ï¼Œæ— éœ€å•ç‹¬ç»´åº¦
}

// äººå‘˜å®ä½“è§†å›¾æ¨¡å‹ - é€šè¿‡å®¡è®¡å­—æ®µå…³è”ï¼ˆCreatorIdç­‰ï¼‰
// ç®€åŒ–å®šä¹‰ï¼ŒåªåŒ…å«å›¾è°±æŸ¥è¯¢éœ€è¦çš„å­—æ®µ
// æ–‡ä»¶ä½ç½®ï¼šPersonEntityViewModel.cs
public class PersonEntityViewModel : KnowledgeGraphEntityViewModel
{
    public string EmployeeId { get; set; } // å‘˜å·¥IDï¼ˆå…³è”åˆ°ç”¨æˆ·ç³»ç»Ÿï¼‰
    public Guid? DepartmentId { get; set; } // å…³è”éƒ¨é—¨ID

    // å›¾è°±ç»Ÿè®¡å­—æ®µï¼ˆå¯é€‰ï¼‰
    public int CreatedCatalogueCount { get; set; } // åˆ›å»ºçš„åˆ†ç±»æ•°é‡

    // æ³¨æ„ï¼šå…¶ä»–å­—æ®µï¼ˆPositionã€Emailã€Phoneç­‰ï¼‰é€šè¿‡å…³è”ç”¨æˆ·ç³»ç»Ÿè·å–
}

// éƒ¨é—¨å®ä½“è§†å›¾æ¨¡å‹ - ç»„ç»‡ç»´åº¦
// è¡¨ç¤ºåˆ†ç±»æ‰€å±çš„éƒ¨é—¨ï¼Œé€šè¿‡Referenceå’ŒReferenceTypeå…³è”
// æ–‡ä»¶ä½ç½®ï¼šDepartmentEntityViewModel.cs
public class DepartmentEntityViewModel : KnowledgeGraphEntityViewModel
{
    public string DepartmentCode { get; set; } // éƒ¨é—¨ç¼–ç 
    public Guid? ParentDepartmentId { get; set; } // çˆ¶éƒ¨é—¨IDï¼ˆç”¨äºå±‚çº§ç»“æ„ï¼‰

    // å›¾è°±ç»Ÿè®¡å­—æ®µï¼ˆå¯é€‰ï¼‰
    public int CatalogueCount { get; set; } // å…³è”çš„åˆ†ç±»æ•°é‡
    public int PersonCount { get; set; } // éƒ¨é—¨äººå‘˜æ•°é‡

    // æ³¨æ„ï¼šå…¶ä»–å­—æ®µï¼ˆDepartmentNameã€ManagerIdç­‰ï¼‰é€šè¿‡å…³è”ç»„ç»‡ç³»ç»Ÿè·å–
}

// ä¸šåŠ¡å®ä½“è§†å›¾æ¨¡å‹ - é€šè¿‡Referenceå’ŒReferenceTypeå…³è”çš„å¤–éƒ¨ä¸šåŠ¡å®ä½“
// æ”¯æŒé¡¹ç›®ã€æµç¨‹ã€åˆåŒã€ä»»åŠ¡ç­‰å¤šç§ä¸šåŠ¡ç±»å‹ï¼ˆä¸åŒ…æ‹¬éƒ¨é—¨ï¼Œéƒ¨é—¨å•ç‹¬ä½œä¸ºç»´åº¦ï¼‰
// æ–‡ä»¶ä½ç½®ï¼šBusinessEntityViewModel.cs
public class BusinessEntityViewModel : KnowledgeGraphEntityViewModel
{
    public string ReferenceId { get; set; } // å¯¹åº”AttachCatalogue.Reference
    public int ReferenceType { get; set; } // å¯¹åº”AttachCatalogue.ReferenceType
    public string BusinessType { get; set; } // ä¸šåŠ¡ç±»å‹åç§°ï¼ˆå¦‚"Project"ã€"Process"ã€"Contract"ç­‰ï¼‰

    // å›¾è°±ç»Ÿè®¡å­—æ®µï¼ˆå¯é€‰ï¼‰
    public int CatalogueCount { get; set; } // å…³è”çš„åˆ†ç±»æ•°é‡

    // æ³¨æ„ï¼šä¸šåŠ¡ä¸“å±å±æ€§é€šè¿‡å…³è”å¤–éƒ¨ä¸šåŠ¡ç³»ç»Ÿè·å–ï¼Œä¸åœ¨æ­¤å¤„å­˜å‚¨
}

// å·¥ä½œæµå®ä½“è§†å›¾æ¨¡å‹ - æµç¨‹ç»´åº¦
// ç®¡ç†æ¡£æ¡ˆçš„åˆ›å»ºã€å®¡æ ¸ã€å½’æ¡£ç­‰ä¸šåŠ¡æµç¨‹ï¼Œå®šä¹‰åˆ†ç±»çš„ç”Ÿå‘½å‘¨æœŸå’Œå®¡æ‰¹æµç¨‹
// æ–‡ä»¶ä½ç½®ï¼šWorkflowEntityViewModel.cs
public class WorkflowEntityViewModel : KnowledgeGraphEntityViewModel
{
    public string WorkflowCode { get; set; } // å·¥ä½œæµç¼–ç ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰
    public string WorkflowType { get; set; } // å·¥ä½œæµç±»å‹ï¼ˆåˆ›å»ºå®¡æ‰¹ã€å½’æ¡£å®¡æ‰¹ã€é”€æ¯å®¡æ‰¹ç­‰ï¼‰
    public string Status { get; set; } // å·¥ä½œæµçŠ¶æ€ï¼ˆACTIVE, ARCHIVED, DISABLEDï¼‰
    public Guid? TemplateDefinitionId { get; set; } // æ¨¡æ¿å®šä¹‰Idï¼ˆå…³è”åˆ°å·¥ä½œæµæ¨¡æ¿å®šä¹‰ï¼‰
    public int TemplateDefinitionVersion { get; set; } // æ¨¡æ¿å®šä¹‰ç‰ˆæœ¬ï¼ˆå·¥ä½œæµæ¨¡æ¿å®šä¹‰çš„ç‰ˆæœ¬å·ï¼‰

    // å…³è”ä¿¡æ¯
    public Guid? OwnerDepartmentId { get; set; } // æ‹¥æœ‰éƒ¨é—¨ID
    public Guid? ManagerPersonId { get; set; } // ç®¡ç†å‘˜äººå‘˜ID

    // å›¾è°±ç»Ÿè®¡å­—æ®µï¼ˆå¯é€‰ï¼‰
    public int CatalogueCount { get; set; } // å…³è”çš„åˆ†ç±»æ•°é‡ï¼ˆä½¿ç”¨è¯¥å·¥ä½œæµçš„åˆ†ç±»æ•°ï¼‰
    public int InstanceCount { get; set; } // å·¥ä½œæµå®ä¾‹æ•°é‡
    public int ActiveInstanceCount { get; set; } // æ´»è·ƒå®ä¾‹æ•°é‡

    // æ³¨æ„ï¼šå·¥ä½œæµçš„è¯¦ç»†å®šä¹‰ï¼ˆèŠ‚ç‚¹ã€è¾¹ã€æ¡ä»¶ç­‰ï¼‰é€šè¿‡å…³è”å·¥ä½œæµå¼•æ“è·å–ï¼Œä¸åœ¨æ­¤å¤„å­˜å‚¨
}
```

#### 3.1.2 å…³ç³»æ¨¡å‹ï¼ˆRelationship Modelï¼‰

````csharp
> **âœ… å·²åˆ›å»ºå…³ç³»å®ä½“**ï¼šä»¥ä¸‹å…³ç³»å®ä½“å’Œæšä¸¾å·²åœ¨é¡¹ç›®ä¸­åˆ›å»ºã€‚
> - å…³ç³»å®ä½“ï¼š`Hx.Abp.Attachment.Domain/KnowledgeGraph/KnowledgeGraphRelationship.cs`
> - æšä¸¾ç±»å‹ï¼š`Hx.Abp.Attachment.Dmain.Shared/Domain/Shared/KnowledgeGraph/` ç›®å½•ä¸‹
> - æ•°æ®åº“é…ç½®ï¼š`Hx.Abp.Attachment.EntityFrameworkCore/KnowledgeGraphRelationshipEntityTypeConfiguration.cs`

```csharp
// çŸ¥è¯†å›¾è°±å…³ç³»å®ä½“
// æ³¨æ„ï¼šå…³ç³»æ•°æ®å­˜å‚¨åœ¨APPKG_RELATIONSHIPSè¡¨ä¸­ï¼Œé€šè¿‡entity_idå…³è”åˆ°ç°æœ‰å®ä½“è¡¨
// ç»§æ‰¿ ExtensibleFullAuditedEntity ä»¥ä½¿ç”¨ABPçš„å®¡è®¡å­—æ®µå’Œæ‰©å±•å­—æ®µ
// æ–‡ä»¶ä½ç½®ï¼šKnowledgeGraphRelationship.cs
public class KnowledgeGraphRelationship : ExtensibleFullAuditedEntity<Guid>
{
    public Guid SourceEntityId { get; set; } // æºå®ä½“IDï¼ˆå…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼‰
    public string SourceEntityType { get; set; } // æºå®ä½“ç±»å‹ï¼ˆCatalogue, Person, Department, BusinessEntity, Workflowï¼‰
    public Guid TargetEntityId { get; set; } // ç›®æ ‡å®ä½“IDï¼ˆå…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼‰
    public string TargetEntityType { get; set; } // ç›®æ ‡å®ä½“ç±»å‹
    public RelationshipType Type { get; set; }
    public string? Description { get; set; }

    // å…³ç³»è¯­ä¹‰å±æ€§ï¼ˆç”¨äºæŠ½è±¡å…³ç³»ç±»å‹çš„å…·ä½“è¯­ä¹‰æè¿°ï¼‰
    public string? Role { get; set; } // è§’è‰²ï¼ˆç”¨äº PersonRelatesToCatalogueã€PersonRelatesToWorkflow ç­‰ï¼‰
    public string? SemanticType { get; set; } // è¯­ä¹‰ç±»å‹ï¼ˆç”¨äº CatalogueRelatesToCatalogueã€WorkflowRelatesToWorkflow ç­‰ï¼‰

    public double Weight { get; set; } = 1.0; // å…³ç³»æƒé‡ï¼ˆç”¨äºå½±å“åˆ†æï¼‰

    // æ³¨æ„ï¼š
    // - Id, CreationTime, LastModificationTime ç­‰å®¡è®¡å­—æ®µç”± ExtensibleFullAuditedEntity æä¾›
    // - CreatorId, LastModifierId ç­‰åˆ›å»ºäºº/ä¿®æ”¹äººå­—æ®µç”± ExtensibleFullAuditedEntity æä¾›
    // - ExtraProperties æ‰©å±•å­—æ®µç”± ExtensibleFullAuditedEntity æä¾›ï¼Œç”¨äºå­˜å‚¨å…³ç³»æ‰©å±•å±æ€§ï¼ˆæ›¿ä»£åŸæ¥çš„ Properties å­—æ®µï¼‰

    // è¾…åŠ©æ–¹æ³•ï¼šè·å–å…³ç³»çš„æ˜¾ç¤ºåç§°
    public string GetDisplayName()
    {
        return Type switch
        {
            RelationshipType.PersonRelatesToCatalogue => Role != null
                ? $"äººå‘˜-åˆ†ç±»å…³ç³»({Role})"
                : "äººå‘˜-åˆ†ç±»å…³ç³»",
            RelationshipType.CatalogueRelatesToCatalogue => SemanticType != null
                ? $"åˆ†ç±»-åˆ†ç±»å…³ç³»({SemanticType})"
                : "åˆ†ç±»-åˆ†ç±»å…³ç³»",
            RelationshipType.PersonRelatesToWorkflow => Role != null
                ? $"äººå‘˜-å·¥ä½œæµå…³ç³»({Role})"
                : "äººå‘˜-å·¥ä½œæµå…³ç³»",
            RelationshipType.WorkflowRelatesToWorkflow => SemanticType != null
                ? $"å·¥ä½œæµ-å·¥ä½œæµå…³ç³»({SemanticType})"
                : "å·¥ä½œæµ-å·¥ä½œæµå…³ç³»",
            _ => Type.ToString()
        };
    }
}

// å…³ç³»ç±»å‹æšä¸¾ï¼ˆä¼˜åŒ–å - é‡‡ç”¨æŠ½è±¡ã€å¯æ‰©å±•çš„è®¾è®¡ï¼‰
public enum RelationshipType
{
    // ========== åˆ†ç±»ä¸åˆ†ç±»çš„å…³ç³»ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰ ==========
    // æ ¸å¿ƒå…³ç³»ï¼šé€šè¿‡ semanticType å±æ€§æè¿°å…³ç³»çš„å…·ä½“è¯­ä¹‰ï¼ˆæ—¶é—´ã€ä¸šåŠ¡ã€ç‰ˆæœ¬ç­‰ï¼‰
    CatalogueRelatesToCatalogue,     // åˆ†ç±»å…³è”åˆ†ç±»ï¼ˆé€šç”¨å…³ç³»ï¼Œé€šè¿‡ semanticType åŒºåˆ†ï¼šæ—¶é—´ã€ä¸šåŠ¡ã€ç‰ˆæœ¬ã€ä¾èµ–ç­‰ï¼‰
    CatalogueHasChild,                // åˆ†ç±»æœ‰å­åˆ†ç±»ï¼ˆæ ‘å½¢ç»“æ„ï¼Œè¯­ä¹‰æ˜ç¡®ï¼Œä¿ç•™ç‹¬ç«‹ç±»å‹ï¼‰
    CatalogueReferencesBusiness,     // åˆ†ç±»å¼•ç”¨ä¸šåŠ¡å®ä½“

    // ========== äººå‘˜ä¸åˆ†ç±»çš„å…³ç³»ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰ ==========
    // æ ¸å¿ƒå…³ç³»ï¼šé€šè¿‡ role å±æ€§æè¿°äººå‘˜çš„å…·ä½“è§’è‰²ï¼ˆé¡¹ç›®ç»ç†ã€å®¡æ ¸äººã€ä¸“å®¶ç­‰ï¼‰
    PersonRelatesToCatalogue,        // äººå‘˜å…³è”åˆ†ç±»ï¼ˆé€šç”¨å…³ç³»ï¼Œé€šè¿‡ role å±æ€§åŒºåˆ†ï¼šåˆ›å»ºã€ç®¡ç†ã€é¡¹ç›®ç»ç†ã€å®¡æ ¸ã€ä¸“å®¶ã€è´£ä»»äººã€è”ç³»äººã€å‚ä¸ç­‰ï¼‰
    PersonBelongsToDepartment,       // äººå‘˜å±äºéƒ¨é—¨

    // ========== éƒ¨é—¨ç›¸å…³ ==========
    DepartmentOwnsCatalogue,         // éƒ¨é—¨æ‹¥æœ‰åˆ†ç±»
    DepartmentManagesCatalogue,      // éƒ¨é—¨ç®¡ç†åˆ†ç±»
    DepartmentHasParent,             // éƒ¨é—¨å±‚çº§å…³ç³»

    // ========== ä¸šåŠ¡å®ä½“ç›¸å…³ ==========
    BusinessEntityHasCatalogue,      // ä¸šåŠ¡å®ä½“æœ‰åˆ†ç±»
    BusinessEntityManagesCatalogue,  // ä¸šåŠ¡å®ä½“ç®¡ç†åˆ†ç±»

    // ========== å·¥ä½œæµç›¸å…³ ==========
    CatalogueUsesWorkflow,           // åˆ†ç±»ä½¿ç”¨å·¥ä½œæµï¼ˆåˆ†ç±»å…³è”å·¥ä½œæµæ¨¡æ¿ï¼‰
    WorkflowManagesCatalogue,        // å·¥ä½œæµç®¡ç†åˆ†ç±»ï¼ˆå·¥ä½œæµå®ä¾‹ç®¡ç†åˆ†ç±»çš„ç”Ÿå‘½å‘¨æœŸï¼‰
    WorkflowInstanceBelongsToCatalogue, // å·¥ä½œæµå®ä¾‹å±äºåˆ†ç±»ï¼ˆå…·ä½“çš„å·¥ä½œæµæ‰§è¡Œå®ä¾‹ï¼‰
    PersonRelatesToWorkflow,         // äººå‘˜å…³è”å·¥ä½œæµï¼ˆé€šç”¨å…³ç³»ï¼Œé€šè¿‡ role å±æ€§åŒºåˆ†ï¼šç®¡ç†ã€æ‰§è¡Œç­‰ï¼‰
    DepartmentOwnsWorkflow,          // éƒ¨é—¨æ‹¥æœ‰å·¥ä½œæµ
    WorkflowRelatesToWorkflow        // å·¥ä½œæµå…³è”å·¥ä½œæµï¼ˆé€šç”¨å…³ç³»ï¼Œé€šè¿‡ semanticType åŒºåˆ†ï¼šç‰ˆæœ¬ã€æ›¿æ¢ç­‰ï¼‰
}

// äººå‘˜è§’è‰²æšä¸¾ï¼ˆç”¨äº PersonRelatesToCatalogue å…³ç³»çš„ role å±æ€§ï¼‰
public enum PersonRole
{
    Creator,              // åˆ›å»ºè€…
    Manager,              // ç®¡ç†è€…
    ProjectManager,       // é¡¹ç›®ç»ç†
    Reviewer,             // å®¡æ ¸äºº
    Expert,               // ä¸“å®¶
    Responsible,          // è´£ä»»äºº
    Contact,              // è”ç³»äºº
    Participant           // å‚ä¸è€…
}

// åˆ†ç±»å…³ç³»è¯­ä¹‰ç±»å‹æšä¸¾ï¼ˆç”¨äº CatalogueRelatesToCatalogue å…³ç³»çš„ semanticType å±æ€§ï¼‰
public enum CatalogueSemanticType
{
    Temporal,             // æ—¶é—´å…³ç³»ï¼ˆé¡¹ç›®é˜¶æ®µä¸åŒæ—¶æœŸçš„æ¡£æ¡ˆï¼‰
    Business,             // ä¸šåŠ¡å…³ç³»ï¼ˆæŒ‰ä¸šåŠ¡åˆ’åˆ†çš„åˆ†ç±»å…³ç³»ï¼‰
    Version,              // ç‰ˆæœ¬å…³ç³»
    Replaces,             // æ›¿æ¢å…³ç³»ï¼ˆç‰ˆæœ¬æ¼”è¿›ï¼‰
    DependsOn,            // ä¾èµ–å…³ç³»
    References,           // å¼•ç”¨å…³ç³»
    SimilarTo             // ç›¸ä¼¼å…³ç³»
}
````

### 3.2 å›¾æ•°æ®åº“ Schema è®¾è®¡

> **é‡è¦è¯´æ˜**ï¼šæœ¬é¡¹ç›®ä½¿ç”¨ **Apache AGE**ï¼ˆPostgreSQL å›¾æ•°æ®åº“æ‰©å±•ï¼‰è€Œé Neo4jã€‚
>
> -   âœ… **ç»Ÿä¸€å­˜å‚¨**ï¼šå›¾æ•°æ®å­˜å‚¨åœ¨ PostgreSQL æ•°æ®åº“ä¸­ï¼Œä¸ä¸šåŠ¡æ•°æ®ç»Ÿä¸€ç®¡ç†
> -   âœ… **Cypher å…¼å®¹**ï¼šæ”¯æŒ Cypher æŸ¥è¯¢è¯­è¨€ï¼Œè¯­æ³•ä¸ Neo4j é«˜åº¦å…¼å®¹
> -   âœ… **äº‹åŠ¡ä¸€è‡´æ€§**ï¼šåŸç”Ÿæ”¯æŒ ACID äº‹åŠ¡ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
> -   ğŸ“– è¯¦ç»†è¯´æ˜è¯·å‚è€ƒï¼š[PostgreSQL å›¾æ•°æ®åº“æ‰©å±•æŠ€æœ¯åˆ†ææŠ¥å‘Š](./PostgreSQL-Graph-Extension-Analysis.md)

#### 3.2.1 Apache AGE å›¾æ•°æ®åº“åˆå§‹åŒ–

> **ğŸ“ å®Œæ•´åˆå§‹åŒ–è„šæœ¬**ï¼šå·²åˆ›å»ºå®Œæ•´çš„å›¾æ•°æ®åº“åˆå§‹åŒ–ä¸ä¼˜åŒ–è„šæœ¬ï¼ŒåŒ…å«ï¼š
>
> -   âœ… Apache AGE æ‰©å±•å®‰è£…å’Œé…ç½®
> -   âœ… å›¾æ•°æ®åº“åˆ›å»º
> -   âœ… æ•°æ®åŒæ­¥å‡½æ•°ï¼ˆä»ä¸šåŠ¡è¡¨åŒæ­¥åˆ°å›¾æ•°æ®åº“ï¼‰
> -   âœ… æ€§èƒ½ä¼˜åŒ–ç´¢å¼•å’Œé…ç½®
> -   âœ… æ•°æ®éªŒè¯å’Œç›‘æ§æŸ¥è¯¢
> -   âœ… è‡ªåŠ¨åŒæ­¥è§¦å‘å™¨ï¼ˆå¯é€‰ï¼‰
>
> ğŸ“– è„šæœ¬ä½ç½®ï¼š`docs/scripts/init-apache-age-graph.sql`
>
> **ä½¿ç”¨æ–¹æ³•**ï¼š
>
> ```bash
> # åœ¨ PostgreSQL ä¸­æ‰§è¡Œè„šæœ¬
> psql -U postgres -d your_database -f docs/scripts/init-apache-age-graph.sql
> ```

**å¿«é€Ÿåˆå§‹åŒ–ç¤ºä¾‹**ï¼š

````sql
-- =====================================================
-- 1. å®‰è£…å’Œå¯ç”¨ Apache AGE æ‰©å±•
-- =====================================================
CREATE EXTENSION IF NOT EXISTS age;
LOAD 'age';

-- =====================================================
-- 2. åˆ›å»ºå›¾æ•°æ®åº“ï¼ˆåœ¨ PostgreSQL ä¸­åˆ›å»ºå›¾å‘½åç©ºé—´ï¼‰
-- =====================================================
SELECT create_graph('kg_graph');

-- =====================================================
-- 3. èŠ‚ç‚¹æ ‡ç­¾å®šä¹‰ï¼ˆApache AGE ä½¿ç”¨æ ‡ç­¾ç³»ç»Ÿï¼‰
-- =====================================================
-- èŠ‚ç‚¹æ ‡ç­¾ï¼ˆä¼˜åŒ–åï¼‰
-- (:Catalogue)
-- (:Person)
-- (:Department)
-- (:BusinessEntity)
-- (:Workflow)

-- =====================================================
-- 4. PostgreSQL ç´¢å¼•ï¼ˆç”¨äºæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
-- =====================================================
-- æ³¨æ„ï¼šApache AGE ä½¿ç”¨ PostgreSQL çš„ç´¢å¼•æœºåˆ¶
-- åœ¨ä¸šåŠ¡è¡¨ä¸Šåˆ›å»ºç´¢å¼•ï¼ŒAGE æŸ¥è¯¢ä¼šè‡ªåŠ¨åˆ©ç”¨è¿™äº›ç´¢å¼•

CREATE INDEX IF NOT EXISTS idx_catalogue_id ON "APPATTACH_CATALOGUES"("Id");
CREATE INDEX IF NOT EXISTS idx_catalogue_name ON "APPATTACH_CATALOGUES"("CATALOGUE_NAME");
CREATE INDEX IF NOT EXISTS idx_catalogue_status ON "APPATTACH_CATALOGUES"("STATUS");
CREATE INDEX IF NOT EXISTS idx_relationship_source ON "APPKG_RELATIONSHIPS"("SOURCE_ENTITY_ID", "SOURCE_ENTITY_TYPE");
CREATE INDEX IF NOT EXISTS idx_relationship_target ON "APPKG_RELATIONSHIPS"("TARGET_ENTITY_ID", "TARGET_ENTITY_TYPE");
CREATE INDEX IF NOT EXISTS idx_relationship_type ON "APPKG_RELATIONSHIPS"("RELATIONSHIP_TYPE");

-- =====================================================
-- 5. å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆPostgreSQL å†…ç½®ï¼‰
-- =====================================================
CREATE INDEX IF NOT EXISTS idx_catalogue_name_fts
ON "APPATTACH_CATALOGUES"
USING gin(to_tsvector('chinese_fts', "CATALOGUE_NAME"));

#### 3.2.2 Apache AGE å…³ç³»ç±»å‹å®šä¹‰ï¼ˆCypher è¯­æ³•ï¼‰

```cypher
-- =====================================================
-- å…³ç³»ç±»å‹ï¼ˆä¼˜åŒ–å - é‡‡ç”¨æŠ½è±¡ã€å¯æ‰©å±•çš„è®¾è®¡ï¼‰
-- æ³¨æ„ï¼šä»¥ä¸‹ä¸º Cypher è¯­æ³•ç¤ºä¾‹ï¼Œå®é™…æŸ¥è¯¢ä½¿ç”¨ AGE çš„ cypher() å‡½æ•°
-- =====================================================

-- åˆ†ç±»ä¹‹é—´çš„å…³ç³»ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰
(:Catalogue)-[:RELATES_TO {semanticType: 'Temporal'}]->(:Catalogue)      -- æ—¶é—´å…³ç³»
(:Catalogue)-[:RELATES_TO {semanticType: 'Business'}]->(:Catalogue)       -- ä¸šåŠ¡å…³ç³»
(:Catalogue)-[:RELATES_TO {semanticType: 'Version'}]->(:Catalogue)        -- ç‰ˆæœ¬å…³ç³»
(:Catalogue)-[:RELATES_TO {semanticType: 'Replaces'}]->(:Catalogue)       -- æ›¿æ¢å…³ç³»
(:Catalogue)-[:RELATES_TO {semanticType: 'DependsOn'}]->(:Catalogue)      -- ä¾èµ–å…³ç³»
(:Catalogue)-[:RELATES_TO {semanticType: 'References'}]->(:Catalogue)     -- å¼•ç”¨å…³ç³»
(:Catalogue)-[:RELATES_TO {semanticType: 'SimilarTo'}]->(:Catalogue)      -- ç›¸ä¼¼å…³ç³»
(:Catalogue)-[:HAS_CHILD]->(:Catalogue)                                   -- æ ‘å½¢ç»“æ„ï¼ˆè¯­ä¹‰æ˜ç¡®ï¼Œä¿ç•™ç‹¬ç«‹ç±»å‹ï¼‰

-- åˆ†ç±»ä¸äººå‘˜çš„å…³ç³»ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰
(:Person)-[:RELATES_TO {role: 'Creator'}]->(:Catalogue)                   -- åˆ›å»ºè€…
(:Person)-[:RELATES_TO {role: 'Manager'}]->(:Catalogue)                  -- ç®¡ç†è€…
(:Person)-[:RELATES_TO {role: 'ProjectManager'}]->(:Catalogue)           -- é¡¹ç›®ç»ç†
(:Person)-[:RELATES_TO {role: 'Reviewer'}]->(:Catalogue)                 -- å®¡æ ¸äºº
(:Person)-[:RELATES_TO {role: 'Expert'}]->(:Catalogue)                   -- ä¸“å®¶
(:Person)-[:RELATES_TO {role: 'Responsible'}]->(:Catalogue)               -- è´£ä»»äºº
(:Person)-[:RELATES_TO {role: 'Contact'}]->(:Catalogue)                  -- è”ç³»äºº
(:Person)-[:RELATES_TO {role: 'Participant'}]->(:Catalogue)               -- å‚ä¸è€…

-- åˆ†ç±»ä¸éƒ¨é—¨çš„å…³ç³»
(:Department)-[:OWNS]->(:Catalogue)
(:Department)-[:MANAGES]->(:Catalogue)

-- åˆ†ç±»ä¸ä¸šåŠ¡å®ä½“çš„å…³ç³»
(:BusinessEntity)-[:HAS]->(:Catalogue)
(:BusinessEntity)-[:MANAGES]->(:Catalogue)
(:Catalogue)-[:REFERENCES]->(:BusinessEntity)

-- äººå‘˜ä¸éƒ¨é—¨çš„å…³ç³»
(:Person)-[:BELONGS_TO]->(:Department)

-- éƒ¨é—¨å±‚çº§å…³ç³»
(:Department)-[:HAS_PARENT]->(:Department)

-- åˆ†ç±»ä¸å·¥ä½œæµçš„å…³ç³»
(:Catalogue)-[:USES]->(:Workflow)
(:Workflow)-[:MANAGES]->(:Catalogue)
(:Workflow)-[:INSTANCE_OF]->(:Catalogue)

-- äººå‘˜ä¸å·¥ä½œæµçš„å…³ç³»ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰
(:Person)-[:RELATES_TO {role: 'Manager'}]->(:Workflow)                    -- å·¥ä½œæµç®¡ç†å‘˜
(:Person)-[:RELATES_TO {role: 'Executor'}]->(:Workflow)                  -- å·¥ä½œæµæ‰§è¡Œäºº

-- éƒ¨é—¨ä¸å·¥ä½œæµçš„å…³ç³»
(:Department)-[:OWNS]->(:Workflow)

-- å·¥ä½œæµç‰ˆæœ¬å…³ç³»ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰
(:Workflow)-[:RELATES_TO {semanticType: 'Version'}]->(:Workflow)          -- ç‰ˆæœ¬å…³ç³»
(:Workflow)-[:RELATES_TO {semanticType: 'Replaces'}]->(:Workflow)         -- æ›¿æ¢å…³ç³»
````

#### 3.2.3 Apache AGE æŸ¥è¯¢ç¤ºä¾‹

```sql
-- =====================================================
-- Apache AGE Cypher æŸ¥è¯¢ç¤ºä¾‹
-- =====================================================

-- 1. åˆ›å»ºèŠ‚ç‚¹
SELECT * FROM cypher('kg_graph', $$
  CREATE (c:Catalogue {
    id: 'catalog-001',
    name: 'é¡¹ç›®æ¡£æ¡ˆ',
    type: 'Catalogue',
    status: 'ACTIVE'
  })
  RETURN c
$$) AS (c agtype);

-- 2. åˆ›å»ºå…³ç³»
SELECT * FROM cypher('kg_graph', $$
  MATCH (source:Catalogue {id: $sourceId})
  MATCH (target:Catalogue {id: $targetId})
  CREATE (source)-[r:RELATES_TO {
    type: 'RELATES_TO',
    semanticType: $semanticType,
    weight: 1.0
  }]->(target)
  RETURN r
$$, '{"sourceId": "catalog-001", "targetId": "catalog-002", "semanticType": "Temporal"}') AS (r agtype);

-- 3. æŸ¥è¯¢èŠ‚ç‚¹åŠå…¶å…³ç³»
SELECT * FROM cypher('kg_graph', $$
  MATCH (c:Catalogue {id: $catalogId})-[r]->(related)
  RETURN c, r, related
  LIMIT 100
$$, '{"catalogId": "catalog-001"}') AS (c agtype, r agtype, related agtype);

-- 4. è·¯å¾„æŸ¥è¯¢
SELECT * FROM cypher('kg_graph', $$
  MATCH path = (start:Catalogue {id: $startId})-[*1..5]-(end:Catalogue {id: $endId})
  RETURN path
  LIMIT 10
$$, '{"startId": "catalog-001", "endId": "catalog-010"}') AS (path agtype);

-- 5. ç»Ÿè®¡æŸ¥è¯¢
SELECT * FROM cypher('kg_graph', $$
  MATCH (n)
  RETURN labels(n) AS label, count(n) AS count
  ORDER BY count DESC
$$) AS (label agtype, count agtype);
```

#### 3.2.2 å…³ç³»æ•°æ®åº“è¡¨è®¾è®¡

> **é‡è¦è¯´æ˜**ï¼šçŸ¥è¯†å›¾è°±çš„å…³ç³»å‹æ•°æ®åº“è®¾è®¡é‡‡ç”¨**å¼•ç”¨æ¨¡å¼**ï¼Œä¸é‡å¤å­˜å‚¨å·²æœ‰å®ä½“æ•°æ®ã€‚
>
> -   **å·²æœ‰å®ä½“è¡¨**ï¼š`APPATTACH_CATALOGUES`ï¼ˆåˆ†ç±»ï¼‰
> -   **çŸ¥è¯†å›¾è°±è¡¨**ï¼šåªå­˜å‚¨å›¾è°±ç‰¹æœ‰çš„æ•°æ®ï¼ˆå…³ç³»ã€å›¾æŸ¥è¯¢ä¼˜åŒ–ã€æ—¶é—´è½´å¿«ç…§ç­‰ï¼‰
> -   **å…³è”æ–¹å¼**ï¼šé€šè¿‡å¤–é”®å…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼Œé¿å…æ•°æ®å†—ä½™
> -   **ç»´åº¦è¯´æ˜**ï¼šæ–‡ä»¶é€šè¿‡åˆ†ç±»ç›´æ¥è®¿é—®ï¼Œæ¨¡æ¿å’Œåˆ†é¢ä¿¡æ¯å·²ä½“ç°åœ¨åˆ†ç±»ä¸­ï¼Œæ— éœ€å•ç‹¬ç»´åº¦

```sql
-- =====================================================
-- çŸ¥è¯†å›¾è°±å…³ç³»è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰
-- å­˜å‚¨å®ä½“é—´çš„å…³ç³»ï¼Œä¸å­˜å‚¨å®ä½“æœ¬èº«çš„æ•°æ®
-- æ³¨æ„ï¼šä½¿ç”¨ABPçš„å®¡è®¡å­—æ®µï¼ˆCreationTime, LastModificationTime, CreatorId, LastModifierIdç­‰ï¼‰
-- æ‰©å±•å±æ€§å­˜å‚¨åœ¨ ExtraProperties JSONB å­—æ®µä¸­ï¼ˆç”± ExtensibleFullAuditedEntity æä¾›ï¼‰
-- =====================================================
CREATE TABLE "APPKG_RELATIONSHIPS" (
    "Id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    "SOURCE_ENTITY_ID" UUID NOT NULL, -- æºå®ä½“IDï¼ˆå…³è”åˆ°APPATTACH_CATALOGUESç­‰ï¼‰
    "SOURCE_ENTITY_TYPE" VARCHAR(50) NOT NULL, -- æºå®ä½“ç±»å‹ï¼ˆCatalogue, Person, Department, BusinessEntity, Workflowï¼‰
    "TARGET_ENTITY_ID" UUID NOT NULL, -- ç›®æ ‡å®ä½“ID
    "TARGET_ENTITY_TYPE" VARCHAR(50) NOT NULL, -- ç›®æ ‡å®ä½“ç±»å‹
    "RELATIONSHIP_TYPE" VARCHAR(50) NOT NULL, -- å…³ç³»ç±»å‹ï¼ˆRELATES_TO, HAS_CHILDç­‰ï¼‰
    "ROLE" VARCHAR(50), -- è§’è‰²ï¼ˆç”¨äº PersonRelatesToCatalogueã€PersonRelatesToWorkflow ç­‰ï¼‰
    "SEMANTIC_TYPE" VARCHAR(50), -- è¯­ä¹‰ç±»å‹ï¼ˆç”¨äº CatalogueRelatesToCatalogueã€WorkflowRelatesToWorkflow ç­‰ï¼‰
    "DESCRIPTION" TEXT,
    "WEIGHT" DOUBLE PRECISION DEFAULT 1.0, -- å…³ç³»æƒé‡ï¼ˆç”¨äºå½±å“åˆ†æï¼‰

    -- ABPå®¡è®¡å­—æ®µï¼ˆç”± ExtensibleFullAuditedEntity æä¾›ï¼‰
    "CreationTime" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "CreatorId" UUID,
    "LastModificationTime" TIMESTAMP,
    "LastModifierId" UUID,
    "IsDeleted" BOOLEAN NOT NULL DEFAULT FALSE,
    "DeletionTime" TIMESTAMP,
    "DeleterId" UUID,

    -- ABPæ‰©å±•å­—æ®µï¼ˆç”± ExtensibleFullAuditedEntity æä¾›ï¼‰
    "ExtraProperties" JSONB, -- å…³ç³»æ‰©å±•å±æ€§ï¼ˆæ›¿ä»£åŸæ¥çš„ properties å­—æ®µï¼‰
    "ConcurrencyStamp" VARCHAR(40), -- å¹¶å‘æ§åˆ¶æ ‡è®°ï¼ˆç”± ExtensibleFullAuditedEntity æä¾›ï¼‰

    CONSTRAINT "UK_KG_RELATIONSHIPS_SOURCE_TARGET_TYPE_ROLE_SEMANTIC"
        UNIQUE ("SOURCE_ENTITY_ID", "TARGET_ENTITY_ID", "RELATIONSHIP_TYPE", COALESCE("ROLE", ''), COALESCE("SEMANTIC_TYPE", ''))
);

CREATE INDEX "IDX_KG_RELATIONSHIPS_SOURCE" ON "APPKG_RELATIONSHIPS"("SOURCE_ENTITY_ID", "SOURCE_ENTITY_TYPE");
CREATE INDEX "IDX_KG_RELATIONSHIPS_TARGET" ON "APPKG_RELATIONSHIPS"("TARGET_ENTITY_ID", "TARGET_ENTITY_TYPE");
CREATE INDEX "IDX_KG_RELATIONSHIPS_TYPE" ON "APPKG_RELATIONSHIPS"("RELATIONSHIP_TYPE");
CREATE INDEX "IDX_KG_RELATIONSHIPS_SOURCE_TYPE" ON "APPKG_RELATIONSHIPS"("SOURCE_ENTITY_TYPE", "RELATIONSHIP_TYPE");
CREATE INDEX "IDX_KG_RELATIONSHIPS_ROLE" ON "APPKG_RELATIONSHIPS"("ROLE") WHERE "ROLE" IS NOT NULL;
CREATE INDEX "IDX_KG_RELATIONSHIPS_SEMANTIC_TYPE" ON "APPKG_RELATIONSHIPS"("SEMANTIC_TYPE") WHERE "SEMANTIC_TYPE" IS NOT NULL;
CREATE INDEX "IDX_KG_RELATIONSHIPS_TYPE_ROLE" ON "APPKG_RELATIONSHIPS"("RELATIONSHIP_TYPE", "ROLE") WHERE "ROLE" IS NOT NULL;
CREATE INDEX "IDX_KG_RELATIONSHIPS_TYPE_SEMANTIC" ON "APPKG_RELATIONSHIPS"("RELATIONSHIP_TYPE", "SEMANTIC_TYPE") WHERE "SEMANTIC_TYPE" IS NOT NULL;

-- =====================================================
-- å®ä½“å›¾æŸ¥è¯¢ä¼˜åŒ–è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
-- å­˜å‚¨å®ä½“çš„å›¾æŸ¥è¯¢ç›¸å…³å…ƒæ•°æ®ï¼Œä¸å­˜å‚¨å®ä½“ä¸šåŠ¡æ•°æ®
-- =====================================================
CREATE TABLE kg_entity_graph_metadata (
    entity_id UUID NOT NULL PRIMARY KEY, -- å®ä½“IDï¼ˆå…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼‰
    entity_type VARCHAR(50) NOT NULL, -- å®ä½“ç±»å‹
    graph_properties JSONB, -- å›¾æŸ¥è¯¢ç›¸å…³å±æ€§ï¼ˆå¦‚é‡è¦æ€§è¯„åˆ†ã€ä¸­å¿ƒåº¦ç­‰ï¼‰
    last_graph_update TIMESTAMP, -- æœ€åå›¾æ•°æ®æ›´æ–°æ—¶é—´
    CONSTRAINT uk_entity_graph_metadata UNIQUE (entity_id, entity_type)
);

CREATE INDEX idx_entity_graph_metadata_type ON kg_entity_graph_metadata(entity_type);
CREATE INDEX idx_entity_graph_metadata_update ON kg_entity_graph_metadata(last_graph_update DESC);

-- =====================================================
-- æ—¶é—´è½´å¿«ç…§è¡¨
-- å­˜å‚¨ä¸šåŠ¡é˜¶æ®µçš„æ—¶é—´è½´å¿«ç…§æ•°æ®
-- =====================================================
CREATE TABLE kg_timeline_snapshots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    business_stage VARCHAR(100) NOT NULL, -- ä¸šåŠ¡é˜¶æ®µï¼ˆé¡¹ç›®å¯åŠ¨ã€æµç¨‹è®¾è®¡ç­‰ï¼‰
    stage_time TIMESTAMP NOT NULL, -- é˜¶æ®µæ—¶é—´
    entity_counts JSONB NOT NULL, -- å®ä½“æ•°é‡ç»Ÿè®¡ {Catalogue: 50, Person: 20, Department: 5, BusinessEntity: 10}
    relationship_counts JSONB NOT NULL, -- å…³ç³»æ•°é‡ç»Ÿè®¡ {CONTAINS: 120, HAS_CHILD: 45, ...}
    business_status VARCHAR(50), -- ä¸šåŠ¡çŠ¶æ€
    snapshot_data JSONB, -- å®Œæ•´å¿«ç…§æ•°æ®ï¼ˆå¯é€‰ï¼Œç”¨äºè¯¦ç»†åˆ†æï¼‰
    created_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_timeline_stage_time ON kg_timeline_snapshots(stage_time DESC);
CREATE INDEX idx_timeline_stage ON kg_timeline_snapshots(business_stage);

-- =====================================================
-- é£é™©é¢„è­¦è¡¨
-- å­˜å‚¨çŸ¥è¯†å›¾è°±ç›¸å…³çš„é£é™©é¢„è­¦ä¿¡æ¯
-- =====================================================
CREATE TABLE kg_risk_alerts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_id UUID NOT NULL, -- å®ä½“IDï¼ˆå…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼‰
    entity_type VARCHAR(50) NOT NULL, -- å®ä½“ç±»å‹
    risk_level VARCHAR(20) NOT NULL, -- HIGH, MEDIUM, LOW
    risk_type VARCHAR(50) NOT NULL, -- é£é™©ç±»å‹
    risk_category VARCHAR(50) NOT NULL, -- é£é™©åˆ†ç±»ï¼ˆæ•°æ®å®Œæ•´æ€§ã€å®‰å…¨æ€§ã€åˆè§„æ€§ç­‰ï¼‰
    risk_description TEXT NOT NULL, -- é£é™©æè¿°
    affected_entity_count INT, -- å—å½±å“å®ä½“æ•°é‡
    business_impact JSONB, -- ä¸šåŠ¡å½±å“ï¼ˆåŒ…å«æ•°æ®å®Œæ•´æ€§é£é™©ã€åˆè§„æ€§é£é™©ã€æ“ä½œå½±å“ç­‰ï¼‰
    mitigation_suggestion TEXT, -- åº”å¯¹å»ºè®®
    responsible_person_id UUID, -- è´£ä»»äººIDï¼ˆå…³è”åˆ°ç”¨æˆ·è¡¨ï¼‰
    status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE, ACKNOWLEDGED, RESOLVED
    due_date TIMESTAMP, -- å¤„ç†æˆªæ­¢æ—¥æœŸ
    created_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    acknowledged_time TIMESTAMP,
    resolved_time TIMESTAMP
);

-- =====================================================
-- çŸ¥è¯†å›¾è°±å®¡è®¡è½¨è¿¹è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºè®°å½•å›¾è°±ç›¸å…³å˜æ›´ï¼‰
-- æ³¨æ„ï¼šå®ä½“çš„ä¸šåŠ¡å˜æ›´å®¡è®¡ç”±ABPæ¡†æ¶çš„å®¡è®¡æ—¥å¿—å¤„ç†
-- æ­¤è¡¨ä»…è®°å½•çŸ¥è¯†å›¾è°±ç‰¹æœ‰çš„æ“ä½œï¼ˆå¦‚å…³ç³»åˆ›å»ºã€å›¾æ•°æ®æ›´æ–°ç­‰ï¼‰
-- =====================================================
CREATE TABLE kg_graph_audit_trail (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    entity_id UUID NOT NULL, -- å®ä½“IDï¼ˆå…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼‰
    entity_type VARCHAR(50) NOT NULL, -- å®ä½“ç±»å‹
    action_type VARCHAR(50) NOT NULL, -- æ“ä½œç±»å‹ï¼ˆRELATIONSHIP_CREATE, GRAPH_UPDATEç­‰ï¼‰
    action_description TEXT NOT NULL, -- æ“ä½œæè¿°
    old_values JSONB, -- å˜æ›´å‰çš„å€¼ï¼ˆå›¾è°±ç›¸å…³ï¼‰
    new_values JSONB, -- å˜æ›´åçš„å€¼ï¼ˆå›¾è°±ç›¸å…³ï¼‰
    performed_by VARCHAR(100) NOT NULL, -- æ“ä½œäººID
    performed_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ip_address INET,
    user_agent TEXT
);

CREATE INDEX idx_graph_audit_entity ON kg_graph_audit_trail(entity_id, entity_type, performed_at DESC);
CREATE INDEX idx_graph_audit_action ON kg_graph_audit_trail(action_type, performed_at DESC);

CREATE INDEX idx_risk_alerts_level ON kg_risk_alerts(risk_level, status);
CREATE INDEX idx_risk_alerts_entity ON kg_risk_alerts(entity_id, entity_type);
CREATE INDEX idx_risk_alerts_status ON kg_risk_alerts(status) WHERE status = 'ACTIVE';
CREATE INDEX idx_risk_alerts_category ON kg_risk_alerts(risk_category);
CREATE INDEX idx_risk_alerts_due_date ON kg_risk_alerts(due_date) WHERE status = 'ACTIVE';

-- =====================================================
-- è§†å›¾ï¼šå®ä½“å…³ç³»è§†å›¾ï¼ˆç”¨äºæ–¹ä¾¿æŸ¥è¯¢ï¼‰
-- æ³¨æ„ï¼šç”±äºPostgreSQLä¸æ”¯æŒåŠ¨æ€è¡¨åï¼Œå»ºè®®åœ¨åº”ç”¨å±‚é€šè¿‡JOINæŸ¥è¯¢
-- æˆ–åˆ›å»ºå¤šä¸ªç±»å‹ç‰¹å®šçš„è§†å›¾
-- =====================================================
-- åˆ†ç±»å…³ç³»è§†å›¾
CREATE OR REPLACE VIEW v_kg_catalogue_relationships AS
SELECT
    r.id AS relationship_id,
    r.source_entity_id,
    r.source_entity_type,
    r.target_entity_id,
    r.target_entity_type,
    r.relationship_type,
    r.weight,
    r.properties AS relationship_properties,
    r.created_time AS relationship_created_time,
    c1."CATALOGUE_NAME" AS source_catalogue_name,
    c2."CATALOGUE_NAME" AS target_catalogue_name
FROM kg_relationships r
LEFT JOIN "APPATTACH_CATALOGUES" c1 ON r.source_entity_type = 'Catalogue' AND c1."ID" = r.source_entity_id
LEFT JOIN "APPATTACH_CATALOGUES" c2 ON r.target_entity_type = 'Catalogue' AND c2."ID" = r.target_entity_id
WHERE r.source_entity_type = 'Catalogue' OR r.target_entity_type = 'Catalogue';

-- æ³¨æ„ï¼šFile ä¸å†æ˜¯çŸ¥è¯†å›¾è°±çš„ç‹¬ç«‹ç»´åº¦ï¼Œæ–‡ä»¶é€šè¿‡åˆ†ç±»ç›´æ¥è®¿é—®
-- å› æ­¤ä¸éœ€è¦å•ç‹¬çš„ v_kg_file_relationships è§†å›¾
```

---

## 4. API æ¥å£è®¾è®¡

### 4.1 å›¾è°±æŸ¥è¯¢æ¥å£

#### 4.1.1 è·å–å›¾è°±æ•°æ®

```http
GET /api/knowledge-graph/graph
```

**æŸ¥è¯¢å‚æ•°**ï¼š

-   `entityTypes`ï¼šå®ä½“ç±»å‹è¿‡æ»¤ï¼ˆå¯é€‰ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰ï¼š`Catalogue`, `Person`, `Department`, `BusinessEntity`, `Workflow`
-   `relationshipTypes`ï¼šå…³ç³»ç±»å‹è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
-   `depth`ï¼šæŸ¥è¯¢æ·±åº¦ï¼ˆé»˜è®¤ 2ï¼‰
-   `centerEntityId`ï¼šä¸­å¿ƒå®ä½“ IDï¼ˆå¯é€‰ï¼Œä»¥è¯¥å®ä½“ä¸ºä¸­å¿ƒå±•å¼€ï¼Œæ”¯æŒåˆ†ç±»ã€äººå‘˜ã€éƒ¨é—¨ã€ä¸šåŠ¡å®ä½“ï¼‰
-   `maxNodes`ï¼šæœ€å¤§èŠ‚ç‚¹æ•°ï¼ˆé»˜è®¤ 500ï¼‰
-   `referenceType`ï¼šè¿‡æ»¤ç‰¹å®šä¸šåŠ¡ç±»å‹çš„åˆ†ç±»ï¼ˆå¯é€‰ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "nodes": [
        {
            "id": "guid-1",
            "type": "Project",
            "name": "é¡¹ç›®A",
            "properties": {
                "status": "è¿›è¡Œä¸­",
                "budget": 1000000
            },
            "tags": ["é‡è¦", "2024"],
            "securityLevel": "å†…éƒ¨",
            "updatedTime": "2024-11-21T10:00:00Z"
        }
    ],
    "edges": [
        {
            "id": "rel-1",
            "source": "guid-1",
            "target": "guid-2",
            "type": "MANAGES",
            "weight": 0.8,
            "properties": {}
        }
    ],
    "statistics": {
        "totalNodes": 150,
        "totalEdges": 320,
        "nodeTypes": {
            "Catalogue": 50,
            "Person": 20,
            "Department": 5,
            "BusinessEntity": 10
        }
    }
}
```

#### 4.1.2 è·å–å®ä½“è¯¦æƒ…

```http
GET /api/knowledge-graph/entities/{entityId}
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "id": "guid-1",
    "type": "Project",
    "name": "é¡¹ç›®A",
    "description": "é¡¹ç›®æè¿°",
    "securityLevel": "å†…éƒ¨",
    "businessPriority": "é«˜",
    "createdTime": "2024-01-01T00:00:00Z",
    "updatedTime": "2024-11-21T10:00:00Z",
    "properties": {
        "projectCode": "PRJ-001",
        "status": "è¿›è¡Œä¸­",
        "budget": 1000000,
        "startDate": "2024-01-01",
        "endDate": "2024-12-31"
    },
    "tags": ["é‡è¦", "2024"],
    "relationships": {
        "outgoing": [
            {
                "type": "MANAGES",
                "targetEntity": {
                    "id": "guid-2",
                    "name": "æµç¨‹B",
                    "type": "Process"
                }
            }
        ],
        "incoming": [
            {
                "type": "MANAGES",
                "sourceEntity": {
                    "id": "guid-3",
                    "name": "æŠ€æœ¯éƒ¨",
                    "type": "Department"
                }
            }
        ]
    },
    "impactAnalysis": {
        "impactRadius": 3,
        "affectedNodeCount": 15,
        "businessImpact": {
            "severity": "MEDIUM",
            "affectedBusinessProcesses": 5,
            "dataIntegrityRisk": "MEDIUM",
            "complianceRisk": "LOW"
        },
        "riskLevel": "MEDIUM",
        "mitigationSuggestions": [
            "å»ºè®®é€šçŸ¥ç›¸å…³æµç¨‹è´Ÿè´£äºº",
            "æ£€æŸ¥ä¾èµ–æ¡£æ¡ˆçš„å®Œæ•´æ€§"
        ]
    }
}
```

### 4.2 æœç´¢æ¥å£

#### 4.2.1 èŠ‚ç‚¹æœç´¢

```http
GET /api/knowledge-graph/search
```

**æŸ¥è¯¢å‚æ•°**ï¼š

-   `keyword`ï¼šæœç´¢å…³é”®è¯ï¼ˆå¿…éœ€ï¼‰
-   `entityTypes`ï¼šå®ä½“ç±»å‹è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
-   `tags`ï¼šæ ‡ç­¾è¿‡æ»¤ï¼ˆå¯é€‰ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
-   `pageIndex`ï¼šé¡µç ï¼ˆé»˜è®¤ 1ï¼‰
-   `pageSize`ï¼šæ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 20ï¼‰
-   `sortBy`ï¼šæ’åºå­—æ®µï¼ˆ`relevance`|`priority`|`updatedTime`ï¼Œé»˜è®¤`relevance`ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "totalCount": 45,
    "items": [
        {
            "id": "guid-1",
            "type": "Project",
            "name": "é¡¹ç›®A",
            "matchedFields": ["name"],
            "matchScore": 0.95,
            "businessPriority": "é«˜",
            "securityLevel": "å†…éƒ¨",
            "updatedTime": "2024-11-21T10:00:00Z",
            "highlight": {
                "name": "**é¡¹ç›®**A"
            },
            "summary": "æ ¸å¿ƒä¸šåŠ¡é¡¹ç›®ï¼Œæ¶‰åŠå¤šä¸ªæµç¨‹å’Œæ¡£æ¡ˆ"
        }
    ],
    "facets": {
        "entityTypes": {
            "Project": 10,
            "Process": 20,
            "Archive": 15
        },
        "tags": {
            "é‡è¦": 25,
            "2024": 30
        }
    }
}
```

### 4.3 æ—¶é—´è½´æ¥å£

#### 4.3.1 è·å–æ—¶é—´è½´æ•°æ®

```http
GET /api/knowledge-graph/timeline
```

**æŸ¥è¯¢å‚æ•°**ï¼š

-   `startDate`ï¼šå¼€å§‹æ—¥æœŸï¼ˆå¯é€‰ï¼‰
-   `endDate`ï¼šç»“æŸæ—¥æœŸï¼ˆå¯é€‰ï¼‰
-   `businessStages`ï¼šä¸šåŠ¡é˜¶æ®µè¿‡æ»¤ï¼ˆå¯é€‰ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰
-   `granularity`ï¼šæ—¶é—´ç²’åº¦ï¼ˆ`day`|`week`|`month`ï¼Œé»˜è®¤`day`ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "timeline": [
        {
            "stage": "é¡¹ç›®å¯åŠ¨",
            "stageTime": "2024-01-01T00:00:00Z",
            "entityCounts": {
                "Project": 1,
                "Process": 0,
                "Archive": 0,
                "Department": 1,
                "Person": 3
            },
            "relationshipCounts": {
                "MANAGES": 1,
                "HAS": 3
            },
            "businessStatus": "å¯åŠ¨ä¸­",
            "changes": {
                "newEntities": 5,
                "newRelationships": 4,
                "updatedEntities": 0
            }
        },
        {
            "stage": "æµç¨‹è®¾è®¡",
            "stageTime": "2024-01-15T00:00:00Z",
            "entityCounts": {
                "Project": 1,
                "Process": 3,
                "Archive": 0,
                "Department": 1,
                "Person": 5
            },
            "relationshipCounts": {
                "MANAGES": 1,
                "CONTAINS": 0,
                "ASSIGNED_TO": 3
            },
            "businessStatus": "è®¾è®¡ä¸­",
            "changes": {
                "newEntities": 3,
                "newRelationships": 3,
                "updatedEntities": 1
            }
        }
    ],
    "statistics": {
        "totalStages": 8,
        "totalEntities": 150,
        "totalRelationships": 320,
        "growthTrend": "ä¸Šå‡"
    }
}
```

### 4.4 å…³ç³»ç®¡ç†æ¥å£

#### 4.4.1 åˆ›å»ºå…³ç³»

```http
POST /api/knowledge-graph/relationships
```

**è¯·æ±‚ä½“**ï¼š

```json
{
    "sourceEntityId": "guid-1",
    "sourceEntityType": "Person",
    "targetEntityId": "guid-2",
    "targetEntityType": "Catalogue",
    "relationshipType": "PersonIsProjectManagerForCatalogue",
    "description": "äººå‘˜æ˜¯åˆ†ç±»çš„é¡¹ç›®ç»ç†",
    "weight": 1.0,
    "properties": {
        "createdReason": "ä»æ–‡ä»¶å†…å®¹æå–",
        "autoCreated": true,
        "extractedText": "é¡¹ç›®ç»ç†ï¼šå¼ ä¸‰",
        "personName": "å¼ ä¸‰"
    }
}
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "id": "rel-guid-1",
    "sourceEntityId": "guid-1",
    "sourceEntityType": "Person",
    "targetEntityId": "guid-2",
    "targetEntityType": "Catalogue",
    "relationshipType": "PersonIsProjectManagerForCatalogue",
    "description": "äººå‘˜æ˜¯åˆ†ç±»çš„é¡¹ç›®ç»ç†",
    "weight": 1.0,
    "properties": {
        "createdReason": "ä»æ–‡ä»¶å†…å®¹æå–",
        "autoCreated": true,
        "extractedText": "é¡¹ç›®ç»ç†ï¼šå¼ ä¸‰",
        "personName": "å¼ ä¸‰"
    },
    "createdTime": "2024-11-21T10:00:00Z",
    "createdBy": "user-guid-1"
}
```

#### 4.4.2 æ‰¹é‡åˆ›å»ºå…³ç³»

```http
POST /api/knowledge-graph/relationships/batch
```

**è¯·æ±‚ä½“**ï¼š

```json
{
    "relationships": [
        {
            "sourceEntityId": "guid-1",
            "sourceEntityType": "Catalogue",
            "targetEntityId": "guid-2",
            "targetEntityType": "File",
            "relationshipType": "CatalogueContainsFile",
            "weight": 1.0
        }
    ],
    "skipValidation": false,
    "skipDuplicates": true
}
```

#### 4.4.3 æ›´æ–°å…³ç³»

```http
PUT /api/knowledge-graph/relationships/{relationshipId}
```

#### 4.4.4 åˆ é™¤å…³ç³»

```http
DELETE /api/knowledge-graph/relationships/{relationshipId}
```

#### 4.4.5 è·å–å®ä½“çš„å…³ç³»ç½‘ç»œ

```http
GET /api/knowledge-graph/entities/{entityId}/relationships?direction=both&maxDepth=1
```

### 4.5 å½±å“åˆ†ææ¥å£

#### 4.5.1 è®¡ç®—å½±å“åˆ†æ

```http
POST /api/knowledge-graph/impact-analysis
```

**è¯·æ±‚ä½“**ï¼š

```json
{
    "entityId": "guid-1",
    "changeType": "UPDATE", // CREATE, UPDATE, DELETE
    "impactRadius": 3, // å½±å“åŠå¾„ï¼ˆå¯é€‰ï¼Œé»˜è®¤è‡ªåŠ¨è®¡ç®—ï¼‰
    "includeBusinessImpact": true
}
```

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "entityId": "guid-1",
    "entityName": "é¡¹ç›®A",
    "impactRadius": 3,
    "affectedNodes": [
        {
            "id": "guid-2",
            "name": "æµç¨‹B",
            "type": "Process",
            "impactLevel": "HIGH",
            "impactReason": "ç›´æ¥ä¾èµ–å…³ç³»"
        },
        {
            "id": "guid-3",
            "name": "æ¡£æ¡ˆC",
            "type": "Archive",
            "impactLevel": "MEDIUM",
            "impactReason": "é—´æ¥ä¾èµ–å…³ç³»ï¼ˆ2è·³ï¼‰"
        }
    ],
    "statistics": {
        "totalAffectedNodes": 15,
        "highImpactNodes": 3,
        "mediumImpactNodes": 8,
        "lowImpactNodes": 4
    },
    "businessImpact": {
        "severity": "MEDIUM",
        "affectedBusinessProcesses": 5,
        "dataIntegrityRisk": "MEDIUM",
        "complianceRisk": "LOW",
        "operationalImpact": {
            "affectedCatalogues": 12,
            "affectedFiles": 45,
            "estimatedRecoveryTime": "2-3å¤©",
            "complexity": "MEDIUM"
        },
        "breakdown": {
            "dataIntegrityImpact": {
                "riskLevel": "MEDIUM",
                "affectedDataSources": 3,
                "potentialDataLoss": false
            },
            "complianceImpact": {
                "riskLevel": "LOW",
                "affectedComplianceRules": 1,
                "auditRisk": "LOW"
            },
            "operationalImpact": {
                "affectedUsers": 15,
                "workflowDisruption": "MEDIUM",
                "recoveryComplexity": "MEDIUM"
            }
        }
    },
    "riskAssessment": {
        "riskLevel": "MEDIUM",
        "riskScore": 65,
        "riskFactors": [
            {
                "factor": "å½±å“èŒƒå›´å¤§",
                "weight": 0.4,
                "score": 80
            },
            {
                "factor": "ä¸šåŠ¡å½±å“ä¸­ç­‰",
                "weight": 0.3,
                "score": 60
            }
        ]
    },
    "mitigationSuggestions": [
        {
            "priority": "HIGH",
            "suggestion": "å»ºè®®åˆ†é˜¶æ®µå®æ–½å˜æ›´ï¼Œå…ˆæ›´æ–°æ ¸å¿ƒæµç¨‹",
            "estimatedEffort": "2å‘¨"
        },
        {
            "priority": "MEDIUM",
            "suggestion": "é€šçŸ¥æ‰€æœ‰å—å½±å“çš„è´£ä»»äººï¼Œå‡†å¤‡åº”æ€¥é¢„æ¡ˆ",
            "estimatedEffort": "3å¤©"
        }
    ]
}
```

### 4.5 é£é™©é¢„è­¦æ¥å£

#### 4.5.1 è·å–é£é™©é¢„è­¦åˆ—è¡¨

```http
GET /api/knowledge-graph/risk-alerts
```

**æŸ¥è¯¢å‚æ•°**ï¼š

-   `riskLevel`ï¼šé£é™©ç­‰çº§è¿‡æ»¤ï¼ˆ`HIGH`|`MEDIUM`|`LOW`ï¼Œå¯é€‰ï¼‰
-   `status`ï¼šçŠ¶æ€è¿‡æ»¤ï¼ˆ`ACTIVE`|`ACKNOWLEDGED`|`RESOLVED`ï¼Œé»˜è®¤`ACTIVE`ï¼‰
-   `entityId`ï¼šå®ä½“ ID è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
-   `pageIndex`ï¼šé¡µç ï¼ˆé»˜è®¤ 1ï¼‰
-   `pageSize`ï¼šæ¯é¡µæ•°é‡ï¼ˆé»˜è®¤ 20ï¼‰

**å“åº”ç¤ºä¾‹**ï¼š

```json
{
    "totalCount": 12,
    "items": [
        {
            "id": "alert-1",
            "entityId": "guid-1",
            "entityName": "é¡¹ç›®A",
            "entityType": "Project",
            "riskLevel": "HIGH",
            "riskType": "æ•°æ®å®Œæ•´æ€§é£é™©",
            "riskDescription": "é¡¹ç›®å…³è”çš„3ä¸ªæµç¨‹å­˜åœ¨æ•°æ®ä¸ä¸€è‡´é—®é¢˜",
            "affectedEntityCount": 8,
            "businessImpact": {
                "severity": "HIGH",
                "dataIntegrityRisk": "HIGH",
                "complianceRisk": "MEDIUM",
                "operationalImpact": {
                    "affectedCatalogues": 5,
                    "affectedFiles": 20,
                    "estimatedRecoveryTime": "1-2å¤©",
                    "complexity": "HIGH"
                }
            },
            "mitigationSuggestion": "å»ºè®®ç«‹å³æ£€æŸ¥å¹¶ä¿®å¤æ•°æ®ä¸ä¸€è‡´é—®é¢˜",
            "responsiblePersonId": "person-1",
            "responsiblePersonName": "å¼ ä¸‰",
            "status": "ACTIVE",
            "createdTime": "2024-11-21T09:00:00Z",
            "acknowledgedTime": null,
            "resolvedTime": null
        }
    ],
    "statistics": {
        "highRiskCount": 3,
        "mediumRiskCount": 5,
        "lowRiskCount": 4,
        "activeCount": 12,
        "acknowledgedCount": 0,
        "resolvedCount": 0
    }
}
```

#### 4.5.2 åˆ›å»ºé£é™©é¢„è­¦

```http
POST /api/knowledge-graph/risk-alerts
```

**è¯·æ±‚ä½“**ï¼š

```json
{
    "entityId": "guid-1",
    "riskLevel": "HIGH",
    "riskType": "æ•°æ®å®Œæ•´æ€§é£é™©",
    "riskDescription": "è¯¦ç»†æè¿°",
    "mitigationSuggestion": "åº”å¯¹å»ºè®®",
    "responsiblePersonId": "person-1"
}
```

#### 4.5.3 ç¡®è®¤é£é™©é¢„è­¦

```http
PUT /api/knowledge-graph/risk-alerts/{alertId}/acknowledge
```

#### 4.5.4 è§£å†³é£é™©é¢„è­¦

```http
PUT /api/knowledge-graph/risk-alerts/{alertId}/resolve
```

---

## 5. æ ¸å¿ƒç®—æ³•è®¾è®¡

### 5.1 å½±å“åŠå¾„è®¡ç®—ç®—æ³•

#### 5.1.1 ç®—æ³•æè¿°

å½±å“åŠå¾„è®¡ç®—é‡‡ç”¨åŸºäºå›¾éå†çš„ BFSï¼ˆå¹¿åº¦ä¼˜å…ˆæœç´¢ï¼‰ç®—æ³•ï¼Œè€ƒè™‘å…³ç³»æƒé‡å’Œå®ä½“é‡è¦æ€§ã€‚

```csharp
public class ImpactAnalysisService
{
    /// <summary>
    /// è®¡ç®—èŠ‚ç‚¹å˜æ›´çš„å½±å“èŒƒå›´
    /// </summary>
    public ImpactAnalysisResult CalculateImpact(
        Guid entityId,
        ChangeType changeType,
        int? maxDepth = null)
    {
        var result = new ImpactAnalysisResult
        {
            EntityId = entityId,
            AffectedNodes = new List<AffectedNode>(),
            ImpactRadius = 0
        };

        // ä½¿ç”¨BFSéå†å›¾
        var queue = new Queue<(Guid nodeId, int depth, double cumulativeWeight)>();
        var visited = new HashSet<Guid>();
        var nodeImportance = new Dictionary<Guid, double>();

        queue.Enqueue((entityId, 0, 1.0));
        visited.Add(entityId);

        while (queue.Count > 0)
        {
            var (currentId, depth, weight) = queue.Dequeue();

            // å¦‚æœè¾¾åˆ°æœ€å¤§æ·±åº¦ï¼Œåœæ­¢éå†
            if (maxDepth.HasValue && depth >= maxDepth.Value)
                continue;

            // è·å–å½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰å‡ºè¾¹å…³ç³»
            var relationships = GetOutgoingRelationships(currentId);

            foreach (var rel in relationships)
            {
                if (visited.Contains(rel.TargetEntityId))
                    continue;

                // è®¡ç®—å½±å“æƒé‡ï¼ˆå…³ç³»æƒé‡ Ã— ç´¯ç§¯æƒé‡ Ã— å®ä½“é‡è¦æ€§ï¼‰
                var entityImp = GetEntityImportance(rel.TargetEntityId);
                var impactWeight = rel.Weight * weight * entityImp;

                // å¦‚æœå½±å“æƒé‡ä½äºé˜ˆå€¼ï¼Œè·³è¿‡
                if (impactWeight < 0.1)
                    continue;

                visited.Add(rel.TargetEntityId);
                queue.Enqueue((rel.TargetEntityId, depth + 1, impactWeight));

                // è®°å½•å—å½±å“èŠ‚ç‚¹
                result.AffectedNodes.Add(new AffectedNode
                {
                    Id = rel.TargetEntityId,
                    ImpactLevel = DetermineImpactLevel(impactWeight),
                    ImpactReason = $"é€šè¿‡{rel.Type}å…³ç³»å½±å“ï¼ˆ{depth + 1}è·³ï¼‰",
                    ImpactWeight = impactWeight
                });

                result.ImpactRadius = Math.Max(result.ImpactRadius, depth + 1);
            }
        }

        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        result.Statistics = CalculateStatistics(result.AffectedNodes);

        // è®¡ç®—ä¸šåŠ¡å½±å“
        result.BusinessImpact = CalculateBusinessImpact(
            result.AffectedNodes,
            changeType);

        // é£é™©è¯„ä¼°
        result.RiskAssessment = AssessRisk(result);

        // ç”Ÿæˆåº”å¯¹å»ºè®®
        result.MitigationSuggestions = GenerateMitigationSuggestions(result);

        return result;
    }

    private ImpactLevel DetermineImpactLevel(double impactWeight)
    {
        if (impactWeight >= 0.7) return ImpactLevel.High;
        if (impactWeight >= 0.4) return ImpactLevel.Medium;
        return ImpactLevel.Low;
    }

    private double GetEntityImportance(Guid entityId)
    {
        // æ ¹æ®å®ä½“ç±»å‹ã€ä¸šåŠ¡ä¼˜å…ˆçº§ã€å…³è”æ•°é‡ç­‰å› ç´ è®¡ç®—é‡è¦æ€§
        var entity = GetEntity(entityId);
        var importance = 1.0;

        // ä¸šåŠ¡ä¼˜å…ˆçº§æƒé‡
        switch (entity.BusinessPriority)
        {
            case "é«˜": importance *= 1.5; break;
            case "ä¸­": importance *= 1.0; break;
            case "ä½": importance *= 0.7; break;
        }

        // å…³è”æ•°é‡æƒé‡ï¼ˆå…³è”è¶Šå¤šï¼Œé‡è¦æ€§è¶Šé«˜ï¼‰
        var relationshipCount = GetRelationshipCount(entityId);
        importance *= Math.Min(1.0 + relationshipCount * 0.1, 2.0);

        return importance;
    }
}
```

#### 5.1.2 Apache AGE Cypher æŸ¥è¯¢å®ç°

```cypher
-- å½±å“åˆ†ææŸ¥è¯¢ï¼ˆä½¿ç”¨BFSéå†ï¼‰
-- æ³¨æ„ï¼šä»¥ä¸‹ä¸º Cypher è¯­æ³•ï¼Œå®é™…ä½¿ç”¨æ—¶é€šè¿‡ AGE çš„ cypher() å‡½æ•°æ‰§è¡Œ
MATCH path = (start:Entity {id: $entityId})-[*1..3]-(affected:Entity)
WHERE start.id = $entityId
WITH affected,
     length(path) as depth,
     reduce(weight = 1.0, rel in relationships(path) | weight * rel.weight) as impactWeight
WHERE impactWeight >= 0.1
RETURN affected.id as entityId,
       affected.name as entityName,
       affected.type as entityType,
       depth,
       impactWeight,
       CASE
         WHEN impactWeight >= 0.7 THEN 'HIGH'
         WHEN impactWeight >= 0.4 THEN 'MEDIUM'
         ELSE 'LOW'
       END as impactLevel
ORDER BY impactWeight DESC, depth ASC
LIMIT 100
```

### 5.2 æœç´¢æ’åºç®—æ³•

#### 5.2.1 åŒ¹é…åº¦è®¡ç®—

```csharp
public class SearchService
{
    /// <summary>
    /// è®¡ç®—æœç´¢åŒ¹é…åº¦
    /// æ³¨æ„ï¼šentityå‚æ•°åŒ…å«ä»ç°æœ‰å®ä½“è¡¨JOINè·å–çš„å®Œæ•´ä¿¡æ¯
    /// </summary>
    public double CalculateRelevanceScore(
        KnowledgeGraphEntityViewModel entity, // åŒ…å«ä»ç°æœ‰å®ä½“è¡¨JOINè·å–çš„Nameã€Tagsç­‰ä¿¡æ¯
        string keyword,
        List<string> matchedFields)
    {
        double score = 0.0;
        var keywordLower = keyword.ToLowerInvariant();

        // åç§°åŒ¹é…ï¼ˆæƒé‡æœ€é«˜ï¼‰
        if (matchedFields.Contains("name"))
        {
            var nameMatch = CalculateStringSimilarity(
                entity.Name.ToLowerInvariant(),
                keywordLower);
            score += nameMatch * 0.5; // åç§°åŒ¹é…æƒé‡50%
        }

        // æ ‡ç­¾åŒ¹é…
        if (entity.Tags != null)
        {
            var tagMatches = entity.Tags.Count(tag =>
                tag.ToLowerInvariant().Contains(keywordLower));
            if (tagMatches > 0)
            {
                score += (tagMatches / (double)entity.Tags.Count) * 0.3; // æ ‡ç­¾åŒ¹é…æƒé‡30%
            }
        }

        // æè¿°åŒ¹é…ï¼ˆå¦‚æœå®ä½“æœ‰Descriptionå­—æ®µï¼‰
        // æ³¨æ„ï¼šDescriptionå­—æ®µä»ç°æœ‰å®ä½“è¡¨çš„Summaryæˆ–Descriptionå­—æ®µè·å–
        var description = entity.GraphProperties?.GetValueOrDefault("description")?.ToString();
        if (!string.IsNullOrEmpty(description) &&
            description.ToLowerInvariant().Contains(keywordLower))
        {
            score += 0.2; // æè¿°åŒ¹é…æƒé‡20%
        }

        return Math.Min(score, 1.0);
    }

    /// <summary>
    /// ç»¼åˆæ’åºï¼ˆåŒ¹é…åº¦ + ä¸šåŠ¡ä¼˜å…ˆçº§ï¼‰
    /// </summary>
    public List<SearchResult> SortSearchResults(
        List<SearchResult> results,
        SortBy sortBy)
    {
        return sortBy switch
        {
            SortBy.Relevance => results
                .OrderByDescending(r => r.MatchScore)
                .ThenByDescending(r => GetBusinessPriorityWeight(r.BusinessPriority))
                .ToList(),

            SortBy.Priority => results
                .OrderByDescending(r => GetBusinessPriorityWeight(r.BusinessPriority))
                .ThenByDescending(r => r.MatchScore)
                .ToList(),

            SortBy.UpdatedTime => results
                .OrderByDescending(r => r.UpdatedTime)
                .ThenByDescending(r => r.MatchScore)
                .ToList(),

            _ => results
        };
    }

    private double GetBusinessPriorityWeight(string? priority)
    {
        return priority switch
        {
            "é«˜" => 3.0,
            "ä¸­" => 2.0,
            "ä½" => 1.0,
            _ => 1.0
        };
    }

    private double CalculateStringSimilarity(string str1, string str2)
    {
        // ä½¿ç”¨Levenshteinè·ç¦»æˆ–Jaro-Winklerç›¸ä¼¼åº¦
        // ç®€åŒ–å®ç°ï¼šä½¿ç”¨åŒ…å«å…³ç³»
        if (str1 == str2) return 1.0;
        if (str1.Contains(str2) || str2.Contains(str1)) return 0.8;

        // å¯ä»¥ä½¿ç”¨æ›´å¤æ‚çš„å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ç®—æ³•
        return 0.0;
    }
}
```

#### 5.2.2 PostgreSQL å…¨æ–‡æœç´¢å®ç°

```sql
-- ä½¿ç”¨PostgreSQLå…¨æ–‡æœç´¢è¿›è¡ŒèŠ‚ç‚¹æœç´¢
-- å‡è®¾å·²åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆGINç´¢å¼•ï¼‰
SELECT
    e.id,
    e.entity_type,
    e.name,
    e.tags,
    e.properties,
    -- è®¡ç®—åŒ¹é…åº¦åˆ†æ•°ï¼ˆåç§°æƒé‡3.0ï¼Œæ ‡ç­¾æƒé‡2.0ï¼Œæè¿°æƒé‡1.0ï¼‰
    (
        ts_rank_cd(
            to_tsvector('simple', COALESCE(e.name, '')),
            plainto_tsquery('simple', $keyword)
        ) * 3.0 +
        ts_rank_cd(
            to_tsvector('simple', COALESCE(array_to_string(e.tags, ' '), '')),
            plainto_tsquery('simple', $keyword)
        ) * 2.0 +
        ts_rank_cd(
            to_tsvector('simple', COALESCE(e.properties->>'description', '')),
            plainto_tsquery('simple', $keyword)
        ) * 1.0
    ) as match_score,
    e.business_priority,
    e.security_level,
    e.updated_time
FROM kg_entity_graph_metadata e
WHERE
    -- å…¨æ–‡æœç´¢æ¡ä»¶
    (
        to_tsvector('simple', COALESCE(e.name, '')) @@ plainto_tsquery('simple', $keyword) OR
        to_tsvector('simple', COALESCE(array_to_string(e.tags, ' '), '')) @@ plainto_tsquery('simple', $keyword) OR
        to_tsvector('simple', COALESCE(e.properties->>'description', '')) @@ plainto_tsquery('simple', $keyword)
    )
    -- å®ä½“ç±»å‹è¿‡æ»¤
    AND ($entityTypes IS NULL OR e.entity_type = ANY($entityTypes))
    -- æ ‡ç­¾è¿‡æ»¤
    AND ($tags IS NULL OR e.tags && $tags)
ORDER BY
    match_score DESC,
    CASE e.business_priority
        WHEN 'é«˜' THEN 3
        WHEN 'ä¸­' THEN 2
        WHEN 'ä½' THEN 1
        ELSE 0
    END DESC,
    e.updated_time DESC
LIMIT $pageSize OFFSET $offset;
```

**PostgreSQL å…¨æ–‡æœç´¢ç´¢å¼•åˆ›å»º**ï¼š

```sql
-- ä¸ºå®ä½“åç§°åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_entity_name_fts ON kg_entity_graph_metadata
    USING GIN(to_tsvector('simple', COALESCE((graph_properties->>'name')::text, '')));

-- ä¸ºæ ‡ç­¾æ•°ç»„åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_entity_tags_fts ON kg_entity_graph_metadata
    USING GIN(to_tsvector('simple', COALESCE(array_to_string(tags, ' '), '')));

-- ä¸ºæè¿°åˆ›å»ºå…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_entity_description_fts ON kg_entity_graph_metadata
    USING GIN(to_tsvector('simple', COALESCE((graph_properties->>'description')::text, '')));

-- å¤åˆå…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆæå‡æŸ¥è¯¢æ€§èƒ½ï¼‰
CREATE INDEX idx_entity_fulltext_fts ON kg_entity_graph_metadata
    USING GIN(
        to_tsvector('simple',
            COALESCE((graph_properties->>'name')::text, '') || ' ' ||
            COALESCE(array_to_string(tags, ' '), '') || ' ' ||
            COALESCE((graph_properties->>'description')::text, '')
        )
    );
```

### 5.3 é£é™©è¯„ä¼°ç®—æ³•

```csharp
public class RiskAssessmentService
{
    /// <summary>
    /// è¯„ä¼°èŠ‚ç‚¹å˜æ›´çš„é£é™©ç­‰çº§
    /// </summary>
    public RiskAssessment AssessRisk(ImpactAnalysisResult impactAnalysis)
    {
        var riskFactors = new List<RiskFactor>();

        // å› å­1ï¼šå½±å“èŒƒå›´
        var scopeFactor = new RiskFactor
        {
            Factor = "å½±å“èŒƒå›´",
            Weight = 0.4,
            Score = CalculateScopeScore(impactAnalysis.AffectedNodes.Count)
        };
        riskFactors.Add(scopeFactor);

        // å› å­2ï¼šä¸šåŠ¡å½±å“ï¼ˆæ•°æ®å®Œæ•´æ€§ã€åˆè§„æ€§ã€æ“ä½œå½±å“ï¼‰
        var businessImpactFactor = new RiskFactor
        {
            Factor = "ä¸šåŠ¡å½±å“",
            Weight = 0.3,
            Score = CalculateBusinessImpactScore(impactAnalysis.BusinessImpact)
        };
        riskFactors.Add(businessImpactFactor);

        // å› å­3ï¼šé«˜å½±å“èŠ‚ç‚¹æ¯”ä¾‹
        var highImpactRatio = impactAnalysis.AffectedNodes.Count > 0
            ? impactAnalysis.AffectedNodes.Count(n => n.ImpactLevel == ImpactLevel.High)
              / (double)impactAnalysis.AffectedNodes.Count
            : 0.0;
        var highImpactFactor = new RiskFactor
        {
            Factor = "é«˜å½±å“èŠ‚ç‚¹æ¯”ä¾‹",
            Weight = 0.2,
            Score = highImpactRatio * 100
        };
        riskFactors.Add(highImpactFactor);

        // å› å­4ï¼šå½±å“åŠå¾„
        var radiusFactor = new RiskFactor
        {
            Factor = "å½±å“åŠå¾„",
            Weight = 0.1,
            Score = Math.Min(impactAnalysis.ImpactRadius * 20, 100)
        };
        riskFactors.Add(radiusFactor);

        // è®¡ç®—ç»¼åˆé£é™©åˆ†æ•°
        var totalScore = riskFactors.Sum(f => f.Score * f.Weight);

        // ç¡®å®šé£é™©ç­‰çº§
        var riskLevel = totalScore >= 70 ? RiskLevel.High
                     : totalScore >= 40 ? RiskLevel.Medium
                     : RiskLevel.Low;

        return new RiskAssessment
        {
            RiskLevel = riskLevel,
            RiskScore = totalScore,
            RiskFactors = riskFactors
        };
    }

    private double CalculateScopeScore(int affectedCount)
    {
        // å½±å“èŠ‚ç‚¹æ•°è¶Šå¤šï¼Œåˆ†æ•°è¶Šé«˜ï¼ˆæœ€é«˜100åˆ†ï¼‰
        return Math.Min(affectedCount * 5, 100);
    }

    /// <summary>
    /// è®¡ç®—ä¸šåŠ¡å½±å“åˆ†æ•°ï¼ˆç»¼åˆè€ƒè™‘æ•°æ®å®Œæ•´æ€§ã€åˆè§„æ€§ã€æ“ä½œå½±å“ï¼‰
    /// </summary>
    private double CalculateBusinessImpactScore(BusinessImpact? businessImpact)
    {
        if (businessImpact == null) return 0.0;

        double score = 0.0;

        // æ•°æ®å®Œæ•´æ€§é£é™©è¯„åˆ†ï¼ˆæƒé‡40%ï¼‰
        var dataIntegrityScore = businessImpact.DataIntegrityRisk switch
        {
            "HIGH" => 100.0,
            "MEDIUM" => 60.0,
            "LOW" => 20.0,
            _ => 0.0
        };
        score += dataIntegrityScore * 0.4;

        // åˆè§„æ€§é£é™©è¯„åˆ†ï¼ˆæƒé‡30%ï¼‰
        var complianceScore = businessImpact.ComplianceRisk switch
        {
            "HIGH" => 100.0,
            "MEDIUM" => 60.0,
            "LOW" => 20.0,
            _ => 0.0
        };
        score += complianceScore * 0.3;

        // æ“ä½œå½±å“è¯„åˆ†ï¼ˆæƒé‡30%ï¼‰
        var operationalScore = businessImpact.OperationalImpact?.Complexity switch
        {
            "HIGH" => 100.0,
            "MEDIUM" => 60.0,
            "LOW" => 20.0,
            _ => 0.0
        } ?? 0.0;
        score += operationalScore * 0.3;

        return Math.Min(score, 100.0);
    }

    /// <summary>
    /// è®¡ç®—ä¸šåŠ¡å½±å“ï¼ˆåŸºäºå—å½±å“èŠ‚ç‚¹å’Œå˜æ›´ç±»å‹ï¼‰
    /// </summary>
    private BusinessImpact CalculateBusinessImpact(
        List<AffectedNode> affectedNodes,
        ChangeType changeType)
    {
        var result = new BusinessImpact
        {
            Severity = DetermineBusinessSeverity(affectedNodes, changeType),
            AffectedBusinessProcesses = CalculateAffectedBusinessProcesses(affectedNodes),
            DataIntegrityRisk = AssessDataIntegrityRisk(affectedNodes, changeType),
            ComplianceRisk = AssessComplianceRisk(affectedNodes, changeType),
            OperationalImpact = CalculateOperationalImpact(affectedNodes, changeType)
        };

        return result;
    }

    /// <summary>
    /// ç¡®å®šä¸šåŠ¡å½±å“ä¸¥é‡ç¨‹åº¦
    /// </summary>
    private string DetermineBusinessSeverity(List<AffectedNode> affectedNodes, ChangeType changeType)
    {
        var highImpactCount = affectedNodes.Count(n => n.ImpactLevel == ImpactLevel.High);
        var totalCount = affectedNodes.Count;

        // DELETEæ“ä½œçš„å½±å“æœ€ä¸¥é‡
        if (changeType == ChangeType.Delete)
        {
            if (highImpactCount > totalCount * 0.5 || totalCount > 20)
                return "HIGH";
            if (highImpactCount > 0 || totalCount > 10)
                return "MEDIUM";
            return "LOW";
        }

        // UPDATEæ“ä½œçš„å½±å“ä¸­ç­‰
        if (changeType == ChangeType.Update)
        {
            if (highImpactCount > totalCount * 0.3 || totalCount > 15)
                return "MEDIUM";
            return "LOW";
        }

        // CREATEæ“ä½œçš„å½±å“è¾ƒä½
        return totalCount > 10 ? "MEDIUM" : "LOW";
    }

    /// <summary>
    /// è®¡ç®—å—å½±å“çš„ä¸šåŠ¡æµç¨‹æ•°é‡
    /// </summary>
    private int CalculateAffectedBusinessProcesses(List<AffectedNode> affectedNodes)
    {
        // æ ¹æ®å—å½±å“èŠ‚ç‚¹çš„ReferenceTypeç»Ÿè®¡ä¸åŒçš„ä¸šåŠ¡æµç¨‹
        var businessProcesses = affectedNodes
            .Select(n => GetEntity(n.Id)?.ReferenceType)
            .Where(rt => rt.HasValue)
            .Distinct()
            .Count();

        return businessProcesses;
    }

    /// <summary>
    /// è¯„ä¼°æ•°æ®å®Œæ•´æ€§é£é™©
    /// </summary>
    private string AssessDataIntegrityRisk(List<AffectedNode> affectedNodes, ChangeType changeType)
    {
        var catalogueCount = affectedNodes.Count(n => GetEntity(n.Id)?.Type == "Catalogue");

        // DELETEæ“ä½œå¯¹æ•°æ®å®Œæ•´æ€§å½±å“æœ€å¤§
        if (changeType == ChangeType.Delete)
        {
            if (catalogueCount > 5)
                return "HIGH";
            if (catalogueCount > 2)
                return "MEDIUM";
            return "LOW";
        }

        // UPDATEæ“ä½œå¯èƒ½å½±å“æ•°æ®ä¸€è‡´æ€§
        if (changeType == ChangeType.Update)
        {
            if (catalogueCount > 3)
                return "MEDIUM";
            return "LOW";
        }

        return "LOW";
    }

    /// <summary>
    /// è¯„ä¼°åˆè§„æ€§é£é™©
    /// </summary>
    private string AssessComplianceRisk(List<AffectedNode> affectedNodes, ChangeType changeType)
    {
        // æ£€æŸ¥å—å½±å“èŠ‚ç‚¹ä¸­æ˜¯å¦æœ‰å½’æ¡£çš„åˆ†ç±»ï¼ˆå½’æ¡£æ•°æ®é€šå¸¸æœ‰åˆè§„æ€§è¦æ±‚ï¼‰
        var archivedCount = affectedNodes.Count(n =>
        {
            var entity = GetEntity(n.Id);
            return entity?.Type == "Catalogue" && entity.IsArchived == true;
        });

        // DELETEæ“ä½œå¯¹åˆè§„æ€§å½±å“æœ€å¤§
        if (changeType == ChangeType.Delete)
        {
            if (archivedCount > 2)
                return "HIGH";
            if (archivedCount > 0)
                return "MEDIUM";
            return "LOW";
        }

        // UPDATEæ“ä½œå¯èƒ½å½±å“å®¡è®¡è½¨è¿¹
        if (changeType == ChangeType.Update && archivedCount > 0)
            return "MEDIUM";

        return "LOW";
    }

    /// <summary>
    /// è®¡ç®—æ“ä½œå½±å“
    /// </summary>
    private OperationalImpact CalculateOperationalImpact(
        List<AffectedNode> affectedNodes,
        ChangeType changeType)
    {
        var catalogueCount = affectedNodes.Count(n => GetEntity(n.Id)?.Type == "Catalogue");
        var totalCount = affectedNodes.Count;

        // ç¡®å®šå¤æ‚åº¦
        string complexity;
        string estimatedRecoveryTime;

        if (changeType == ChangeType.Delete)
        {
            if (totalCount > 20 || catalogueCount > 5)
            {
                complexity = "HIGH";
                estimatedRecoveryTime = "3-5å¤©";
            }
            else if (totalCount > 10 || catalogueCount > 2)
            {
                complexity = "MEDIUM";
                estimatedRecoveryTime = "1-2å¤©";
            }
            else
            {
                complexity = "LOW";
                estimatedRecoveryTime = "åŠå¤©å†…";
            }
        }
        else if (changeType == ChangeType.Update)
        {
            if (totalCount > 15 || catalogueCount > 3)
            {
                complexity = "MEDIUM";
                estimatedRecoveryTime = "1-2å¤©";
            }
            else
            {
                complexity = "LOW";
                estimatedRecoveryTime = "åŠå¤©å†…";
            }
        }
        else
        {
            complexity = "LOW";
            estimatedRecoveryTime = "æ— éœ€æ¢å¤";
        }

        return new OperationalImpact
        {
            AffectedCatalogues = catalogueCount,
            AffectedFiles = 0, // æ–‡ä»¶é€šè¿‡åˆ†ç±»ç›´æ¥è®¿é—®ï¼Œä¸å•ç‹¬ç»Ÿè®¡
            EstimatedRecoveryTime = estimatedRecoveryTime,
            Complexity = complexity
        };
    }
}
```

---

## 6. å‰ç«¯å®ç°æ–¹æ¡ˆ

### 6.1 å›¾è°±å¯è§†åŒ–ç»„ä»¶

#### 6.1.1 React ç»„ä»¶ç»“æ„

```tsx
// KnowledgeGraphView.tsx
import React, { useEffect, useRef, useState } from 'react';
import cytoscape from 'cytoscape';
import dagre from 'cytoscape-dagre';
import { Card, Spin, message } from 'antd';

cytoscape.use(dagre);

interface KnowledgeGraphViewProps {
    entityTypes?: string[];
    relationshipTypes?: string[];
    centerEntityId?: string;
    onNodeClick?: (nodeId: string) => void;
}

const KnowledgeGraphView: React.FC<KnowledgeGraphViewProps> = ({
    entityTypes,
    relationshipTypes,
    centerEntityId,
    onNodeClick,
}) => {
    const containerRef = useRef<HTMLDivElement>(null);
    const cyRef = useRef<cytoscape.Core | null>(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!containerRef.current) return;

        // åˆå§‹åŒ–Cytoscape
        const cy = cytoscape({
            container: containerRef.current,
            elements: [],
            style: [
                {
                    selector: 'node',
                    style: {
                        label: 'data(name)',
                        width: 'mapData(importance, 0, 100, 20, 60)',
                        height: 'mapData(importance, 0, 100, 20, 60)',
                        'background-color': 'data(color)',
                        'border-width': 2,
                        'border-color': '#fff',
                        'font-size': '12px',
                        'text-valign': 'center',
                        'text-halign': 'center',
                    },
                },
                {
                    selector: 'edge',
                    style: {
                        width: 'mapData(weight, 0, 1, 1, 5)',
                        'line-color': '#999',
                        'target-arrow-color': '#999',
                        'target-arrow-shape': 'triangle',
                        'curve-style': 'bezier',
                        label: 'data(type)',
                        'font-size': '10px',
                    },
                },
                {
                    selector: 'node[type="Project"]',
                    style: { 'background-color': '#1890ff' },
                },
                {
                    selector: 'node[type="Process"]',
                    style: { 'background-color': '#52c41a' },
                },
                {
                    selector: 'node[type="Archive"]',
                    style: { 'background-color': '#faad14' },
                },
                {
                    selector: 'node[type="Department"]',
                    style: { 'background-color': '#722ed1' },
                },
                {
                    selector: 'node[type="Person"]',
                    style: { 'background-color': '#eb2f96' },
                },
            ],
            layout: {
                name: 'dagre',
                rankDir: 'TB',
                spacingFactor: 1.5,
            },
        });

        cyRef.current = cy;

        // èŠ‚ç‚¹ç‚¹å‡»äº‹ä»¶
        cy.on('tap', 'node', (evt) => {
            const node = evt.target;
            onNodeClick?.(node.id());
        });

        // åŠ è½½å›¾è°±æ•°æ®
        loadGraphData();

        return () => {
            cy.destroy();
        };
    }, [entityTypes, relationshipTypes, centerEntityId]);

    const loadGraphData = async () => {
        setLoading(true);
        try {
            const response = await fetch(
                '/api/knowledge-graph/graph?' +
                    new URLSearchParams({
                        entityTypes: entityTypes?.join(',') || '',
                        relationshipTypes: relationshipTypes?.join(',') || '',
                        centerEntityId: centerEntityId || '',
                    })
            );
            const data = await response.json();

            // è½¬æ¢æ•°æ®æ ¼å¼
            const elements = [
                ...data.nodes.map((node: any) => ({
                    data: {
                        id: node.id,
                        name: node.name,
                        type: node.type,
                        importance: node.properties?.importance || 50,
                        color: getNodeColor(node.type),
                    },
                })),
                ...data.edges.map((edge: any) => ({
                    data: {
                        id: edge.id,
                        source: edge.source,
                        target: edge.target,
                        type: edge.type,
                        weight: edge.weight || 0.5,
                    },
                })),
            ];

            cyRef.current?.json({ elements });
            cyRef.current?.layout({ name: 'dagre' }).run();
        } catch (error) {
            message.error('åŠ è½½å›¾è°±æ•°æ®å¤±è´¥');
        } finally {
            setLoading(false);
        }
    };

    const getNodeColor = (type: string): string => {
        const colorMap: Record<string, string> = {
            Project: '#1890ff',
            Process: '#52c41a',
            Archive: '#faad14',
            Department: '#722ed1',
            Person: '#eb2f96',
        };
        return colorMap[type] || '#999';
    };

    return (
        <Card>
            <Spin spinning={loading}>
                <div
                    ref={containerRef}
                    style={{
                        width: '100%',
                        height: '800px',
                        border: '1px solid #d9d9d9',
                        borderRadius: '4px',
                    }}
                />
            </Spin>
        </Card>
    );
};

export default KnowledgeGraphView;
```

#### 6.1.2 èŠ‚ç‚¹æœç´¢ç»„ä»¶

```tsx
// NodeSearchPanel.tsx
import React, { useState, useEffect } from 'react';
import { Input, List, Tag, Empty, Spin } from 'antd';
import { SearchOutlined } from '@ant-design/icons';

interface SearchResult {
    id: string;
    type: string;
    name: string;
    matchedFields: string[];
    matchScore: number;
    businessPriority?: string;
    securityLevel?: string;
    updatedTime: string;
    highlight?: {
        name?: string;
    };
}

const NodeSearchPanel: React.FC<{
    onSelect: (entityId: string) => void;
}> = ({ onSelect }) => {
    const [keyword, setKeyword] = useState('');
    const [results, setResults] = useState<SearchResult[]>([]);
    const [loading, setLoading] = useState(false);
    const [debounceTimer, setDebounceTimer] = useState<NodeJS.Timeout>();

    useEffect(() => {
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }

        if (!keyword.trim()) {
            setResults([]);
            return;
        }

        const timer = setTimeout(() => {
            performSearch(keyword);
        }, 300); // é˜²æŠ–300ms

        setDebounceTimer(timer);

        return () => {
            if (debounceTimer) {
                clearTimeout(debounceTimer);
            }
        };
    }, [keyword]);

    const performSearch = async (searchKeyword: string) => {
        setLoading(true);
        try {
            const response = await fetch(
                `/api/knowledge-graph/search?keyword=${encodeURIComponent(
                    searchKeyword
                )}`
            );
            const data = await response.json();
            setResults(data.items || []);
        } catch (error) {
            console.error('æœç´¢å¤±è´¥:', error);
        } finally {
            setLoading(false);
        }
    };

    const getTypeColor = (type: string): string => {
        const colorMap: Record<string, string> = {
            Project: 'blue',
            Process: 'green',
            Archive: 'orange',
            Department: 'purple',
            Person: 'pink',
        };
        return colorMap[type] || 'default';
    };

    const getPriorityColor = (priority?: string): string => {
        const colorMap: Record<string, string> = {
            é«˜: 'red',
            ä¸­: 'orange',
            ä½: 'blue',
        };
        return colorMap[priority || ''] || 'default';
    };

    return (
        <div>
            <Input
                placeholder="æœç´¢èŠ‚ç‚¹åç§°æˆ–æ ‡ç­¾ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰"
                prefix={<SearchOutlined />}
                value={keyword}
                onChange={(e) => setKeyword(e.target.value)}
                allowClear
            />
            <Spin spinning={loading}>
                <List
                    style={{
                        marginTop: 16,
                        maxHeight: '600px',
                        overflowY: 'auto',
                    }}
                    dataSource={results}
                    locale={{ emptyText: <Empty description="æš‚æ— æœç´¢ç»“æœ" /> }}
                    renderItem={(item) => (
                        <List.Item
                            style={{ cursor: 'pointer' }}
                            onClick={() => onSelect(item.id)}
                        >
                            <List.Item.Meta
                                title={
                                    <div>
                                        <span
                                            dangerouslySetInnerHTML={{
                                                __html:
                                                    item.highlight?.name ||
                                                    item.name,
                                            }}
                                        />
                                        <Tag
                                            color={getTypeColor(item.type)}
                                            style={{ marginLeft: 8 }}
                                        >
                                            {item.type}
                                        </Tag>
                                        {item.businessPriority && (
                                            <Tag
                                                color={getPriorityColor(
                                                    item.businessPriority
                                                )}
                                            >
                                                {item.businessPriority}ä¼˜å…ˆçº§
                                            </Tag>
                                        )}
                                    </div>
                                }
                                description={
                                    <div>
                                        <div>
                                            åŒ¹é…åº¦:{' '}
                                            {(item.matchScore * 100).toFixed(0)}
                                            %
                                        </div>
                                        <div>
                                            å¯†çº§:{' '}
                                            {item.securityLevel || 'æœªè®¾ç½®'}
                                        </div>
                                        <div>
                                            æ›´æ–°æ—¶é—´:{' '}
                                            {new Date(
                                                item.updatedTime
                                            ).toLocaleString()}
                                        </div>
                                    </div>
                                }
                            />
                        </List.Item>
                    )}
                />
            </Spin>
        </div>
    );
};

export default NodeSearchPanel;
```

#### 6.1.3 æ—¶é—´è½´ç»„ä»¶

```tsx
// TimelineView.tsx
import React, { useEffect, useState } from 'react';
import { Timeline, Card, Statistic, Row, Col, Select } from 'antd';
import { ClockCircleOutlined } from '@ant-design/icons';

interface TimelineSnapshot {
    stage: string;
    stageTime: string;
    entityCounts: Record<string, number>;
    relationshipCounts: Record<string, number>;
    businessStatus: string;
    changes: {
        newEntities: number;
        newRelationships: number;
        updatedEntities: number;
    };
}

const TimelineView: React.FC = () => {
    const [snapshots, setSnapshots] = useState<TimelineSnapshot[]>([]);
    const [loading, setLoading] = useState(false);
    const [granularity, setGranularity] = useState<'day' | 'week' | 'month'>(
        'day'
    );

    useEffect(() => {
        loadTimelineData();
    }, [granularity]);

    const loadTimelineData = async () => {
        setLoading(true);
        try {
            const response = await fetch(
                `/api/knowledge-graph/timeline?granularity=${granularity}`
            );
            const data = await response.json();
            setSnapshots(data.timeline || []);
        } catch (error) {
            console.error('åŠ è½½æ—¶é—´è½´æ•°æ®å¤±è´¥:', error);
        } finally {
            setLoading(false);
        }
    };

    const getTotalEntities = (counts: Record<string, number>): number => {
        return Object.values(counts).reduce((sum, count) => sum + count, 0);
    };

    const getTotalRelationships = (counts: Record<string, number>): number => {
        return Object.values(counts).reduce((sum, count) => sum + count, 0);
    };

    return (
        <Card
            title="ä¸šåŠ¡æ—¶é—´è½´"
            extra={
                <Select
                    value={granularity}
                    onChange={setGranularity}
                    style={{ width: 120 }}
                >
                    <Select.Option value="day">æŒ‰å¤©</Select.Option>
                    <Select.Option value="week">æŒ‰å‘¨</Select.Option>
                    <Select.Option value="month">æŒ‰æœˆ</Select.Option>
                </Select>
            }
        >
            <Timeline mode="left">
                {snapshots.map((snapshot, index) => (
                    <Timeline.Item
                        key={index}
                        dot={
                            <ClockCircleOutlined style={{ fontSize: '16px' }} />
                        }
                    >
                        <Card size="small">
                            <div style={{ marginBottom: 8 }}>
                                <strong>{snapshot.stage}</strong>
                                <span style={{ marginLeft: 16, color: '#999' }}>
                                    {new Date(
                                        snapshot.stageTime
                                    ).toLocaleString()}
                                </span>
                            </div>
                            <Row gutter={16}>
                                <Col span={6}>
                                    <Statistic
                                        title="å®ä½“æ€»æ•°"
                                        value={getTotalEntities(
                                            snapshot.entityCounts
                                        )}
                                    />
                                </Col>
                                <Col span={6}>
                                    <Statistic
                                        title="å…³ç³»æ€»æ•°"
                                        value={getTotalRelationships(
                                            snapshot.relationshipCounts
                                        )}
                                    />
                                </Col>
                                <Col span={6}>
                                    <Statistic
                                        title="æ–°å¢å®ä½“"
                                        value={snapshot.changes.newEntities}
                                        valueStyle={{ color: '#3f8600' }}
                                    />
                                </Col>
                                <Col span={6}>
                                    <Statistic
                                        title="æ–°å¢å…³ç³»"
                                        value={
                                            snapshot.changes.newRelationships
                                        }
                                        valueStyle={{ color: '#3f8600' }}
                                    />
                                </Col>
                            </Row>
                            <div style={{ marginTop: 8 }}>
                                <strong>ä¸šåŠ¡çŠ¶æ€:</strong>{' '}
                                {snapshot.businessStatus}
                            </div>
                            <div style={{ marginTop: 8 }}>
                                <strong>å®ä½“åˆ†å¸ƒ:</strong>
                                {Object.entries(snapshot.entityCounts).map(
                                    ([type, count]) => (
                                        <span
                                            key={type}
                                            style={{ marginLeft: 8 }}
                                        >
                                            {type}: {count}
                                        </span>
                                    )
                                )}
                            </div>
                        </Card>
                    </Timeline.Item>
                ))}
            </Timeline>
        </Card>
    );
};

export default TimelineView;
```

#### 6.1.4 èŠ‚ç‚¹è¯¦æƒ…é¢æ¿

```tsx
// NodeDetailPanel.tsx
import React, { useEffect, useState } from 'react';
import { Drawer, Descriptions, Tag, Alert, List, Card, Tabs } from 'antd';
import { WarningOutlined } from '@ant-design/icons';

interface EntityDetail {
    id: string;
    type: string;
    name: string;
    description?: string;
    securityLevel?: string;
    businessPriority?: string;
    createdTime: string;
    updatedTime?: string;
    properties: Record<string, any>;
    tags: string[];
    relationships: {
        outgoing: Array<{
            type: string;
            targetEntity: { id: string; name: string; type: string };
        }>;
        incoming: Array<{
            type: string;
            sourceEntity: { id: string; name: string; type: string };
        }>;
    };
    impactAnalysis?: {
        impactRadius: number;
        affectedNodeCount: number;
        businessImpact?: {
            severity: string;
            affectedBusinessProcesses?: number;
            dataIntegrityRisk: string;
            complianceRisk: string;
            operationalImpact?: {
                affectedCatalogues: number;
                affectedFiles: number;
                estimatedRecoveryTime: string;
                complexity: string;
            };
        };
        riskLevel: string;
        mitigationSuggestions: string[];
    };
}

const NodeDetailPanel: React.FC<{
    entityId: string | null;
    visible: boolean;
    onClose: () => void;
    onEntityClick: (entityId: string) => void;
}> = ({ entityId, visible, onClose, onEntityClick }) => {
    const [detail, setDetail] = useState<EntityDetail | null>(null);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (entityId && visible) {
            loadEntityDetail(entityId);
        }
    }, [entityId, visible]);

    const loadEntityDetail = async (id: string) => {
        setLoading(true);
        try {
            const response = await fetch(`/api/knowledge-graph/entities/${id}`);
            const data = await response.json();
            setDetail(data);
        } catch (error) {
            console.error('åŠ è½½å®ä½“è¯¦æƒ…å¤±è´¥:', error);
        } finally {
            setLoading(false);
        }
    };

    const getRiskLevelColor = (level: string): string => {
        const colorMap: Record<string, string> = {
            HIGH: 'red',
            MEDIUM: 'orange',
            LOW: 'blue',
        };
        return colorMap[level] || 'default';
    };

    if (!detail) return null;

    return (
        <Drawer
            title={detail.name}
            placement="right"
            width={600}
            open={visible}
            onClose={onClose}
            loading={loading}
        >
            <Tabs defaultActiveKey="basic">
                <Tabs.TabPane tab="åŸºæœ¬ä¿¡æ¯" key="basic">
                    <Descriptions column={1} bordered>
                        <Descriptions.Item label="å®ä½“ç±»å‹">
                            <Tag>{detail.type}</Tag>
                        </Descriptions.Item>
                        <Descriptions.Item label="åç§°">
                            {detail.name}
                        </Descriptions.Item>
                        <Descriptions.Item label="æè¿°">
                            {detail.description || 'æ— '}
                        </Descriptions.Item>
                        <Descriptions.Item label="å¯†çº§">
                            {detail.securityLevel || 'æœªè®¾ç½®'}
                        </Descriptions.Item>
                        <Descriptions.Item label="ä¸šåŠ¡ä¼˜å…ˆçº§">
                            {detail.businessPriority ? (
                                <Tag
                                    color={
                                        detail.businessPriority === 'é«˜'
                                            ? 'red'
                                            : 'blue'
                                    }
                                >
                                    {detail.businessPriority}
                                </Tag>
                            ) : (
                                'æœªè®¾ç½®'
                            )}
                        </Descriptions.Item>
                        <Descriptions.Item label="æ ‡ç­¾">
                            {detail.tags.map((tag) => (
                                <Tag key={tag}>{tag}</Tag>
                            ))}
                        </Descriptions.Item>
                        <Descriptions.Item label="åˆ›å»ºæ—¶é—´">
                            {new Date(detail.createdTime).toLocaleString()}
                        </Descriptions.Item>
                        <Descriptions.Item label="æ›´æ–°æ—¶é—´">
                            {detail.updatedTime
                                ? new Date(detail.updatedTime).toLocaleString()
                                : 'æ— '}
                        </Descriptions.Item>
                    </Descriptions>

                    {Object.keys(detail.properties).length > 0 && (
                        <Card title="ä¸šåŠ¡ä¸“å±ä¿¡æ¯" style={{ marginTop: 16 }}>
                            <Descriptions column={1}>
                                {Object.entries(detail.properties).map(
                                    ([key, value]) => (
                                        <Descriptions.Item
                                            key={key}
                                            label={key}
                                        >
                                            {String(value)}
                                        </Descriptions.Item>
                                    )
                                )}
                            </Descriptions>
                        </Card>
                    )}
                </Tabs.TabPane>

                <Tabs.TabPane tab="å…³ç³»ç½‘ç»œ" key="relationships">
                    <Card title="å‡ºè¾¹å…³ç³»" style={{ marginBottom: 16 }}>
                        <List
                            dataSource={detail.relationships.outgoing}
                            renderItem={(rel) => (
                                <List.Item
                                    style={{ cursor: 'pointer' }}
                                    onClick={() =>
                                        onEntityClick(rel.targetEntity.id)
                                    }
                                >
                                    <List.Item.Meta
                                        title={
                                            <div>
                                                <Tag>{rel.type}</Tag>
                                                <span style={{ marginLeft: 8 }}>
                                                    {rel.targetEntity.name}
                                                </span>
                                                <Tag
                                                    color="blue"
                                                    style={{ marginLeft: 8 }}
                                                >
                                                    {rel.targetEntity.type}
                                                </Tag>
                                            </div>
                                        }
                                    />
                                </List.Item>
                            )}
                        />
                    </Card>
                    <Card title="å…¥è¾¹å…³ç³»">
                        <List
                            dataSource={detail.relationships.incoming}
                            renderItem={(rel) => (
                                <List.Item
                                    style={{ cursor: 'pointer' }}
                                    onClick={() =>
                                        onEntityClick(rel.sourceEntity.id)
                                    }
                                >
                                    <List.Item.Meta
                                        title={
                                            <div>
                                                <Tag>{rel.type}</Tag>
                                                <span style={{ marginLeft: 8 }}>
                                                    {rel.sourceEntity.name}
                                                </span>
                                                <Tag
                                                    color="blue"
                                                    style={{ marginLeft: 8 }}
                                                >
                                                    {rel.sourceEntity.type}
                                                </Tag>
                                            </div>
                                        }
                                    />
                                </List.Item>
                            )}
                        />
                    </Card>
                </Tabs.TabPane>

                {detail.impactAnalysis && (
                    <Tabs.TabPane tab="å½±å“åˆ†æ" key="impact">
                        <Alert
                            message={`é£é™©ç­‰çº§: ${detail.impactAnalysis.riskLevel}`}
                            type={
                                detail.impactAnalysis.riskLevel === 'HIGH'
                                    ? 'error'
                                    : detail.impactAnalysis.riskLevel ===
                                      'MEDIUM'
                                    ? 'warning'
                                    : 'info'
                            }
                            icon={<WarningOutlined />}
                            style={{ marginBottom: 16 }}
                        />
                        <Descriptions column={1} bordered>
                            <Descriptions.Item label="å½±å“åŠå¾„">
                                {detail.impactAnalysis.impactRadius} è·³
                            </Descriptions.Item>
                            <Descriptions.Item label="å—å½±å“èŠ‚ç‚¹æ•°">
                                {detail.impactAnalysis.affectedNodeCount}
                            </Descriptions.Item>
                            {detail.impactAnalysis.businessImpact && (
                                <>
                                    <Descriptions.Item label="ä¸šåŠ¡å½±å“ç­‰çº§">
                                        <Tag
                                            color={
                                                detail.impactAnalysis
                                                    .businessImpact.severity ===
                                                'HIGH'
                                                    ? 'red'
                                                    : detail.impactAnalysis
                                                          .businessImpact
                                                          .severity === 'MEDIUM'
                                                    ? 'orange'
                                                    : 'blue'
                                            }
                                        >
                                            {
                                                detail.impactAnalysis
                                                    .businessImpact.severity
                                            }
                                        </Tag>
                                    </Descriptions.Item>
                                    <Descriptions.Item label="æ•°æ®å®Œæ•´æ€§é£é™©">
                                        <Tag
                                            color={
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .dataIntegrityRisk ===
                                                'HIGH'
                                                    ? 'red'
                                                    : detail.impactAnalysis
                                                          .businessImpact
                                                          .dataIntegrityRisk ===
                                                      'MEDIUM'
                                                    ? 'orange'
                                                    : 'blue'
                                            }
                                        >
                                            {
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .dataIntegrityRisk
                                            }
                                        </Tag>
                                    </Descriptions.Item>
                                    <Descriptions.Item label="åˆè§„æ€§é£é™©">
                                        <Tag
                                            color={
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .complianceRisk === 'HIGH'
                                                    ? 'red'
                                                    : detail.impactAnalysis
                                                          .businessImpact
                                                          .complianceRisk ===
                                                      'MEDIUM'
                                                    ? 'orange'
                                                    : 'blue'
                                            }
                                        >
                                            {
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .complianceRisk
                                            }
                                        </Tag>
                                    </Descriptions.Item>
                                    {detail.impactAnalysis.businessImpact
                                        .operationalImpact && (
                                        <Descriptions.Item label="æ“ä½œå½±å“">
                                            å—å½±å“åˆ†ç±»:{' '}
                                            {
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .operationalImpact
                                                    .affectedCatalogues
                                            }{' '}
                                            | å—å½±å“æ–‡ä»¶:{' '}
                                            {
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .operationalImpact
                                                    .affectedFiles
                                            }{' '}
                                            | é¢„è®¡æ¢å¤æ—¶é—´:{' '}
                                            {
                                                detail.impactAnalysis
                                                    .businessImpact
                                                    .operationalImpact
                                                    .estimatedRecoveryTime
                                            }
                                        </Descriptions.Item>
                                    )}
                                </>
                            )}
                        </Descriptions>
                        {detail.impactAnalysis.mitigationSuggestions.length >
                            0 && (
                            <Card title="åº”å¯¹å»ºè®®" style={{ marginTop: 16 }}>
                                <List
                                    dataSource={
                                        detail.impactAnalysis
                                            .mitigationSuggestions
                                    }
                                    renderItem={(suggestion, index) => (
                                        <List.Item>
                                            {index + 1}. {suggestion}
                                        </List.Item>
                                    )}
                                />
                            </Card>
                        )}
                    </Tabs.TabPane>
                )}
            </Tabs>
        </Drawer>
    );
};

export default NodeDetailPanel;
```

#### 6.1.5 é£é™©é¢„è­¦ç»„ä»¶

```tsx
// RiskAlertPanel.tsx
import React, { useEffect, useState } from 'react';
import { Card, List, Tag, Badge, Button, Space, Modal } from 'antd';
import { WarningOutlined, BellOutlined } from '@ant-design/icons';

interface RiskAlert {
    id: string;
    entityId: string;
    entityName: string;
    entityType: string;
    riskLevel: 'HIGH' | 'MEDIUM' | 'LOW';
    riskType: string;
    riskDescription: string;
    affectedEntityCount: number;
    businessImpact?: {
        severity: string;
        dataIntegrityRisk: string;
        complianceRisk: string;
        operationalImpact?: {
            affectedCatalogues: number;
            affectedFiles: number;
            estimatedRecoveryTime: string;
            complexity: string;
        };
    };
    mitigationSuggestion: string;
    responsiblePersonName?: string;
    status: 'ACTIVE' | 'ACKNOWLEDGED' | 'RESOLVED';
    createdTime: string;
}

const RiskAlertPanel: React.FC<{
    fixed?: boolean;
    onAlertClick?: (alert: RiskAlert) => void;
}> = ({ fixed = false, onAlertClick }) => {
    const [alerts, setAlerts] = useState<RiskAlert[]>([]);
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        loadRiskAlerts();
        // å®šæ—¶åˆ·æ–°
        const interval = setInterval(loadRiskAlerts, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
        return () => clearInterval(interval);
    }, []);

    const loadRiskAlerts = async () => {
        setLoading(true);
        try {
            const response = await fetch(
                '/api/knowledge-graph/risk-alerts?status=ACTIVE'
            );
            const data = await response.json();
            setAlerts(data.items || []);
        } catch (error) {
            console.error('åŠ è½½é£é™©é¢„è­¦å¤±è´¥:', error);
        } finally {
            setLoading(false);
        }
    };

    const handleNotify = async (alert: RiskAlert) => {
        try {
            // è°ƒç”¨é€šçŸ¥API
            await fetch(`/api/knowledge-graph/risk-alerts/${alert.id}/notify`, {
                method: 'POST',
            });
            Modal.success({
                title: 'é€šçŸ¥æˆåŠŸ',
                content: `å·²é€šçŸ¥è´£ä»»äºº: ${
                    alert.responsiblePersonName || 'æœªæŒ‡å®š'
                }`,
            });
        } catch (error) {
            Modal.error({ title: 'é€šçŸ¥å¤±è´¥', content: 'è¯·ç¨åé‡è¯•' });
        }
    };

    const getRiskLevelColor = (level: string): string => {
        const colorMap: Record<string, string> = {
            HIGH: 'red',
            MEDIUM: 'orange',
            LOW: 'blue',
        };
        return colorMap[level] || 'default';
    };

    const getRiskLevelText = (level: string): string => {
        const textMap: Record<string, string> = {
            HIGH: 'é«˜',
            MEDIUM: 'ä¸­',
            LOW: 'ä½',
        };
        return textMap[level] || level;
    };

    const highRiskCount = alerts.filter((a) => a.riskLevel === 'HIGH').length;
    const mediumRiskCount = alerts.filter(
        (a) => a.riskLevel === 'MEDIUM'
    ).length;
    const lowRiskCount = alerts.filter((a) => a.riskLevel === 'LOW').length;

    return (
        <Card
            title={
                <Space>
                    <WarningOutlined />
                    <span>é£é™©é¢„è­¦</span>
                    <Badge
                        count={highRiskCount}
                        style={{ backgroundColor: '#ff4d4f' }}
                    />
                    <Badge
                        count={mediumRiskCount}
                        style={{ backgroundColor: '#ff9800' }}
                    />
                    <Badge
                        count={lowRiskCount}
                        style={{ backgroundColor: '#1890ff' }}
                    />
                </Space>
            }
            style={
                fixed
                    ? {
                          position: 'fixed',
                          top: 80,
                          right: 20,
                          width: 400,
                          zIndex: 1000,
                      }
                    : {}
            }
            loading={loading}
        >
            <List
                dataSource={alerts}
                renderItem={(alert) => (
                    <List.Item
                        style={{
                            cursor: 'pointer',
                            borderLeft: `4px solid ${
                                alert.riskLevel === 'HIGH'
                                    ? '#ff4d4f'
                                    : alert.riskLevel === 'MEDIUM'
                                    ? '#ff9800'
                                    : '#1890ff'
                            }`,
                            paddingLeft: 12,
                        }}
                        onClick={() => onAlertClick?.(alert)}
                    >
                        <List.Item.Meta
                            title={
                                <div>
                                    <Tag
                                        color={getRiskLevelColor(
                                            alert.riskLevel
                                        )}
                                    >
                                        {getRiskLevelText(alert.riskLevel)}é£é™©
                                    </Tag>
                                    <span style={{ marginLeft: 8 }}>
                                        {alert.entityName}
                                    </span>
                                    <Tag style={{ marginLeft: 8 }}>
                                        {alert.entityType}
                                    </Tag>
                                </div>
                            }
                            description={
                                <div>
                                    <div style={{ marginTop: 4 }}>
                                        {alert.riskDescription}
                                    </div>
                                    <div
                                        style={{
                                            marginTop: 4,
                                            fontSize: '12px',
                                            color: '#999',
                                        }}
                                    >
                                        å½±å“èŠ‚ç‚¹: {alert.affectedEntityCount} |
                                        {alert.businessImpact &&
                                            ` ä¸šåŠ¡å½±å“: ${alert.businessImpact.severity} | æ•°æ®å®Œæ•´æ€§é£é™©: ${alert.businessImpact.dataIntegrityRisk} |`}{' '}
                                        è´£ä»»äºº:{' '}
                                        {alert.responsiblePersonName ||
                                            'æœªæŒ‡å®š'}
                                    </div>
                                </div>
                            }
                        />
                        <Button
                            type="link"
                            icon={<BellOutlined />}
                            onClick={(e) => {
                                e.stopPropagation();
                                handleNotify(alert);
                            }}
                        >
                            é€šçŸ¥
                        </Button>
                    </List.Item>
                )}
            />
        </Card>
    );
};

export default RiskAlertPanel;
```

---

## 7. åç«¯å®ç°æ–¹æ¡ˆ

### 7.1 DTO å®šä¹‰

#### 7.1.1 ä¸šåŠ¡å½±å“ç›¸å…³ DTO

```csharp
// BusinessImpact.cs
public class BusinessImpact
{
    /// <summary>
    /// ä¸šåŠ¡å½±å“ä¸¥é‡ç¨‹åº¦ï¼ˆHIGH, MEDIUM, LOWï¼‰
    /// </summary>
    public string Severity { get; set; }

    /// <summary>
    /// å—å½±å“çš„ä¸šåŠ¡æµç¨‹æ•°é‡
    /// </summary>
    public int? AffectedBusinessProcesses { get; set; }

    /// <summary>
    /// æ•°æ®å®Œæ•´æ€§é£é™©ç­‰çº§ï¼ˆHIGH, MEDIUM, LOWï¼‰
    /// </summary>
    public string DataIntegrityRisk { get; set; }

    /// <summary>
    /// åˆè§„æ€§é£é™©ç­‰çº§ï¼ˆHIGH, MEDIUM, LOWï¼‰
    /// </summary>
    public string ComplianceRisk { get; set; }

    /// <summary>
    /// æ“ä½œå½±å“è¯¦æƒ…
    /// </summary>
    public OperationalImpact? OperationalImpact { get; set; }
}

// OperationalImpact.cs
public class OperationalImpact
{
    /// <summary>
    /// å—å½±å“çš„åˆ†ç±»æ•°é‡
    /// </summary>
    public int AffectedCatalogues { get; set; }

    /// <summary>
    /// å—å½±å“çš„æ–‡ä»¶æ•°é‡
    /// </summary>
    public int AffectedFiles { get; set; }

    /// <summary>
    /// é¢„è®¡æ¢å¤æ—¶é—´
    /// </summary>
    public string EstimatedRecoveryTime { get; set; }

    /// <summary>
    /// æ“ä½œå¤æ‚åº¦ï¼ˆHIGH, MEDIUM, LOWï¼‰
    /// </summary>
    public string Complexity { get; set; }
}
```

### 7.2 æœåŠ¡å±‚è®¾è®¡

#### 7.2.1 å›¾è°±æœåŠ¡æ¥å£

```csharp
// IKnowledgeGraphService.cs
public interface IKnowledgeGraphService
{
    /// <summary>
    /// è·å–å›¾è°±æ•°æ®
    /// </summary>
    Task<GraphDataDto> GetGraphDataAsync(GraphQueryInput input);

    /// <summary>
    /// è·å–å®ä½“è¯¦æƒ…
    /// </summary>
    Task<EntityDetailDto> GetEntityDetailAsync(Guid entityId);

    /// <summary>
    /// æœç´¢èŠ‚ç‚¹
    /// </summary>
    Task<PagedResultDto<SearchResultDto>> SearchNodesAsync(NodeSearchInput input);

    /// <summary>
    /// è·å–æ—¶é—´è½´æ•°æ®
    /// </summary>
    Task<TimelineDataDto> GetTimelineDataAsync(TimelineQueryInput input);

    /// <summary>
    /// è®¡ç®—å½±å“åˆ†æ
    /// </summary>
    Task<ImpactAnalysisResultDto> CalculateImpactAnalysisAsync(ImpactAnalysisInput input);

    /// <summary>
    /// è·å–é£é™©é¢„è­¦åˆ—è¡¨
    /// </summary>
    Task<PagedResultDto<RiskAlertDto>> GetRiskAlertsAsync(RiskAlertQueryInput input);

    /// <summary>
    /// åˆ›å»ºé£é™©é¢„è­¦
    /// </summary>
    Task<RiskAlertDto> CreateRiskAlertAsync(CreateRiskAlertInput input);

    /// <summary>
    /// ç¡®è®¤é£é™©é¢„è­¦
    /// </summary>
    Task AcknowledgeRiskAlertAsync(Guid alertId);

    /// <summary>
    /// è§£å†³é£é™©é¢„è­¦
    /// </summary>
    Task ResolveRiskAlertAsync(Guid alertId, string resolution);

    /// <summary>
    /// é€šçŸ¥é£é™©é¢„è­¦è´£ä»»äºº
    /// </summary>
    Task NotifyRiskAlertAsync(Guid alertId);
}
```

#### 7.1.2 DTO å®šä¹‰

> **âœ… å·²å®ç°**ï¼šä»¥ä¸‹ DTO å’Œæ¥å£å·²åœ¨é¡¹ç›®ä¸­åˆ›å»ºã€‚
>
> -   DTO æ–‡ä»¶ä½ç½®ï¼š`Hx.Abp.Attachment.Application.Contracts/KnowledgeGraph/`
>     -   `GraphQueryInput.cs` - å›¾æŸ¥è¯¢è¾“å…¥å‚æ•°
>     -   `GraphDataDto.cs` - å›¾æ•°æ®å“åº”
>     -   `NodeDto.cs` - èŠ‚ç‚¹æ•°æ®
>     -   `EdgeDto.cs` - è¾¹æ•°æ®
>     -   `GraphStatisticsDto.cs` - ç»Ÿè®¡ä¿¡æ¯
> -   æ¥å£æ–‡ä»¶ä½ç½®ï¼š`Hx.Abp.Attachment.Application.Contracts/KnowledgeGraph/IKnowledgeGraphAppService.cs`
> -   æœåŠ¡å®ç°æ–‡ä»¶ä½ç½®ï¼š`Hx.Abp.Attachment.Application/KnowledgeGraphAppService.cs`

```csharp
// GraphQueryInput.cs - å›¾æŸ¥è¯¢è¾“å…¥å‚æ•°
public class GraphQueryInput
{
    /// <summary>
    /// ä¸­å¿ƒå®ä½“IDï¼ˆå¯é€‰ï¼Œä»¥è¯¥å®ä½“ä¸ºä¸­å¿ƒå±•å¼€æŸ¥è¯¢ï¼‰
    /// </summary>
    public Guid? CenterEntityId { get; set; }

    /// <summary>
    /// å®ä½“ç±»å‹è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    public List<string>? EntityTypes { get; set; }

    /// <summary>
    /// å…³ç³»ç±»å‹è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    public List<string>? RelationshipTypes { get; set; }

    /// <summary>
    /// æŸ¥è¯¢æ·±åº¦ï¼ˆé»˜è®¤ 2ï¼‰
    /// </summary>
    public int? Depth { get; set; } = 2;

    /// <summary>
    /// æœ€å¤§èŠ‚ç‚¹æ•°ï¼ˆé»˜è®¤ 500ï¼‰
    /// </summary>
    public int? MaxNodes { get; set; } = 500;

    /// <summary>
    /// çŠ¶æ€è¿‡æ»¤ï¼ˆå¯é€‰ï¼‰
    /// </summary>
    public string? Status { get; set; }
}

// GraphDataDto.cs - å›¾æ•°æ®å“åº”
public class GraphDataDto
{
    /// <summary>
    /// èŠ‚ç‚¹åˆ—è¡¨
    /// </summary>
    public List<NodeDto> Nodes { get; set; } = new();

    /// <summary>
    /// è¾¹åˆ—è¡¨
    /// </summary>
    public List<EdgeDto> Edges { get; set; } = new();

    /// <summary>
    /// ç»Ÿè®¡ä¿¡æ¯
    /// </summary>
    public GraphStatisticsDto? Statistics { get; set; }

    /// <summary>
    /// æŸ¥è¯¢æ‰§è¡Œæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    /// </summary>
    public int QueryTimeMs { get; set; }
}

// NodeDto.cs - èŠ‚ç‚¹æ•°æ®
public class NodeDto
{
    /// <summary>
    /// å®ä½“IDï¼ˆå…³è”åˆ°ç°æœ‰å®ä½“è¡¨ï¼‰
    /// </summary>
    public Guid EntityId { get; set; }

    /// <summary>
    /// å®ä½“ç±»å‹ï¼ˆCatalogue, Person, Department, BusinessEntity, Workflowï¼‰
    /// </summary>
    public string Type { get; set; } = string.Empty;

    /// <summary>
    /// å®ä½“åç§°
    /// </summary>
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// æ ‡ç­¾åˆ—è¡¨
    /// </summary>
    public List<string> Tags { get; set; } = new();

    /// <summary>
    /// èŠ‚ç‚¹å±æ€§
    /// </summary>
    public Dictionary<string, object> Properties { get; set; } = new();

    /// <summary>
    /// å®‰å…¨çº§åˆ«
    /// </summary>
    public string? SecurityLevel { get; set; }

    /// <summary>
    /// æ›´æ–°æ—¶é—´
    /// </summary>
    public DateTime UpdatedTime { get; set; }
}

// EdgeDto.cs - è¾¹æ•°æ®
public class EdgeDto
{
    /// <summary>
    /// æºèŠ‚ç‚¹ID
    /// </summary>
    public Guid Source { get; set; }

    /// <summary>
    /// ç›®æ ‡èŠ‚ç‚¹ID
    /// </summary>
    public Guid Target { get; set; }

    /// <summary>
    /// å…³ç³»ç±»å‹
    /// </summary>
    public string Type { get; set; } = string.Empty;

    /// <summary>
    /// è§’è‰²ï¼ˆç”¨äºæŠ½è±¡å…³ç³»ç±»å‹ï¼‰
    /// </summary>
    public string? Role { get; set; }

    /// <summary>
    /// è¯­ä¹‰ç±»å‹ï¼ˆç”¨äºæŠ½è±¡å…³ç³»ç±»å‹ï¼‰
    /// </summary>
    public string? SemanticType { get; set; }

    /// <summary>
    /// å…³ç³»æƒé‡
    /// </summary>
    public double Weight { get; set; } = 1.0;

    /// <summary>
    /// å…³ç³»å±æ€§
    /// </summary>
    public Dictionary<string, object> Properties { get; set; } = new();
}

// GraphStatisticsDto.cs - ç»Ÿè®¡ä¿¡æ¯
public class GraphStatisticsDto
{
    /// <summary>
    /// æ€»èŠ‚ç‚¹æ•°
    /// </summary>
    public int TotalNodes { get; set; }

    /// <summary>
    /// æ€»è¾¹æ•°
    /// </summary>
    public int TotalEdges { get; set; }

    /// <summary>
    /// èŠ‚ç‚¹ç±»å‹ç»Ÿè®¡
    /// </summary>
    public Dictionary<string, int> NodeTypes { get; set; } = new();

    /// <summary>
    /// è¾¹ç±»å‹ç»Ÿè®¡
    /// </summary>
    public Dictionary<string, int> EdgeTypes { get; set; } = new();
}
```

#### 7.1.3 å›¾è°±æœåŠ¡å®ç°ï¼ˆApache AGE ç‰ˆæœ¬ï¼‰

> **âœ… å·²å®ç°**ï¼šæœåŠ¡å®ç°å·²åœ¨é¡¹ç›®ä¸­åˆ›å»ºã€‚
>
> -   æ–‡ä»¶ä½ç½®ï¼š`Hx.Abp.Attachment.Application/KnowledgeGraphAppService.cs`
> -   æ¥å£ï¼š`IKnowledgeGraphAppService`
> -   å·²æ³¨å†Œåˆ°ä¾èµ–æ³¨å…¥å®¹å™¨

```csharp
// KnowledgeGraphAppService.cs
// æ–‡ä»¶ä½ç½®ï¼šsrc/Hx.Abp.Attachment.Application/Hx/Abp/Attachment/Application/KnowledgeGraphAppService.cs
using Npgsql;
using System.Text.Json;
using System.Text;
using Microsoft.EntityFrameworkCore;
using Volo.Abp.Application.Services;
using Volo.Abp.Domain.Repositories;
using Volo.Abp.Uow;

public class KnowledgeGraphAppService : AttachmentService, IKnowledgeGraphAppService
{
    private readonly IDbContextProvider<AttachmentDbContext> _dbContextProvider;
    private readonly IRepository<AttachCatalogue, Guid> _catalogueRepository;
    private readonly IRepository<KnowledgeGraphRelationship, Guid> _relationshipRepository;
    private readonly AttachCataloguePermissionChecker _permissionChecker;
    private readonly ICurrentUser _currentUser;
    private const string GraphName = "kg_graph";

    /// <summary>
    /// è·å–å›¾è°±æ•°æ®ï¼ˆApache AGE å®ç°ï¼‰
    /// åŸºäºé¡¹ç›®å®ä½“å’Œå…³ç³»è®¾è®¡ï¼Œæ”¯æŒæƒé™æ§åˆ¶å’Œæ€§èƒ½ä¼˜åŒ–
    /// </summary>
    public async Task<GraphDataDto> GetGraphDataAsync(GraphQueryInput input)
    {
        var stopwatch = Stopwatch.StartNew();
        var dbContext = await _dbContextProvider.GetDbContextAsync();
        var connection = dbContext.Database.GetDbConnection() as NpgsqlConnection;

        if (connection == null)
            throw new InvalidOperationException("Database connection is not NpgsqlConnection");

        // ç¡®ä¿è¿æ¥å·²æ‰“å¼€
        if (connection.State != System.Data.ConnectionState.Open)
        {
            await connection.OpenAsync();
        }

        var nodes = new List<NodeDto>();
        var edges = new List<EdgeDto>();
        var nodeMap = new Dictionary<Guid, NodeDto>(); // ç”¨äºå»é‡å’Œå¿«é€ŸæŸ¥æ‰¾
        var edgeSet = new HashSet<string>(); // ç”¨äºå…³ç³»å»é‡

        var userId = CurrentUser.Id ?? Guid.Empty;
        var userRoles = await GetUserRolesAsync(userId);

        try
        {
            // æ„å»º Cypher æŸ¥è¯¢
            var cypherQuery = BuildCypherQuery(input);
            var parameters = BuildParameters(input);

            // æ„å»º Apache AGE SQL æŸ¥è¯¢
            // æ³¨æ„ï¼šApache AGE ä½¿ç”¨ cypher() å‡½æ•°æ‰§è¡Œ Cypher æŸ¥è¯¢
            // è¯­æ³•ï¼šcypher('graph_name', $$cypher_query$$, '{"param": "value"}')
            // åœ¨ C# ä¸­ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢é¿å… SQL æ³¨å…¥
            var paramsJson = JsonSerializer.Serialize(parameters);

            var sqlQuery = @"
                SELECT * FROM cypher(@graphName, @cypherQuery, @params::jsonb) AS (result agtype)";

            await using var command = new NpgsqlCommand(sqlQuery, connection);
            command.Parameters.AddWithValue("graphName", GraphName);
            command.Parameters.AddWithValue("cypherQuery", cypherQuery);
            command.Parameters.AddWithValue("params", NpgsqlTypes.NpgsqlDbType.Jsonb, paramsJson);

            // è®¾ç½®å‘½ä»¤è¶…æ—¶ï¼ˆé˜²æ­¢é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢ï¼‰
            command.CommandTimeout = 30;

            await using var reader = await command.ExecuteReaderAsync();

            // è§£ææŸ¥è¯¢ç»“æœ
            while (await reader.ReadAsync())
            {
                try
                {
                    // Apache AGE è¿”å› agtypeï¼Œéœ€è¦è§£æä¸º JSON
                    var agtypeValue = reader.GetFieldValue<string>(0);
                    var resultJson = JsonDocument.Parse(agtypeValue);
                    var resultElement = resultJson.RootElement;

                    // è§£æèŠ‚ç‚¹æ•°æ®
                    if (resultElement.TryGetProperty("n", out var nodeElement))
                    {
                        var nodeDto = await MapToNodeDtoAsync(nodeElement);

                        if (nodeDto != null && !nodeMap.ContainsKey(nodeDto.EntityId))
                        {
                            // æƒé™æ£€æŸ¥ï¼šåˆ©ç”¨ AttachCatalogue.Permissions è¿‡æ»¤æ— æƒé™çš„å®ä½“
                            if (await CheckEntityAccessAsync(
                                nodeDto.EntityId,
                                nodeDto.Type,
                                userId,
                                PermissionAction.View,
                                userRoles))
                            {
                                nodes.Add(nodeDto);
                                nodeMap[nodeDto.EntityId] = nodeDto;
                            }
                        }
                    }

                    // è§£æå…³ç³»æ•°æ®
                    if (resultElement.TryGetProperty("relationships", out var relsElement))
                    {
                        if (relsElement.ValueKind == JsonValueKind.Array)
                        {
                            foreach (var relItem in relsElement.EnumerateArray())
                            {
                                await ParseRelationshipAsync(relItem, nodeMap, edges, edgeSet, userId, userRoles);
                            }
                        }
                    }
                    // å¦‚æœå…³ç³»åœ¨å•ç‹¬çš„å­—æ®µä¸­
                    else if (resultElement.TryGetProperty("r", out var relElement))
                    {
                        await ParseRelationshipAsync(relElement, nodeMap, edges, edgeSet, userId, userRoles);
                    }
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "è§£æå›¾æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè·³è¿‡è¯¥è®°å½•");
                    // ç»§ç»­å¤„ç†ä¸‹ä¸€æ¡è®°å½•
                }
            }

            // å¦‚æœæŒ‡å®šäº†ä¸­å¿ƒå®ä½“ï¼Œç¡®ä¿ä¸­å¿ƒèŠ‚ç‚¹åœ¨ç»“æœä¸­
            if (input.CenterEntityId.HasValue && !nodeMap.ContainsKey(input.CenterEntityId.Value))
            {
                var centerNode = await LoadEntityNodeAsync(input.CenterEntityId.Value, userId, userRoles);
                if (centerNode != null)
                {
                    nodes.Add(centerNode);
                    nodeMap[centerNode.EntityId] = centerNode;
                }
            }

            stopwatch.Stop();

            // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
            var statistics = CalculateStatistics(nodes, edges);

            // è®°å½•å®¡è®¡æ—¥å¿—
            await LogGraphQueryAsync(input, nodes.Count, edges.Count, stopwatch.ElapsedMilliseconds);

            return new GraphDataDto
            {
                Nodes = nodes,
                Edges = edges,
                Statistics = statistics,
                QueryTimeMs = (int)stopwatch.ElapsedMilliseconds
            };
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "è·å–å›¾æ•°æ®å¤±è´¥: {Input}", JsonSerializer.Serialize(input));
            throw;
        }
        finally
        {
            // NpgsqlConnection ç”± DbContext ç®¡ç†ï¼Œä¸éœ€è¦æ‰‹åŠ¨å…³é—­
            // ä½†å¦‚æœæ˜¯ä¸´æ—¶è¿æ¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œå…³é—­
        }
    }

    /// <summary>
    /// æ„å»º Cypher æŸ¥è¯¢è¯­å¥
    /// </summary>
    private string BuildCypherQuery(GraphQueryInput input)
    {
        var query = new StringBuilder();

        if (input.CenterEntityId.HasValue)
        {
            // ä»¥ä¸­å¿ƒå®ä½“ä¸ºä¸­å¿ƒå±•å¼€æŸ¥è¯¢
            var depth = input.Depth ?? 2;
            query.AppendLine($"MATCH path = (center:Entity {{id: $centerId}})-[*1..{depth}]-(related:Entity)");
            query.AppendLine("WHERE center.id = $centerId");

            // å®ä½“ç±»å‹è¿‡æ»¤
            if (input.EntityTypes?.Any() == true)
            {
                query.AppendLine("AND related.type IN $entityTypes");
            }

            query.AppendLine("WITH DISTINCT related as n, relationships(path) as rels");
            query.AppendLine("UNWIND rels as r");
            query.AppendLine("MATCH (source:Entity {id: startNode(r).id})");
            query.AppendLine("MATCH (target:Entity {id: endNode(r).id})");
            query.AppendLine("RETURN n, collect(DISTINCT {rel: r, source: source, target: target}) as relationships");
        }
        else
        {
            // å…¨å±€æŸ¥è¯¢
            query.AppendLine("MATCH (n:Entity)");

            var conditions = new List<string>();

            // å®ä½“ç±»å‹è¿‡æ»¤
            if (input.EntityTypes?.Any() == true)
            {
                conditions.Add("n.type IN $entityTypes");
            }

            // çŠ¶æ€è¿‡æ»¤ï¼ˆå¦‚æœæœ‰ï¼‰
            if (!string.IsNullOrEmpty(input.Status))
            {
                conditions.Add("n.status = $status");
            }

            if (conditions.Any())
            {
                query.AppendLine($"WHERE {string.Join(" AND ", conditions)}");
            }

            query.AppendLine("OPTIONAL MATCH (n)-[r]->(m:Entity)");
            query.AppendLine("RETURN n, collect(DISTINCT {rel: r, target: m}) as relationships");
        }

        // é™åˆ¶ç»“æœæ•°é‡
        query.AppendLine($"LIMIT {input.MaxNodes ?? 500}");

        return query.ToString();
    }

    /// <summary>
    /// æ„å»ºæŸ¥è¯¢å‚æ•°
    /// </summary>
    private Dictionary<string, object> BuildParameters(GraphQueryInput input)
    {
        var parameters = new Dictionary<string, object>();

        if (input.CenterEntityId.HasValue)
        {
            parameters["centerId"] = input.CenterEntityId.Value.ToString();
        }

        if (input.EntityTypes?.Any() == true)
        {
            parameters["entityTypes"] = input.EntityTypes;
        }

        if (!string.IsNullOrEmpty(input.Status))
        {
            parameters["status"] = input.Status;
        }

        return parameters;
    }

    /// <summary>
    /// ä» AGE ç»“æœæ˜ å°„åˆ° NodeDto
    /// </summary>
    private async Task<NodeDto?> MapToNodeDtoAsync(JsonElement nodeElement)
    {
        try
        {
            if (nodeElement.ValueKind != JsonValueKind.Object)
                return null;

            // è·å–èŠ‚ç‚¹ IDï¼ˆagtype ä¸­çš„ id å­—æ®µï¼‰
            if (!nodeElement.TryGetProperty("id", out var idElement))
                return null;

            var idString = idElement.GetString();
            if (string.IsNullOrEmpty(idString) || !Guid.TryParse(idString, out var entityId))
                return null;

            // è·å–èŠ‚ç‚¹ç±»å‹
            var entityType = nodeElement.TryGetProperty("type", out var typeElement)
                ? typeElement.GetString() ?? "Unknown"
                : "Unknown";

            // è·å–èŠ‚ç‚¹åç§°
            var name = nodeElement.TryGetProperty("name", out var nameElement)
                ? nameElement.GetString() ?? ""
                : "";

            // è·å–æ ‡ç­¾
            var tags = new List<string>();
            if (nodeElement.TryGetProperty("tags", out var tagsElement))
            {
                if (tagsElement.ValueKind == JsonValueKind.Array)
                {
                    foreach (var tag in tagsElement.EnumerateArray())
                    {
                        if (tag.ValueKind == JsonValueKind.String)
                            tags.Add(tag.GetString() ?? "");
                    }
                }
            }

            // è·å–å…¶ä»–å±æ€§
            var properties = new Dictionary<string, object>();
            foreach (var prop in nodeElement.EnumerateObject())
            {
                if (prop.Name != "id" && prop.Name != "type" && prop.Name != "name" && prop.Name != "tags")
                {
                    properties[prop.Name] = ExtractJsonValue(prop.Value);
                }
            }

            return new NodeDto
            {
                EntityId = entityId,
                Type = entityType,
                Name = name,
                Tags = tags,
                Properties = properties,
                SecurityLevel = properties.GetValueOrDefault("securityLevel")?.ToString(),
                UpdatedTime = properties.TryGetValue("updatedTime", out var updatedTime)
                    ? DateTime.TryParse(updatedTime.ToString(), out var dt) ? dt : DateTime.UtcNow
                    : DateTime.UtcNow
            };
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "æ˜ å°„èŠ‚ç‚¹æ•°æ®å¤±è´¥");
            return null;
        }
    }

    /// <summary>
    /// è§£æå…³ç³»æ•°æ®
    /// </summary>
    private async Task ParseRelationshipAsync(
        JsonElement relElement,
        Dictionary<Guid, NodeDto> nodeMap,
        List<EdgeDto> edges,
        HashSet<string> edgeSet,
        Guid userId,
        List<string> userRoles)
    {
        try
        {
            // è§£æå…³ç³»å¯¹è±¡ï¼ˆå¯èƒ½åŒ…å« rel, source, targetï¼‰
            JsonElement relData;
            JsonElement sourceElement;
            JsonElement targetElement;

            if (relElement.TryGetProperty("rel", out var relProp))
            {
                relData = relProp;
            }
            else
            {
                relData = relElement;
            }

            if (relElement.TryGetProperty("source", out var sourceProp))
            {
                sourceElement = sourceProp;
            }
            else if (relData.TryGetProperty("start", out var startProp))
            {
                sourceElement = startProp;
            }
            else
            {
                return; // æ— æ³•è§£ææºèŠ‚ç‚¹
            }

            if (relElement.TryGetProperty("target", out var targetProp))
            {
                targetElement = targetProp;
            }
            else if (relData.TryGetProperty("end", out var endProp))
            {
                targetElement = endProp;
            }
            else
            {
                return; // æ— æ³•è§£æç›®æ ‡èŠ‚ç‚¹
            }

            // è·å–æºå’Œç›®æ ‡èŠ‚ç‚¹ ID
            var sourceIdString = sourceElement.TryGetProperty("id", out var sourceIdProp)
                ? sourceIdProp.GetString()
                : null;
            var targetIdString = targetElement.TryGetProperty("id", out var targetIdProp)
                ? targetIdProp.GetString()
                : null;

            if (string.IsNullOrEmpty(sourceIdString) || string.IsNullOrEmpty(targetIdString))
                return;

            if (!Guid.TryParse(sourceIdString, out var sourceId) ||
                !Guid.TryParse(targetIdString, out var targetId))
                return;

            // æƒé™æ£€æŸ¥ï¼šç¡®ä¿æºå’Œç›®æ ‡èŠ‚ç‚¹éƒ½æœ‰æƒé™è®¿é—®
            var sourceType = sourceElement.TryGetProperty("type", out var sourceTypeProp)
                ? sourceTypeProp.GetString() ?? "Unknown"
                : "Unknown";
            var targetType = targetElement.TryGetProperty("type", out var targetTypeProp)
                ? targetTypeProp.GetString() ?? "Unknown"
                : "Unknown";

            if (!await CheckEntityAccessAsync(sourceId, sourceType, userId, PermissionAction.View, userRoles) ||
                !await CheckEntityAccessAsync(targetId, targetType, userId, PermissionAction.View, userRoles))
            {
                return; // æ— æƒé™è®¿é—®ï¼Œè·³è¿‡è¯¥å…³ç³»
            }

            // ç¡®ä¿èŠ‚ç‚¹åœ¨èŠ‚ç‚¹åˆ—è¡¨ä¸­
            if (!nodeMap.ContainsKey(sourceId))
            {
                var sourceNode = await MapToNodeDtoAsync(sourceElement);
                if (sourceNode != null)
                {
                    nodeMap[sourceId] = sourceNode;
                }
            }

            if (!nodeMap.ContainsKey(targetId))
            {
                var targetNode = await MapToNodeDtoAsync(targetElement);
                if (targetNode != null)
                {
                    nodeMap[targetId] = targetNode;
                }
            }

            // è·å–å…³ç³»ç±»å‹
            var relType = relData.TryGetProperty("type", out var typeProp)
                ? typeProp.GetString() ?? "RELATES_TO"
                : "RELATES_TO";

            // è·å–å…³ç³»å±æ€§
            var relProperties = new Dictionary<string, object>();
            var role = "";
            var semanticType = "";
            var weight = 1.0;

            foreach (var prop in relData.EnumerateObject())
            {
                if (prop.Name == "type")
                    continue;

                if (prop.Name == "role")
                {
                    role = prop.Value.GetString() ?? "";
                    relProperties["role"] = role;
                }
                else if (prop.Name == "semanticType")
                {
                    semanticType = prop.Value.GetString() ?? "";
                    relProperties["semanticType"] = semanticType;
                }
                else if (prop.Name == "weight")
                {
                    weight = prop.Value.GetDouble();
                    relProperties["weight"] = weight;
                }
                else
                {
                    relProperties[prop.Name] = ExtractJsonValue(prop.Value);
                }
            }

            // åˆ›å»ºå…³ç³»å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºå»é‡ï¼‰
            var edgeKey = $"{sourceId}_{targetId}_{relType}_{role}_{semanticType}";
            if (edgeSet.Contains(edgeKey))
                return; // å…³ç³»å·²å­˜åœ¨ï¼Œè·³è¿‡

            edgeSet.Add(edgeKey);

            // åˆ›å»ºå…³ç³» DTO
            var edge = new EdgeDto
            {
                Source = sourceId,
                Target = targetId,
                Type = relType,
                Role = string.IsNullOrEmpty(role) ? null : role,
                SemanticType = string.IsNullOrEmpty(semanticType) ? null : semanticType,
                Weight = weight,
                Properties = relProperties
            };

            edges.Add(edge);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "è§£æå…³ç³»æ•°æ®å¤±è´¥");
        }
    }

    /// <summary>
    /// åŠ è½½å®ä½“èŠ‚ç‚¹ï¼ˆç”¨äºä¸­å¿ƒèŠ‚ç‚¹ï¼‰
    /// </summary>
    private async Task<NodeDto?> LoadEntityNodeAsync(Guid entityId, Guid userId, List<string> userRoles)
    {
        try
        {
            // ä»ä¸šåŠ¡è¡¨åŠ è½½å®ä½“æ•°æ®
            // è¿™é‡Œå¯ä»¥æ ¹æ®å®ä½“ç±»å‹åŠ è½½ä¸åŒçš„å®ä½“
            // ç®€åŒ–å®ç°ï¼šä»å›¾æ•°æ®åº“æŸ¥è¯¢
            var dbContext = await _dbContextProvider.GetDbContextAsync();
            var connection = dbContext.Database.GetDbConnection() as NpgsqlConnection;

            if (connection == null || connection.State != System.Data.ConnectionState.Open)
                return null;

            var sqlQuery = $@"
                SELECT * FROM cypher('{GraphName}', $$
                    MATCH (n:Entity {{id: $id}})
                    RETURN n
                $$, $params) AS (result agtype)";

            await using var command = new NpgsqlCommand(sqlQuery, connection);
            command.Parameters.AddWithValue("cypherQuery", "MATCH (n:Entity {id: $id}) RETURN n");
            command.Parameters.AddWithValue("params", NpgsqlTypes.NpgsqlDbType.Jsonb,
                JsonSerializer.Serialize(new { id = entityId.ToString() }));

            await using var reader = await command.ExecuteReaderAsync();
            if (await reader.ReadAsync())
            {
                var agtypeValue = reader.GetFieldValue<string>(0);
                var resultJson = JsonDocument.Parse(agtypeValue);
                if (resultJson.RootElement.TryGetProperty("n", out var nodeElement))
                {
                    return await MapToNodeDtoAsync(nodeElement);
                }
            }

            return null;
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "åŠ è½½å®ä½“èŠ‚ç‚¹å¤±è´¥: {EntityId}", entityId);
            return null;
        }
    }

    /// <summary>
    /// æå– JSON å€¼
    /// </summary>
    private object ExtractJsonValue(JsonElement element)
    {
        return element.ValueKind switch
        {
            JsonValueKind.String => element.GetString() ?? "",
            JsonValueKind.Number => element.TryGetInt64(out var i64) ? i64 : element.GetDouble(),
            JsonValueKind.True => true,
            JsonValueKind.False => false,
            JsonValueKind.Null => null!,
            JsonValueKind.Array => element.EnumerateArray().Select(ExtractJsonValue).ToList(),
            JsonValueKind.Object => element.EnumerateObject()
                .ToDictionary(p => p.Name, p => ExtractJsonValue(p.Value)),
            _ => element.ToString()
        };
    }

    /// <summary>
    /// è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    /// </summary>
    private GraphStatisticsDto CalculateStatistics(List<NodeDto> nodes, List<EdgeDto> edges)
    {
        var nodeTypeCounts = nodes
            .GroupBy(n => n.Type)
            .ToDictionary(g => g.Key, g => g.Count());

        var edgeTypeCounts = edges
            .GroupBy(e => e.Type)
            .ToDictionary(g => g.Key, g => g.Count());

        return new GraphStatisticsDto
        {
            TotalNodes = nodes.Count,
            TotalEdges = edges.Count,
            NodeTypes = nodeTypeCounts,
            EdgeTypes = edgeTypeCounts
        };
    }

    /// <summary>
    /// è®°å½•å›¾æŸ¥è¯¢å®¡è®¡æ—¥å¿—
    /// </summary>
    private async Task LogGraphQueryAsync(GraphQueryInput input, int nodeCount, int edgeCount, long executionTimeMs)
    {
        try
        {
            // è¿™é‡Œå¯ä»¥è®°å½•å®¡è®¡æ—¥å¿—
            // await _auditService.LogAsync(...);
            Logger.LogInformation(
                "å›¾æŸ¥è¯¢å®Œæˆ: CenterEntityId={CenterEntityId}, EntityTypes={EntityTypes}, Nodes={NodeCount}, Edges={EdgeCount}, Time={Time}ms",
                input.CenterEntityId,
                string.Join(",", input.EntityTypes ?? new List<string>()),
                nodeCount,
                edgeCount,
                executionTimeMs
            );
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "è®°å½•å›¾æŸ¥è¯¢å®¡è®¡æ—¥å¿—å¤±è´¥");
        }
    }

    /// <summary>
    /// è·å–ç”¨æˆ·è§’è‰²
    /// </summary>
    private async Task<List<string>> GetUserRolesAsync(Guid userId)
    {
        try
        {
            // ä» ABP æ¡†æ¶è·å–ç”¨æˆ·è§’è‰²
            // è¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…åº”è¯¥ä» IIdentityUserRepository è·å–
            return CurrentUser.Roles?.ToList() ?? new List<string>();
        }
        catch
        {
            return new List<string>();
        }
    }

    /// <summary>
    /// æ£€æŸ¥å®ä½“è®¿é—®æƒé™ï¼ˆåˆ©ç”¨AttachCatalogue.Permissionsï¼‰
    /// æ³¨æ„ï¼šentityId å‚æ•°å¯¹åº”ç°æœ‰å®ä½“çš„ Idï¼ˆå¦‚ AttachCatalogue.Idï¼‰ï¼Œ
    /// è§†å›¾æ¨¡å‹é€šè¿‡ EntityId å±æ€§å…³è”åˆ°ç°æœ‰å®ä½“
    /// </summary>
    private async Task<bool> CheckEntityAccessAsync(
        Guid entityId, // ç°æœ‰å®ä½“çš„ Idï¼ˆå¦‚ AttachCatalogue.Idï¼‰
        string entityType,
        Guid userId,
        PermissionAction action,
        List<string> userRoles)
    {
        if (entityType == "Catalogue")
        {
            var catalogue = await _catalogueRepository.GetAsync(entityId);
            if (catalogue == null) return false;

            // ä½¿ç”¨AttachCatalogueçš„æƒé™æ£€æŸ¥æ–¹æ³•
            return catalogue.HasPermission(userId, action, userRoles) ||
                   catalogue.HasInheritedPermission(userId, action, userRoles,
                       catalogue.ParentId.HasValue ? await _catalogueRepository.GetAsync(catalogue.ParentId.Value) : null,
                       null); // Templateä¿¡æ¯å·²ä½“ç°åœ¨åˆ†ç±»ä¸­ï¼Œæ— éœ€å•ç‹¬æŸ¥è¯¢
        }

        // å…¶ä»–å®ä½“ç±»å‹ï¼ˆPersonã€Departmentã€BusinessEntityã€Workflowï¼‰é»˜è®¤å…è®¸è®¿é—®
        // å¯æ ¹æ®éœ€è¦æ‰©å±•æƒé™æ£€æŸ¥é€»è¾‘
        return true;
    }
}
```

> **âœ… å®ç°è¯´æ˜**ï¼š
>
> -   âœ… **æ–‡ä»¶ä½ç½®**ï¼š`src/Hx.Abp.Attachment.Application/Hx/Abp/Attachment/Application/KnowledgeGraphAppService.cs`
> -   âœ… **æ¥å£**ï¼š`IKnowledgeGraphAppService`ï¼ˆä½äº `Application.Contracts/KnowledgeGraph/`ï¼‰
> -   âœ… **å·²æ³¨å†Œ**ï¼šæœåŠ¡å·²æ³¨å†Œåˆ° ABP ä¾èµ–æ³¨å…¥å®¹å™¨ï¼ˆ`HxAbpAttachmentApplicationModule`ï¼‰
> -   âœ… **æƒé™æ§åˆ¶**ï¼šé›†æˆ `AttachCataloguePermissionChecker`ï¼Œä½¿ç”¨ `PermissionAction.View` è¿›è¡Œæƒé™æ£€æŸ¥
> -   âœ… **Apache AGE é›†æˆ**ï¼šä½¿ç”¨ `cypher()` å‡½æ•°æ‰§è¡Œ Cypher æŸ¥è¯¢
> -   âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼šæ”¯æŒèŠ‚ç‚¹å’Œå…³ç³»å»é‡ã€æŸ¥è¯¢æ·±åº¦é™åˆ¶ã€ç»“æœæ•°é‡é™åˆ¶
> -   âœ… **é”™è¯¯å¤„ç†**ï¼šåŒ…å«å®Œæ•´çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
> -   âœ… **DTO å®šä¹‰**ï¼šæ‰€æœ‰ DTO å·²åˆ›å»ºåœ¨ `Application.Contracts/KnowledgeGraph/` ç›®å½•ä¸‹

---

#### 7.1.4 å…¶ä»–æœåŠ¡æ–¹æ³•ï¼ˆå¾…å®ç°ï¼‰

```csharp
    public async Task<PagedResultDto<SearchResultDto>> SearchNodesAsync(NodeSearchInput input)
    {
        var stopwatch = Stopwatch.StartNew();

        // ä½¿ç”¨PostgreSQLå…¨æ–‡æœç´¢è¿›è¡ŒèŠ‚ç‚¹æœç´¢
        var queryable = await _graphMetadataRepository.GetQueryableAsync();

        // æ„å»ºå…¨æ–‡æœç´¢æŸ¥è¯¢
        var keyword = input.Keyword.Trim();

        // æ„å»ºWHEREæ¡ä»¶
        var whereConditions = new List<Expression<Func<KnowledgeGraphEntityGraphMetadata, bool>>>();

        // å…¨æ–‡æœç´¢æ¡ä»¶ï¼ˆåç§°ã€æ ‡ç­¾ã€æè¿°ï¼‰
        whereConditions.Add(e =>
            EF.Functions.ToTsVector("simple", e.GraphProperties["name"].ToString() ?? "")
                .Matches(EF.Functions.PlainToTsQuery("simple", keyword)) ||
            EF.Functions.ToTsVector("simple", string.Join(" ", e.Tags ?? new List<string>()))
                .Matches(EF.Functions.PlainToTsQuery("simple", keyword)) ||
            EF.Functions.ToTsVector("simple", e.GraphProperties["description"].ToString() ?? "")
                .Matches(EF.Functions.PlainToTsQuery("simple", keyword))
        );

        // å®ä½“ç±»å‹è¿‡æ»¤
        if (input.EntityTypes?.Any() == true)
        {
            whereConditions.Add(e => input.EntityTypes.Contains(e.EntityType));
        }

        // æ ‡ç­¾è¿‡æ»¤
        if (input.Tags?.Any() == true)
        {
            whereConditions.Add(e => e.Tags != null && e.Tags.Any(t => input.Tags.Contains(t)));
        }

        // åº”ç”¨æ‰€æœ‰æ¡ä»¶
        foreach (var condition in whereConditions)
        {
            queryable = queryable.Where(condition);
        }

        // è®¡ç®—æ€»æ•°
        var totalCount = await AsyncExecuter.LongCountAsync(queryable);

        // è®¡ç®—åŒ¹é…åº¦å¹¶æ’åº
        var results = await AsyncExecuter.ToListAsync(
            queryable
                .Select(e => new
                {
                    Entity = e,
                    MatchScore = CalculateMatchScore(e, keyword)
                })
                .OrderByDescending(x => x.MatchScore)
                .ThenByDescending(x => GetBusinessPriorityWeight(x.Entity.GraphProperties.GetValueOrDefault("businessPriority")?.ToString()))
                .ThenByDescending(x => x.Entity.LastGraphUpdate ?? DateTime.MinValue)
                .Skip((input.PageIndex - 1) * input.PageSize)
                .Take(input.PageSize)
        );

        // è½¬æ¢ä¸ºDTO
        var items = results.Select(x => new SearchResultDto
        {
            EntityId = x.Entity.EntityId, // ä½¿ç”¨ EntityId è€Œä¸æ˜¯ Idï¼Œå¯¹åº”è§†å›¾æ¨¡å‹çš„ EntityId å±æ€§
            Type = x.Entity.EntityType,
            Name = x.Entity.GraphProperties.GetValueOrDefault("name")?.ToString() ?? "",
            MatchScore = x.MatchScore,
            BusinessPriority = x.Entity.GraphProperties.GetValueOrDefault("businessPriority")?.ToString(),
            SecurityLevel = x.Entity.GraphProperties.GetValueOrDefault("securityLevel")?.ToString(),
            UpdatedTime = x.Entity.LastGraphUpdate ?? DateTime.MinValue
        }).ToList();

        stopwatch.Stop();

        var result = new PagedResultDto<SearchResultDto>
        {
            TotalCount = totalCount,
            Items = items
        };

        // è®°å½•å®¡è®¡æ—¥å¿—
        await _auditService.LogAsync(new AuditLogEntry
        {
            ActionType = AuditActionType.SEARCH,
            ActionCategory = AuditActionCategory.SEARCH,
            ActionDescription = $"æœç´¢èŠ‚ç‚¹ï¼šå…³é”®è¯={input.Keyword}, ç»“æœæ•°={items.Count}",
            NewValues = new Dictionary<string, object>
            {
                ["keyword"] = input.Keyword,
                ["entityTypes"] = input.EntityTypes ?? new List<string>(),
                ["pageIndex"] = input.PageIndex,
                ["pageSize"] = input.PageSize,
                ["resultCount"] = items.Count,
                ["totalCount"] = totalCount
            },
            ExecutionTimeMs = (int)stopwatch.ElapsedMilliseconds,
            Status = AuditStatus.Success
        });

        return result;
    }

    /// <summary>
    /// è®¡ç®—åŒ¹é…åº¦åˆ†æ•°ï¼ˆä½¿ç”¨PostgreSQLå…¨æ–‡æœç´¢ï¼‰
    /// </summary>
    private double CalculateMatchScore(KnowledgeGraphEntityGraphMetadata entity, string keyword)
    {
        var name = entity.GraphProperties.GetValueOrDefault("name")?.ToString() ?? "";
        var tags = string.Join(" ", entity.Tags ?? new List<string>());
        var description = entity.GraphProperties.GetValueOrDefault("description")?.ToString() ?? "";

        // ä½¿ç”¨PostgreSQLçš„ts_rank_cdå‡½æ•°è®¡ç®—åŒ¹é…åº¦
        // åç§°æƒé‡3.0ï¼Œæ ‡ç­¾æƒé‡2.0ï¼Œæè¿°æƒé‡1.0
        var nameScore = CalculateTextMatchScore(name, keyword) * 3.0;
        var tagScore = CalculateTextMatchScore(tags, keyword) * 2.0;
        var descScore = CalculateTextMatchScore(description, keyword) * 1.0;

        return nameScore + tagScore + descScore;
    }

    private double CalculateTextMatchScore(string text, string keyword)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrEmpty(keyword))
            return 0.0;

        var textLower = text.ToLowerInvariant();
        var keywordLower = keyword.ToLowerInvariant();

        // å®Œå…¨åŒ¹é…
        if (textLower == keywordLower) return 1.0;

        // åŒ…å«åŒ¹é…
        if (textLower.Contains(keywordLower)) return 0.8;

        // å•è¯åŒ¹é…
        var words = keywordLower.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        var matchCount = words.Count(w => textLower.Contains(w));
        return matchCount > 0 ? (double)matchCount / words.Length * 0.6 : 0.0;
    }

    private double GetBusinessPriorityWeight(string? priority)
    {
        return priority switch
        {
            "é«˜" => 3.0,
            "ä¸­" => 2.0,
            "ä½" => 1.0,
            _ => 1.0
        };
    }

    public async Task<ImpactAnalysisResultDto> CalculateImpactAnalysisAsync(ImpactAnalysisInput input)
    {
        return await _impactAnalysisService.CalculateImpact(
            input.EntityId,
            input.ChangeType,
            input.ImpactRadius
        );
    }

    // ========== å…³ç³»ç®¡ç†æ–¹æ³•å®ç° ==========

    /// <summary>
    /// åˆ›å»ºå…³ç³»ï¼ˆå·²å®ç°ï¼‰
    /// æ”¯æŒæŠ½è±¡å…³ç³»ç±»å‹ï¼ˆé€šè¿‡ Role å’Œ SemanticType å±æ€§ï¼‰
    ///
    /// å®ç°ä½ç½®ï¼š
    /// - æ¥å£ï¼šsrc/Hx.Abp.Attachment.Application.Contracts/Hx/Abp/Attachment/Application/Contracts/KnowledgeGraph/IKnowledgeGraphAppService.cs
    /// - å®ç°ï¼šsrc/Hx.Abp.Attachment.Application/Hx/Abp/Attachment/Application/KnowledgeGraphAppService.cs
    /// - DTOï¼šsrc/Hx.Abp.Attachment.Application.Contracts/Hx/Abp/Attachment/Application/Contracts/KnowledgeGraph/CreateRelationshipInput.cs
    /// - DTOï¼šsrc/Hx.Abp.Attachment.Application.Contracts/Hx/Abp/Attachment/Application/Contracts/KnowledgeGraph/RelationshipDto.cs
    /// - æ§åˆ¶å™¨ï¼šsrc/Hx.Abp.Attachment.HttpApi/Hx/Abp/Attachment/HttpApi/KnowledgeGraphController.cs
    /// </summary>
    public async Task<RelationshipDto> CreateRelationshipAsync(CreateRelationshipInput input)
    {
        var stopwatch = Stopwatch.StartNew();

        // 1. éªŒè¯æºå®ä½“å’Œç›®æ ‡å®ä½“æ˜¯å¦å­˜åœ¨
        await ValidateEntitiesExistAsync(input.SourceEntityId, input.SourceEntityType);
        await ValidateEntitiesExistAsync(input.TargetEntityId, input.TargetEntityType);

        // 2. éªŒè¯å…³ç³»ç±»å‹æ˜¯å¦æœ‰æ•ˆ
        ValidateRelationshipType(input.RelationshipType, input.SourceEntityType, input.TargetEntityType);

        // 3. æ£€æŸ¥å…³ç³»æ˜¯å¦å·²å­˜åœ¨ï¼ˆæ ¹æ®ä¸šåŠ¡è§„åˆ™ï¼ŒæŸäº›å…³ç³»ç±»å‹ä¸å…è®¸é‡å¤ï¼‰
        // å¯¹äºæŠ½è±¡å…³ç³»ç±»å‹ï¼Œéœ€è¦è€ƒè™‘ role æˆ– semanticType çš„ç»„åˆå”¯ä¸€æ€§
        var exists = await CheckRelationshipExistsAsync(input.SourceEntityId, input.TargetEntityId, input.RelationshipType, input.Role, input.SemanticType);
        if (exists)
        {
            throw new UserFriendlyException($"å…³ç³»å·²å­˜åœ¨");
        }

        // 4. éªŒè¯æƒé™ï¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™åˆ›å»ºè¯¥å…³ç³»
        var userId = CurrentUser.Id ?? Guid.Empty;
        var userRoles = await GetUserRolesAsync(userId);
        await ValidateRelationshipCreationPermissionAsync(input.SourceEntityId, input.SourceEntityType, input.TargetEntityId, input.TargetEntityType, userId, userRoles);

        // 5. éªŒè¯ä¸šåŠ¡è§„åˆ™ï¼ˆå¾ªç¯å…³ç³»æ£€æŸ¥ç­‰ï¼‰
        await ValidateBusinessRulesAsync(input);

        // 6. åˆ›å»ºå…³ç³»å®ä½“ï¼ˆæ”¯æŒæŠ½è±¡å…³ç³»ç±»å‹ï¼‰
        var relationship = new KnowledgeGraphRelationship
        {
            SourceEntityId = input.SourceEntityId,
            SourceEntityType = input.SourceEntityType,
            TargetEntityId = input.TargetEntityId,
            TargetEntityType = input.TargetEntityType,
            Type = input.RelationshipType,
            Role = input.Role, // è§’è‰²ï¼ˆç”¨äº PersonRelatesToCatalogueã€PersonRelatesToWorkflow ç­‰ï¼‰
            SemanticType = input.SemanticType, // è¯­ä¹‰ç±»å‹ï¼ˆç”¨äº CatalogueRelatesToCatalogueã€WorkflowRelatesToWorkflow ç­‰ï¼‰
            Description = input.Description,
            Weight = input.Weight ?? 1.0
        };

        // è®¾ç½®æ‰©å±•å±æ€§ï¼ˆä½¿ç”¨ ABP çš„ ExtraPropertiesï¼‰
        if (input.Properties != null)
        {
            foreach (var prop in input.Properties)
            {
                relationship.SetProperty(prop.Key, prop.Value);
            }
        }

        await _relationshipRepository.InsertAsync(relationship);

        // 7. åŒæ­¥åˆ° Apache AGE å›¾æ•°æ®åº“ï¼ˆä½¿ç”¨ä»“å‚¨æ–¹æ³•ï¼‰
        await SyncRelationshipToAgeGraphAsync(relationship);

        // 8. è®°å½•å®¡è®¡æ—¥å¿—ï¼ˆä½¿ç”¨æ—¥å¿—è®°å½•ï¼‰
        stopwatch.Stop();
        Logger.LogInformation(
            "åˆ›å»ºå…³ç³»æˆåŠŸï¼š{SourceEntityType}({SourceEntityId}) -[{RelationshipType}" +
            "{(string.IsNullOrEmpty(input.Role) ? "" : $":{input.Role}")}" +
            "{(string.IsNullOrEmpty(input.SemanticType) ? "" : $":{input.SemanticType}")}]-> " +
            "{TargetEntityType}({TargetEntityId}), RelationshipId={RelationshipId}, Time={Time}ms",
            input.SourceEntityType, input.SourceEntityId, input.RelationshipType, input.Role, input.SemanticType,
            input.TargetEntityType, input.TargetEntityId, relationship.Id, stopwatch.ElapsedMilliseconds);

        // 9. è¿”å›DTO
        return MapToRelationshipDto(relationship);
    }

    /// <summary>
    /// æ‰¹é‡åˆ›å»ºå…³ç³»
    /// </summary>
    public async Task<BatchCreateRelationshipResultDto> BatchCreateRelationshipsAsync(BatchCreateRelationshipInput input)
    {
        var results = new List<BatchCreateRelationshipItemResult>();
        var successCount = 0;
        var failedCount = 0;

        foreach (var relInput in input.Relationships)
        {
            var itemResult = new BatchCreateRelationshipItemResult
            {
                Index = results.Count
            };

            try
            {
                // æ£€æŸ¥æ˜¯å¦è·³è¿‡é‡å¤å…³ç³»
                if (input.SkipDuplicates)
                {
                    var exists = await CheckRelationshipExistsAsync(
                        relInput.SourceEntityId,
                        relInput.TargetEntityId,
                        relInput.RelationshipType);
                    if (exists)
                    {
                        itemResult.Success = false;
                        itemResult.Error = "å…³ç³»å·²å­˜åœ¨";
                        itemResult.Skipped = true;
                        results.Add(itemResult);
                        continue;
                    }
                }

                // éªŒè¯ï¼ˆå¦‚æœæœªè·³è¿‡éªŒè¯ï¼‰
                if (!input.SkipValidation)
                {
                    await ValidateEntitiesExistAsync(relInput.SourceEntityId, relInput.SourceEntityType);
                    await ValidateEntitiesExistAsync(relInput.TargetEntityId, relInput.TargetEntityType);
                    ValidateRelationshipType(relInput.RelationshipType, relInput.SourceEntityType, relInput.TargetEntityType);
                }

                // åˆ›å»ºå…³ç³»
                var relationship = new KnowledgeGraphRelationship
                {
                    SourceEntityId = relInput.SourceEntityId,
                    SourceEntityType = relInput.SourceEntityType,
                    TargetEntityId = relInput.TargetEntityId,
                    TargetEntityType = relInput.TargetEntityType,
                    Type = relInput.RelationshipType,
                    Description = relInput.Description,
                    Weight = relInput.Weight ?? 1.0,
                    Properties = relInput.Properties ?? new Dictionary<string, object>(),
                    CreatedTime = DateTime.UtcNow
                };

                await _relationshipRepository.InsertAsync(relationship);
                await _syncService.SyncRelationshipToNeo4jAsync(relationship);

                itemResult.Success = true;
                itemResult.RelationshipId = relationship.Id;
                successCount++;
            }
            catch (Exception ex)
            {
                itemResult.Success = false;
                itemResult.Error = ex.Message;
                failedCount++;
            }

            results.Add(itemResult);
        }

        return new BatchCreateRelationshipResultDto
        {
            TotalCount = input.Relationships.Count,
            SuccessCount = successCount,
            FailedCount = failedCount,
            Results = results
        };
    }

    /// <summary>
    /// æ›´æ–°å…³ç³»
    /// </summary>
    public async Task<RelationshipDto> UpdateRelationshipAsync(Guid relationshipId, UpdateRelationshipInput input)
    {
        var relationship = await _relationshipRepository.GetAsync(relationshipId);

        // éªŒè¯æƒé™
        await ValidateRelationshipUpdatePermissionAsync(relationship);

        // æ›´æ–°å­—æ®µï¼ˆæ”¯æŒæŠ½è±¡å…³ç³»ç±»å‹ï¼‰
        if (input.Description != null)
            relationship.Description = input.Description;
        if (input.Weight.HasValue)
            relationship.Weight = input.Weight.Value;
        if (input.Role != null)
            relationship.Role = input.Role;
        if (input.SemanticType != null)
            relationship.SemanticType = input.SemanticType;
        // æ›´æ–°æ‰©å±•å±æ€§
        if (input.Properties != null)
        {
            foreach (var prop in input.Properties)
            {
                relationship.SetProperty(prop.Key, prop.Value);
            }
        }
        // æ³¨æ„ï¼šLastModificationTime ç”± ExtensibleFullAuditedEntity è‡ªåŠ¨æ›´æ–°

        await _relationshipRepository.UpdateAsync(relationship);

        // åŒæ­¥åˆ°Neo4j
        await _syncService.SyncRelationshipToNeo4jAsync(relationship);

        // è®°å½•å®¡è®¡æ—¥å¿—
        await _auditService.LogAsync(new AuditLogEntry
        {
            EntityId = relationshipId,
            EntityType = "Relationship",
            ActionType = AuditActionType.RELATIONSHIP_UPDATE,
            ActionCategory = AuditActionCategory.GRAPH_OPERATION,
            ActionDescription = $"æ›´æ–°å…³ç³»ï¼š{relationship.Type}",
            OldValues = new Dictionary<string, object>
            {
                ["description"] = input.Description ?? relationship.Description,
                ["weight"] = input.Weight ?? relationship.Weight
            },
            NewValues = new Dictionary<string, object>
            {
                ["description"] = relationship.Description,
                ["weight"] = relationship.Weight
            },
            Status = AuditStatus.Success
        });

        return await MapToRelationshipDtoAsync(relationship);
    }

    /// <summary>
    /// åˆ é™¤å…³ç³»
    /// </summary>
    public async Task DeleteRelationshipAsync(Guid relationshipId)
    {
        var relationship = await _relationshipRepository.GetAsync(relationshipId);

        // éªŒè¯æƒé™
        await ValidateRelationshipDeletePermissionAsync(relationship);

        // åˆ é™¤å…³ç³»
        await _relationshipRepository.DeleteAsync(relationship);

        // ä» Apache AGE å›¾æ•°æ®åº“åˆ é™¤
        await _syncService.DeleteRelationshipFromAgeGraphAsync(relationshipId);

        // è®°å½•å®¡è®¡æ—¥å¿—
        await _auditService.LogAsync(new AuditLogEntry
        {
            EntityId = relationshipId,
            EntityType = "Relationship",
            ActionType = AuditActionType.RELATIONSHIP_DELETE,
            ActionCategory = AuditActionCategory.GRAPH_OPERATION,
            ActionDescription = $"åˆ é™¤å…³ç³»ï¼š{relationship.Type}",
            OldValues = new Dictionary<string, object>
            {
                ["sourceEntityId"] = relationship.SourceEntityId,
                ["targetEntityId"] = relationship.TargetEntityId,
                ["relationshipType"] = relationship.Type.ToString()
            },
            Status = AuditStatus.Success
        });
    }

    /// <summary>
    /// è·å–å…³ç³»åˆ—è¡¨
    /// </summary>
    public async Task<PagedResultDto<RelationshipDto>> GetRelationshipsAsync(RelationshipQueryInput input)
    {
        var queryable = await _relationshipRepository.GetQueryableAsync();

        // åº”ç”¨è¿‡æ»¤æ¡ä»¶
        if (input.SourceEntityId.HasValue)
            queryable = queryable.Where(r => r.SourceEntityId == input.SourceEntityId.Value);
        if (input.TargetEntityId.HasValue)
            queryable = queryable.Where(r => r.TargetEntityId == input.TargetEntityId.Value);
        if (input.RelationshipType.HasValue)
            queryable = queryable.Where(r => r.Type == input.RelationshipType.Value);
        if (input.EntityType != null)
            queryable = queryable.Where(r => r.SourceEntityType == input.EntityType || r.TargetEntityType == input.EntityType);

        var totalCount = await AsyncExecuter.LongCountAsync(queryable);

        var relationships = await AsyncExecuter.ToListAsync(
            queryable
                .OrderByDescending(r => r.CreatedTime)
                .Skip((input.PageIndex - 1) * input.PageSize)
                .Take(input.PageSize)
        );

        var items = new List<RelationshipDto>();
        foreach (var rel in relationships)
        {
            items.Add(await MapToRelationshipDtoAsync(rel));
        }

        return new PagedResultDto<RelationshipDto>
        {
            TotalCount = totalCount,
            Items = items
        };
    }

    /// <summary>
    /// è·å–å®ä½“çš„å…³ç³»ç½‘ç»œ
    /// </summary>
    public async Task<EntityRelationshipNetworkDto> GetEntityRelationshipsAsync(Guid entityId, RelationshipNetworkQueryInput input)
    {
        var queryable = await _relationshipRepository.GetQueryableAsync();

        var outgoingQuery = queryable.Where(r => r.SourceEntityId == entityId);
        var incomingQuery = queryable.Where(r => r.TargetEntityId == entityId);

        // å…³ç³»ç±»å‹è¿‡æ»¤
        if (input.RelationshipTypes?.Any() == true)
        {
            outgoingQuery = outgoingQuery.Where(r => input.RelationshipTypes.Contains(r.Type));
            incomingQuery = incomingQuery.Where(r => input.RelationshipTypes.Contains(r.Type));
        }

        var outgoingRelationships = await AsyncExecuter.ToListAsync(outgoingQuery);
        var incomingRelationships = await AsyncExecuter.ToListAsync(incomingQuery);

        var outgoingDtos = new List<RelationshipDto>();
        var incomingDtos = new List<RelationshipDto>();

        foreach (var rel in outgoingRelationships)
        {
            outgoingDtos.Add(await MapToRelationshipDtoAsync(rel));
        }

        foreach (var rel in incomingRelationships)
        {
            incomingDtos.Add(await MapToRelationshipDtoAsync(rel));
        }

        // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
        var statistics = new RelationshipNetworkStatisticsDto
        {
            TotalOutgoing = outgoingDtos.Count,
            TotalIncoming = incomingDtos.Count,
            RelationshipTypeCounts = outgoingDtos
                .Concat(incomingDtos)
                .GroupBy(r => r.RelationshipType)
                .ToDictionary(g => g.Key.ToString(), g => g.Count())
        };

        return new EntityRelationshipNetworkDto
        {
            EntityId = entityId,
            EntityType = (await GetEntityTypeAsync(entityId)) ?? "Unknown",
            OutgoingRelationships = outgoingDtos,
            IncomingRelationships = incomingDtos,
            Statistics = statistics
        };
    }

    #region å…³ç³»ç®¡ç†ç§æœ‰è¾…åŠ©æ–¹æ³•

    /// <summary>
    /// éªŒè¯å®ä½“æ˜¯å¦å­˜åœ¨
    /// </summary>
    private async Task ValidateEntitiesExistAsync(Guid entityId, string entityType)
    {
        var exists = entityType switch
        {
            "Catalogue" => await _catalogueRepository.AnyAsync(e => e.Id == entityId),
            "File" => await _fileRepository.AnyAsync(e => e.Id == entityId),
            "Template" => await _templateRepository.AnyAsync(e => e.Id == entityId),
            _ => false
        };

        if (!exists)
            throw new UserFriendlyException($"å®ä½“ä¸å­˜åœ¨ï¼š{entityType}({entityId})");
    }

    /// <summary>
    /// éªŒè¯å…³ç³»ç±»å‹æ˜¯å¦æœ‰æ•ˆ
    /// </summary>
    private void ValidateRelationshipType(RelationshipType relationshipType, string sourceEntityType, string targetEntityType)
    {
        // å®šä¹‰æœ‰æ•ˆçš„å…³ç³»ç±»å‹ç»„åˆ
        var validCombinations = new Dictionary<RelationshipType, (string source, string target)[]>
        {
            { RelationshipType.CatalogueHasChild, new[] { ("Catalogue", "Catalogue") } },
            { RelationshipType.CatalogueReferencesBusiness, new[] { ("Catalogue", "BusinessEntity") } },
            { RelationshipType.CatalogueRelatedByTime, new[] { ("Catalogue", "Catalogue") } },
            { RelationshipType.CatalogueRelatedByBusiness, new[] { ("Catalogue", "Catalogue") } },
            { RelationshipType.CatalogueReplaces, new[] { ("Catalogue", "Catalogue") } },
            { RelationshipType.CatalogueHasVersion, new[] { ("Catalogue", "Catalogue") } },
            { RelationshipType.PersonCreatesCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonManagesCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonIsProjectManagerForCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonReviewsCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonIsExpertForCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonIsResponsibleForCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonIsContactForCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonParticipatesInCatalogue, new[] { ("Person", "Catalogue") } },
            { RelationshipType.PersonBelongsToDepartment, new[] { ("Person", "Department") } },
            { RelationshipType.DepartmentOwnsCatalogue, new[] { ("Department", "Catalogue") } },
            { RelationshipType.DepartmentManagesCatalogue, new[] { ("Department", "Catalogue") } },
            { RelationshipType.DepartmentHasParent, new[] { ("Department", "Department") } },
            { RelationshipType.BusinessEntityHasCatalogue, new[] { ("BusinessEntity", "Catalogue") } },
            { RelationshipType.BusinessEntityManagesCatalogue, new[] { ("BusinessEntity", "Catalogue") } },
            { RelationshipType.CatalogueUsesWorkflow, new[] { ("Catalogue", "Workflow") } },
            { RelationshipType.WorkflowManagesCatalogue, new[] { ("Workflow", "Catalogue") } },
            { RelationshipType.WorkflowInstanceBelongsToCatalogue, new[] { ("Workflow", "Catalogue") } },
            { RelationshipType.PersonManagesWorkflow, new[] { ("Person", "Workflow") } },
            { RelationshipType.PersonExecutesWorkflow, new[] { ("Person", "Workflow") } },
            { RelationshipType.DepartmentOwnsWorkflow, new[] { ("Department", "Workflow") } },
            { RelationshipType.WorkflowHasVersion, new[] { ("Workflow", "Workflow") } },
            { RelationshipType.WorkflowReplaces, new[] { ("Workflow", "Workflow") } }
        };

        if (!validCombinations.ContainsKey(relationshipType))
            throw new UserFriendlyException($"æ— æ•ˆçš„å…³ç³»ç±»å‹ï¼š{relationshipType}");

        var validCombos = validCombinations[relationshipType];
        var isValid = validCombos.Any(c => c.source == sourceEntityType && c.target == targetEntityType);

        if (!isValid)
            throw new UserFriendlyException(
                $"å…³ç³»ç±»å‹ {relationshipType} ä¸æ”¯æŒ {sourceEntityType} -> {targetEntityType} çš„ç»„åˆ");
    }

    /// <summary>
    /// æ£€æŸ¥å…³ç³»æ˜¯å¦å·²å­˜åœ¨ï¼ˆè€ƒè™‘ role å’Œ semanticTypeï¼‰
    /// </summary>
    private async Task<bool> CheckRelationshipExistsAsync(
        Guid sourceId,
        Guid targetId,
        RelationshipType relationshipType,
        string? role = null,
        string? semanticType = null)
    {
        var queryable = await _relationshipRepository.GetQueryableAsync();
        queryable = queryable.Where(r =>
            r.SourceEntityId == sourceId &&
            r.TargetEntityId == targetId &&
            r.Type == relationshipType);

        // å¯¹äºæŠ½è±¡å…³ç³»ç±»å‹ï¼Œéœ€è¦æ£€æŸ¥ role æˆ– semanticType
        if (relationshipType == RelationshipType.PersonRelatesToCatalogue ||
            relationshipType == RelationshipType.PersonRelatesToWorkflow)
        {
            if (!string.IsNullOrEmpty(role))
            {
                queryable = queryable.Where(r => r.Role == role);
            }
        }

        if (relationshipType == RelationshipType.CatalogueRelatesToCatalogue ||
            relationshipType == RelationshipType.WorkflowRelatesToWorkflow)
        {
            if (!string.IsNullOrEmpty(semanticType))
            {
                queryable = queryable.Where(r => r.SemanticType == semanticType);
            }
        }

        return await AsyncExecuter.AnyAsync(queryable);
    }

    /// <summary>
    /// éªŒè¯å…³ç³»åˆ›å»ºæƒé™
    /// </summary>
    private async Task ValidateRelationshipCreationPermissionAsync(
        Guid sourceEntityId, string sourceEntityType,
        Guid targetEntityId, string targetEntityType)
    {
        var userId = CurrentUser.Id;
        var userRoles = await GetUserRolesAsync(userId);

        // æ£€æŸ¥æºå®ä½“çš„å†™æƒé™
        if (sourceEntityType == "Catalogue")
        {
            var catalogue = await _catalogueRepository.GetAsync(sourceEntityId);
            if (!catalogue.HasPermission(userId, PermissionAction.Write, userRoles))
                throw new UserFriendlyException("æ²¡æœ‰æƒé™åˆ›å»ºå…³ç³»ï¼šæºå®ä½“æƒé™ä¸è¶³");
        }

        // æ£€æŸ¥ç›®æ ‡å®ä½“çš„è¯»æƒé™ï¼ˆè‡³å°‘éœ€è¦è¯»æƒé™æ‰èƒ½å…³è”ï¼‰
        if (targetEntityType == "Catalogue")
        {
            var catalogue = await _catalogueRepository.GetAsync(targetEntityId);
            if (!catalogue.HasPermission(userId, PermissionAction.Read, userRoles))
                throw new UserFriendlyException("æ²¡æœ‰æƒé™åˆ›å»ºå…³ç³»ï¼šç›®æ ‡å®ä½“æƒé™ä¸è¶³");
        }
    }

    /// <summary>
    /// éªŒè¯ä¸šåŠ¡è§„åˆ™ï¼ˆå¾ªç¯å…³ç³»æ£€æŸ¥ç­‰ï¼‰
    /// </summary>
    private async Task ValidateBusinessRulesAsync(CreateRelationshipInput input)
    {
        // æ£€æŸ¥å¾ªç¯å…³ç³»ï¼ˆä¾‹å¦‚ï¼šåˆ†ç±»AåŒ…å«åˆ†ç±»Bï¼Œåˆ†ç±»Bä¸èƒ½åŒ…å«åˆ†ç±»Aï¼‰
        if (input.RelationshipType == RelationshipType.CatalogueHasChild ||
            (input.RelationshipType == RelationshipType.CatalogueRelatesToCatalogue &&
             input.SemanticType == CatalogueSemanticType.DependsOn.ToString()))
        {
            // æ£€æŸ¥æ˜¯å¦ä¼šå¯¼è‡´å¾ªç¯ï¼šç›®æ ‡åˆ†ç±»æ˜¯å¦æ˜¯æºåˆ†ç±»çš„ç¥–å…ˆ
            var hasCycle = await CheckCycleAsync(input.TargetEntityId, input.SourceEntityId, "Catalogue");
            if (hasCycle)
                throw new UserFriendlyException("ä¸èƒ½åˆ›å»ºå¾ªç¯å…³ç³»ï¼šç›®æ ‡åˆ†ç±»æ˜¯æºåˆ†ç±»çš„ç¥–å…ˆ");
        }

        // å…¶ä»–ä¸šåŠ¡è§„åˆ™éªŒè¯...
    }

    /// <summary>
    /// æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾ªç¯å…³ç³»
    /// </summary>
    private async Task<bool> CheckCycleAsync(Guid ancestorId, Guid descendantId, string entityType)
    {
        // ä½¿ç”¨ Apache AGE æŸ¥è¯¢æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»descendantIdåˆ°ancestorIdçš„è·¯å¾„
        var dbContext = await _dbContextProvider.GetDbContextAsync();
        var connection = dbContext.Database.GetDbConnection() as NpgsqlConnection;

        if (connection == null)
            throw new InvalidOperationException("Database connection is not NpgsqlConnection");

        var cypherQuery = @"
            MATCH path = (ancestor:Entity {id: $ancestorId})-[*]->(descendant:Entity {id: $descendantId})
            WHERE ancestor.id = $ancestorId AND descendant.id = $descendantId
            RETURN count(path) as pathCount";

        var sqlQuery = $@"
            SELECT * FROM cypher('kg_graph', ${cypherQuery}$$, $1) AS (pathCount agtype)";

        await using var command = new NpgsqlCommand(sqlQuery, connection);
        command.Parameters.AddWithValue("cypherQuery", cypherQuery);
        command.Parameters.AddWithValue("$1", JsonSerializer.Serialize(new
        {
            ancestorId = ancestorId.ToString(),
            descendantId = descendantId.ToString()
        }));

        await using var reader = await command.ExecuteReaderAsync();
        if (await reader.ReadAsync())
        {
            var result = reader.GetFieldValue<JsonDocument>(0);
            var pathCount = result.RootElement.GetProperty("pathCount").GetInt64();
            return pathCount > 0;
        }

        return false;
    }

    /// <summary>
    /// éªŒè¯å…³ç³»æ›´æ–°æƒé™
    /// </summary>
    private async Task ValidateRelationshipUpdatePermissionAsync(KnowledgeGraphRelationship relationship)
    {
        var userId = CurrentUser.Id;
        var userRoles = await GetUserRolesAsync(userId);

        if (relationship.SourceEntityType == "Catalogue")
        {
            var catalogue = await _catalogueRepository.GetAsync(relationship.SourceEntityId);
            if (!catalogue.HasPermission(userId, PermissionAction.Write, userRoles))
                throw new UserFriendlyException("æ²¡æœ‰æƒé™æ›´æ–°å…³ç³»");
        }
    }

    /// <summary>
    /// éªŒè¯å…³ç³»åˆ é™¤æƒé™
    /// </summary>
    private async Task ValidateRelationshipDeletePermissionAsync(KnowledgeGraphRelationship relationship)
    {
        await ValidateRelationshipUpdatePermissionAsync(relationship); // åˆ é™¤æƒé™ä¸æ›´æ–°æƒé™ç›¸åŒ
    }

    /// <summary>
    /// æ˜ å°„å…³ç³»å®ä½“åˆ°DTO
    /// </summary>
    private async Task<RelationshipDto> MapToRelationshipDtoAsync(KnowledgeGraphRelationship relationship)
    {
        var sourceEntity = await GetEntityBasicInfoAsync(relationship.SourceEntityId, relationship.SourceEntityType);
        var targetEntity = await GetEntityBasicInfoAsync(relationship.TargetEntityId, relationship.TargetEntityType);

        return new RelationshipDto
        {
            Id = relationship.Id,
            SourceEntity = sourceEntity,
            TargetEntity = targetEntity,
            RelationshipType = relationship.Type,
            Description = relationship.Description,
            Weight = relationship.Weight,
            // ä» ExtraProperties è·å–æ‰©å±•å±æ€§
            Properties = relationship.ExtraProperties.ToDictionary(kvp => kvp.Key, kvp => kvp.Value),
            CreationTime = relationship.CreationTime,
            LastModificationTime = relationship.LastModificationTime
        };
    }

    /// <summary>
    /// è·å–å®ä½“åŸºæœ¬ä¿¡æ¯
    /// </summary>
    private async Task<EntityBasicInfoDto> GetEntityBasicInfoAsync(Guid entityId, string entityType)
    {
        return entityType switch
        {
            "Catalogue" => await GetCatalogueBasicInfoAsync(entityId),
            "Person" => await GetPersonBasicInfoAsync(entityId),
            "Department" => await GetDepartmentBasicInfoAsync(entityId),
            "BusinessEntity" => await GetBusinessEntityBasicInfoAsync(entityId),
            "Workflow" => await GetWorkflowBasicInfoAsync(entityId),
            _ => new EntityBasicInfoDto { Id = entityId, Type = entityType }
        };
    }

    private async Task<EntityBasicInfoDto> GetCatalogueBasicInfoAsync(Guid catalogueId)
    {
        var catalogue = await _catalogueRepository.GetAsync(catalogueId);
        return new EntityBasicInfoDto
        {
            Id = catalogue.Id,
            Name = catalogue.CatalogueName,
            Type = "Catalogue"
        };
    }

    private async Task<EntityBasicInfoDto> GetPersonBasicInfoAsync(Guid personId)
    {
        // ä»ç”¨æˆ·ç³»ç»Ÿè·å–äººå‘˜ä¿¡æ¯
        // var person = await _userRepository.GetAsync(personId);
        return new EntityBasicInfoDto
        {
            Id = personId,
            Name = "", // person.Name,
            Type = "Person"
        };
    }

    private async Task<EntityBasicInfoDto> GetDepartmentBasicInfoAsync(Guid departmentId)
    {
        // ä»ç»„ç»‡ç³»ç»Ÿè·å–éƒ¨é—¨ä¿¡æ¯
        // var department = await _departmentRepository.GetAsync(departmentId);
        return new EntityBasicInfoDto
        {
            Id = departmentId,
            Name = "", // department.DepartmentName,
            Type = "Department"
        };
    }

    private async Task<EntityBasicInfoDto> GetBusinessEntityBasicInfoAsync(Guid businessEntityId)
    {
        // ä»å¤–éƒ¨ä¸šåŠ¡ç³»ç»Ÿè·å–ä¸šåŠ¡å®ä½“ä¿¡æ¯
        return new EntityBasicInfoDto
        {
            Id = businessEntityId,
            Name = "",
            Type = "BusinessEntity"
        };
    }

    private async Task<EntityBasicInfoDto> GetWorkflowBasicInfoAsync(Guid workflowId)
    {
        // ä»å·¥ä½œæµå¼•æ“è·å–å·¥ä½œæµä¿¡æ¯
        // var workflow = await _workflowRepository.GetAsync(workflowId);
        return new EntityBasicInfoDto
        {
            Id = workflowId,
            Name = "", // workflow.WorkflowName,
            Type = "Workflow"
        };
    }

    private async Task<string?> GetEntityTypeAsync(Guid entityId)
    {
        if (await _catalogueRepository.AnyAsync(e => e.Id == entityId))
            return "Catalogue";
        // å…¶ä»–å®ä½“ç±»å‹éœ€è¦é€šè¿‡å¯¹åº”çš„ç³»ç»ŸæŸ¥è¯¢
        return null;
    }

    #endregion
}
```

### 7.2 å…³ç³»åˆ›å»ºè®¾è®¡è¦ç‚¹

#### 7.2.1 å…³ç³»åˆ›å»ºæµç¨‹

```
ç”¨æˆ·è¯·æ±‚åˆ›å»ºå…³ç³»
    â†“
1. å‚æ•°éªŒè¯ï¼ˆå®ä½“IDã€å…³ç³»ç±»å‹ç­‰ï¼‰
    â†“
2. å®ä½“å­˜åœ¨æ€§éªŒè¯ï¼ˆæºå®ä½“ã€ç›®æ ‡å®ä½“ï¼‰
    â†“
3. å…³ç³»ç±»å‹æœ‰æ•ˆæ€§éªŒè¯ï¼ˆæº/ç›®æ ‡å®ä½“ç±»å‹ç»„åˆï¼‰
    â†“
4. æƒé™éªŒè¯ï¼ˆæºå®ä½“å†™æƒé™ã€ç›®æ ‡å®ä½“è¯»æƒé™ï¼‰
    â†“
5. ä¸šåŠ¡è§„åˆ™éªŒè¯ï¼ˆé‡å¤å…³ç³»æ£€æŸ¥ã€å¾ªç¯å…³ç³»æ£€æŸ¥ï¼‰
    â†“
6. åˆ›å»ºå…³ç³»å®ä½“ï¼ˆPostgreSQLï¼‰
    â†“
7. åŒæ­¥åˆ° Apache AGE å›¾æ•°æ®åº“ï¼ˆå¼‚æ­¥åå°ä½œä¸šï¼‰
    â†“
8. è®°å½•å®¡è®¡æ—¥å¿—
    â†“
è¿”å›å…³ç³»DTO
```

#### 7.2.2 éªŒè¯æœºåˆ¶

**1. å®ä½“å­˜åœ¨æ€§éªŒè¯**ï¼š

-   éªŒè¯æºå®ä½“å’Œç›®æ ‡å®ä½“åœ¨æ•°æ®åº“ä¸­æ˜¯å¦å­˜åœ¨
-   æ ¹æ®å®ä½“ç±»å‹æŸ¥è¯¢å¯¹åº”çš„å®ä½“è¡¨ï¼ˆ`APPATTACH_CATALOGUES`ç­‰ï¼‰

**2. å…³ç³»ç±»å‹æœ‰æ•ˆæ€§éªŒè¯**ï¼š

-   å®šä¹‰æœ‰æ•ˆçš„å…³ç³»ç±»å‹ç»„åˆè§„åˆ™
-   ä¾‹å¦‚ï¼š`CatalogueHasChild` åªèƒ½ç”¨äº `Catalogue -> Catalogue`ï¼Œ`PersonRelatesToCatalogue` åªèƒ½ç”¨äº `Person -> Catalogue`
-   å¯¹äºæŠ½è±¡å…³ç³»ç±»å‹ï¼ˆ`PersonRelatesToCatalogue`ã€`CatalogueRelatesToCatalogue` ç­‰ï¼‰ï¼Œéœ€è¦éªŒè¯ `role` æˆ– `semanticType` çš„æœ‰æ•ˆæ€§
-   ä½¿ç”¨å­—å…¸å­˜å‚¨æœ‰æ•ˆç»„åˆï¼Œå¿«é€ŸéªŒè¯

**3. é‡å¤å…³ç³»æ£€æŸ¥**ï¼š

-   æ£€æŸ¥ `(source_entity_id, target_entity_id, relationship_type, role, semantic_type)` çš„å”¯ä¸€æ€§
-   å¯¹äºæŠ½è±¡å…³ç³»ç±»å‹ï¼Œéœ€è¦è€ƒè™‘ `role` æˆ– `semanticType` çš„ç»„åˆå”¯ä¸€æ€§
-   ä¾‹å¦‚ï¼šåŒä¸€äººå‘˜å¯ä»¥åŒæ—¶æ˜¯åˆ†ç±»çš„"é¡¹ç›®ç»ç†"å’Œ"å®¡æ ¸äºº"ï¼ˆä¸åŒçš„ roleï¼‰ï¼Œä½†åŒä¸€ role ä¸å…è®¸é‡å¤
-   æŸäº›å…³ç³»ç±»å‹ä¸å…è®¸é‡å¤ï¼ˆå¦‚"åˆ†ç±»åŒ…å«æ–‡ä»¶"ï¼‰
-   æŸäº›å…³ç³»ç±»å‹å…è®¸é‡å¤ä½†éœ€è¦å”¯ä¸€æ€§çº¦æŸï¼ˆå¦‚"æ–‡ä»¶ä¸‹è½½è®°å½•"ï¼‰

**4. å¾ªç¯å…³ç³»æ£€æŸ¥**ï¼š

-   å¯¹äºæ ‘å½¢å…³ç³»ï¼ˆå¦‚`CatalogueHasChild`ï¼‰ï¼Œæ£€æŸ¥æ˜¯å¦ä¼šå¯¼è‡´å¾ªç¯
-   ä½¿ç”¨ Apache AGE è·¯å¾„æŸ¥è¯¢æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä»ç›®æ ‡å®ä½“åˆ°æºå®ä½“çš„è·¯å¾„
-   é˜²æ­¢åˆ›å»ºå¯¼è‡´å¾ªç¯çš„å…³ç³»

**5. æƒé™éªŒè¯**ï¼š

-   **æºå®ä½“æƒé™**ï¼šåˆ›å»ºå…³ç³»éœ€è¦æºå®ä½“çš„ `Write` æƒé™
-   **ç›®æ ‡å®ä½“æƒé™**ï¼šè‡³å°‘éœ€è¦ç›®æ ‡å®ä½“çš„ `Read` æƒé™
-   ä½¿ç”¨ `AttachCatalogue.HasPermission()` æ–¹æ³•è¿›è¡Œæƒé™æ£€æŸ¥

#### 7.2.3 æ•°æ®ä¸€è‡´æ€§ä¿è¯

**1. äº‹åŠ¡å¤„ç†**ï¼š

-   å…³ç³»åˆ›å»ºåœ¨æ•°æ®åº“äº‹åŠ¡ä¸­æ‰§è¡Œ
-   ç¡®ä¿ PostgreSQL å’Œ Apache AGE å›¾æ•°æ®çš„ä¸€è‡´æ€§ï¼ˆç»Ÿä¸€æ•°æ®åº“ï¼ŒåŸç”Ÿäº‹åŠ¡æ”¯æŒï¼‰

**2. å¼‚æ­¥åŒæ­¥**ï¼š

-   Apache AGE å›¾æ•°æ®åŒæ­¥ä½¿ç”¨ ABP åå°ä½œä¸šå¼‚æ­¥å¤„ç†
-   å¦‚æœå›¾æ•°æ®åŒæ­¥å¤±è´¥ï¼Œåå°ä½œä¸šä¼šè‡ªåŠ¨é‡è¯•
-   ä¸å½±å“ä¸»ä¸šåŠ¡æµç¨‹çš„å“åº”é€Ÿåº¦

**3. è¡¥å¿æœºåˆ¶**ï¼š

-   å¦‚æœå›¾æ•°æ®åŒæ­¥å¤±è´¥ï¼Œè®°å½•å¤±è´¥æ—¥å¿—
-   æä¾›æ‰‹åŠ¨é‡è¯•æœºåˆ¶
-   å®šæœŸæ£€æŸ¥å¹¶ä¿®å¤æ•°æ®ä¸ä¸€è‡´é—®é¢˜

#### 7.2.4 è‡ªåŠ¨å…³ç³»åˆ›å»º

æŸäº›å…³ç³»å¯ä»¥æ ¹æ®ä¸šåŠ¡è§„åˆ™è‡ªåŠ¨åˆ›å»ºï¼š

**1. åˆ†ç±»åˆ›å»ºæ—¶è‡ªåŠ¨åˆ›å»ºå…³ç³»**ï¼š

-   å½“åˆ†ç±»æœ‰çˆ¶åˆ†ç±»æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `CatalogueHasChild` å…³ç³»
-   å½“åˆ†ç±»å¼•ç”¨ä¸šåŠ¡å®ä½“æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `CatalogueReferencesBusiness` å…³ç³»
-   å½“åˆ†ç±»ç”±äººå‘˜åˆ›å»ºæ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Creator`

**2. åˆ†ç±»å…³ç³»è‡ªåŠ¨åˆ›å»ºï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰**ï¼š

-   å½“åˆ†ç±»åˆ›å»ºæ—¶ï¼Œå¦‚æœå­˜åœ¨åŒä¸€ä¸šåŠ¡å®ä½“çš„å…¶ä»–åˆ†ç±»ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»º `CatalogueRelatesToCatalogue` å…³ç³»ï¼Œ`semanticType` è®¾ç½®ä¸º `Temporal`ï¼ˆåŸºäºåˆ›å»ºæ—¶é—´ï¼‰
-   å½“åˆ†ç±»æ›´æ–°æ—¶ï¼Œå¦‚æœå­˜åœ¨ä¸šåŠ¡ç›¸å…³çš„å…¶ä»–åˆ†ç±»ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»º `CatalogueRelatesToCatalogue` å…³ç³»ï¼Œ`semanticType` è®¾ç½®ä¸º `Business`
-   å½“åˆ†ç±»æœ‰ç‰ˆæœ¬æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `CatalogueRelatesToCatalogue` å…³ç³»ï¼Œ`semanticType` è®¾ç½®ä¸º `Version`
-   å½“åˆ†ç±»æ›¿æ¢å…¶ä»–åˆ†ç±»æ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `CatalogueRelatesToCatalogue` å…³ç³»ï¼Œ`semanticType` è®¾ç½®ä¸º `Replaces`

**3. äººå‘˜ä¸éƒ¨é—¨å…³ç³»è‡ªåŠ¨åˆ›å»º**ï¼š

-   å½“äººå‘˜åˆ›å»ºåˆ†ç±»æ—¶ï¼Œå¦‚æœäººå‘˜æœ‰éƒ¨é—¨ä¿¡æ¯ï¼Œè‡ªåŠ¨åˆ›å»º `PersonBelongsToDepartment` å…³ç³»ï¼ˆå¦‚æœå°šæœªå­˜åœ¨ï¼‰
-   å½“åˆ†ç±»åˆ›å»ºæ—¶ï¼Œå¦‚æœåˆ†ç±»å…³è”éƒ¨é—¨ï¼Œè‡ªåŠ¨åˆ›å»º `DepartmentOwnsCatalogue` å…³ç³»

**4. äººå‘˜è§’è‰²å…³ç³»è‡ªåŠ¨åˆ›å»ºï¼ˆä»æ–‡ä»¶å†…å®¹å’Œå…ƒæ•°æ®æå–ï¼‰**ï¼š

-   **ä»æ–‡ä»¶å†…å®¹æå–**ï¼šé€šè¿‡ OCR å’Œå®ä½“è¯†åˆ«ï¼Œä»åˆ†ç±»åŒ…å«çš„æ–‡ä»¶å†…å®¹ä¸­æå–äººå‘˜è§’è‰²ä¿¡æ¯
    -   æå–é¡¹ç›®ç»ç†ï¼šè¯†åˆ«"é¡¹ç›®ç»ç†"ã€"é¡¹ç›®è´Ÿè´£äºº"ç­‰å…³é”®è¯ï¼Œåˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `ProjectManager`
    -   æå–å®¡æ ¸äººï¼šè¯†åˆ«"å®¡æ ¸äºº"ã€"å®¡æ‰¹äºº"ã€"å®¡æ ¸"ç­‰å…³é”®è¯ï¼Œåˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Reviewer`
    -   æå–ä¸“å®¶ï¼šè¯†åˆ«"ä¸“å®¶"ã€"é¡¾é—®"ã€"å’¨è¯¢"ç­‰å…³é”®è¯ï¼Œåˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Expert`
    -   æå–è´£ä»»äººï¼šè¯†åˆ«"è´£ä»»äºº"ã€"è´Ÿè´£äºº"ã€"ç»åŠäºº"ç­‰å…³é”®è¯ï¼Œåˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Responsible`
    -   æå–è”ç³»äººï¼šè¯†åˆ«"è”ç³»äºº"ã€"è”ç³»æ–¹å¼"ç­‰å…³é”®è¯ï¼Œåˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Contact`
    -   æå–å‚ä¸äººï¼šè¯†åˆ«"å‚ä¸äºº"ã€"å‚ä¸è€…"ã€"æˆå‘˜"ç­‰å…³é”®è¯ï¼Œåˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Participant`
-   **ä»å…ƒæ•°æ®å­—æ®µæå–**ï¼šä»åˆ†ç±»çš„ `MetaFields` ä¸­æå–äººå‘˜è§’è‰²ä¿¡æ¯
    -   å¦‚æœå…ƒæ•°æ®å­—æ®µåŒ…å«"é¡¹ç›®ç»ç†"ã€"å®¡æ ¸äºº"ã€"ä¸“å®¶"ç­‰è§’è‰²å­—æ®µï¼Œè‡ªåŠ¨åˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸ºå¯¹åº”çš„è§’è‰²å€¼
-   **ä»å·¥ä½œæµæå–**ï¼šä»å·¥ä½œæµå®¡æ‰¹è®°å½•ä¸­æå–å®¡æ ¸äººä¿¡æ¯
    -   å½“å·¥ä½œæµå®¡æ‰¹å®Œæˆæ—¶ï¼Œè‡ªåŠ¨åˆ›å»º `PersonRelatesToCatalogue` å…³ç³»ï¼Œ`role` è®¾ç½®ä¸º `Reviewer`

```csharp
// åœ¨CatalogueCreatedHandlerä¸­è‡ªåŠ¨åˆ›å»ºå…³ç³»
public class CatalogueCreatedHandler : ILocalEventHandler<EntityCreatedEventData<AttachCatalogue>>, ITransientDependency
{
    private readonly IKnowledgeGraphService _knowledgeGraphService;

    public async Task HandleEventAsync(EntityCreatedEventData<AttachCatalogue> eventData)
    {
        var catalogue = eventData.Entity;

        // è‡ªåŠ¨åˆ›å»ºçˆ¶å­å…³ç³»
        if (catalogue.ParentId.HasValue)
        {
            await _knowledgeGraphService.CreateRelationshipAsync(new CreateRelationshipInput
            {
                SourceEntityId = catalogue.ParentId.Value,
                SourceEntityType = "Catalogue",
                TargetEntityId = catalogue.Id,
                TargetEntityType = "Catalogue",
                RelationshipType = RelationshipType.CatalogueHasChild,
                Description = "åˆ†ç±»åˆ›å»ºè‡ªåŠ¨åˆ›å»º",
                Properties = new Dictionary<string, object>
                {
                    ["autoCreated"] = true,
                    ["createdReason"] = "åˆ†ç±»åˆ›å»º"
                }
            });
        }

        // è‡ªåŠ¨åˆ›å»ºäººå‘˜åˆ›å»ºå…³ç³»
        if (catalogue.CreatorId.HasValue)
        {
            await _knowledgeGraphService.CreateRelationshipAsync(new CreateRelationshipInput
            {
                SourceEntityId = catalogue.CreatorId.Value,
                SourceEntityType = "Person",
                TargetEntityId = catalogue.Id,
                TargetEntityType = "Catalogue",
                RelationshipType = RelationshipType.PersonRelatesToCatalogue,
                Role = PersonRole.Creator.ToString(), // è®¾ç½®è§’è‰²ä¸º Creator
                Description = "åˆ†ç±»åˆ›å»ºè‡ªåŠ¨åˆ›å»º",
                Properties = new Dictionary<string, object>
                {
                    ["autoCreated"] = true,
                    ["createdReason"] = "åˆ†ç±»åˆ›å»º"
                }
            });
        }

        // ä»å…ƒæ•°æ®å­—æ®µæå–äººå‘˜è§’è‰²å…³ç³»
        await ExtractPersonRoleRelationshipsFromMetaFieldsAsync(catalogue);
    }

    /// <summary>
    /// ä»å…ƒæ•°æ®å­—æ®µæå–äººå‘˜è§’è‰²å…³ç³»
    /// </summary>
    private async Task ExtractPersonRoleRelationshipsFromMetaFieldsAsync(AttachCatalogue catalogue)
    {
        if (catalogue.MetaFields == null || catalogue.MetaFields.Count == 0)
            return;

        // å®šä¹‰è§’è‰²å­—æ®µæ˜ å°„ï¼ˆä½¿ç”¨æŠ½è±¡å…³ç³»ç±»å‹å’Œè§’è‰²æšä¸¾ï¼‰
        var roleFieldMappings = new Dictionary<string, PersonRole>
        {
            ["é¡¹ç›®ç»ç†"] = PersonRole.ProjectManager,
            ["é¡¹ç›®è´Ÿè´£äºº"] = PersonRole.ProjectManager,
            ["å®¡æ ¸äºº"] = PersonRole.Reviewer,
            ["å®¡æ‰¹äºº"] = PersonRole.Reviewer,
            ["ä¸“å®¶"] = PersonRole.Expert,
            ["é¡¾é—®"] = PersonRole.Expert,
            ["è´£ä»»äºº"] = PersonRole.Responsible,
            ["è´Ÿè´£äºº"] = PersonRole.Responsible,
            ["ç»åŠäºº"] = PersonRole.Responsible,
            ["è”ç³»äºº"] = PersonRole.Contact,
            ["å‚ä¸äºº"] = PersonRole.Participant,
            ["å‚ä¸è€…"] = PersonRole.Participant
        };

        foreach (var metaField in catalogue.MetaFields)
        {
            if (!metaField.IsEnabled || string.IsNullOrEmpty(metaField.FieldName))
                continue;

            // æ£€æŸ¥å­—æ®µåæ˜¯å¦åŒ¹é…è§’è‰²ç±»å‹
            var fieldName = metaField.FieldName.Trim();
            if (roleFieldMappings.TryGetValue(fieldName, out var role))
            {
                // ä»å­—æ®µå€¼ä¸­æå–äººå‘˜IDï¼ˆå‡è®¾å­—æ®µå€¼å­˜å‚¨çš„æ˜¯äººå‘˜IDæˆ–äººå‘˜å§“åï¼‰
                var personId = await ExtractPersonIdFromMetaFieldValueAsync(metaField.FieldValue);
                if (personId.HasValue)
                {
                    await _knowledgeGraphService.CreateRelationshipAsync(new CreateRelationshipInput
                    {
                        SourceEntityId = personId.Value,
                        SourceEntityType = "Person",
                        TargetEntityId = catalogue.Id,
                        TargetEntityType = "Catalogue",
                        RelationshipType = RelationshipType.PersonRelatesToCatalogue,
                        Role = role.ToString(), // ä½¿ç”¨æŠ½è±¡å…³ç³»ç±»å‹ï¼Œé€šè¿‡ role å±æ€§åŒºåˆ†å…·ä½“è§’è‰²
                        Description = $"ä»å…ƒæ•°æ®å­—æ®µ'{fieldName}'è‡ªåŠ¨æå–",
                        Properties = new Dictionary<string, object>
                        {
                            ["autoCreated"] = true,
                            ["createdReason"] = "å…ƒæ•°æ®å­—æ®µæå–",
                            ["sourceField"] = fieldName,
                            ["sourceFieldValue"] = metaField.FieldValue
                        }
                    });
                }
            }
        }
    }

    /// <summary>
    /// ä»å…ƒæ•°æ®å­—æ®µå€¼ä¸­æå–äººå‘˜ID
    /// </summary>
    private async Task<Guid?> ExtractPersonIdFromMetaFieldValueAsync(string? fieldValue)
    {
        if (string.IsNullOrWhiteSpace(fieldValue))
            return null;

        // å¦‚æœå­—æ®µå€¼æ˜¯GUIDï¼Œç›´æ¥è¿”å›
        if (Guid.TryParse(fieldValue, out var personId))
            return personId;

        // å¦‚æœå­—æ®µå€¼æ˜¯äººå‘˜å§“åï¼Œéœ€è¦é€šè¿‡ç”¨æˆ·ç³»ç»ŸæŸ¥è¯¢äººå‘˜ID
        // var person = await _userRepository.FindByNameAsync(fieldValue);
        // return person?.Id;

        return null; // ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…å®ç°éœ€è¦æŸ¥è¯¢ç”¨æˆ·ç³»ç»Ÿ
    }
}

// æ–‡ä»¶å†…å®¹åˆ†æåè‡ªåŠ¨åˆ›å»ºäººå‘˜è§’è‰²å…³ç³»
public class FileContentAnalyzedHandler : ILocalEventHandler<FileContentAnalyzedEventData>, ITransientDependency
{
    private readonly IKnowledgeGraphService _knowledgeGraphService;
    private readonly IRepository<AttachCatalogue, Guid> _catalogueRepository;

    public async Task HandleEventAsync(FileContentAnalyzedEventData eventData)
    {
        var file = eventData.File;
        if (!file.AttachCatalogueId.HasValue)
            return;

        var catalogue = await _catalogueRepository.GetAsync(file.AttachCatalogueId.Value);

        // ä»OCRå†…å®¹ä¸­æå–äººå‘˜è§’è‰²ä¿¡æ¯
        if (!string.IsNullOrWhiteSpace(file.OcrContent))
        {
            await ExtractPersonRoleRelationshipsFromContentAsync(catalogue, file.OcrContent);
        }
    }

    /// <summary>
    /// ä»æ–‡ä»¶å†…å®¹ä¸­æå–äººå‘˜è§’è‰²å…³ç³»
    /// </summary>
    private async Task ExtractPersonRoleRelationshipsFromContentAsync(AttachCatalogue catalogue, string content)
    {
        // ä½¿ç”¨å®ä½“è¯†åˆ«æœåŠ¡æå–äººå‘˜ä¿¡æ¯
        // var entityRecognitionService = AIServiceFactory.GetEntityRecognitionService();
        // var recognitionResult = await entityRecognitionService.RecognizeEntitiesAsync(new EntityRecognitionInputDto
        // {
        //     Text = content,
        //     EntityTypes = ["Person", "Role"]
        // });

        // å®šä¹‰è§’è‰²å…³é”®è¯æ¨¡å¼ï¼ˆä½¿ç”¨æŠ½è±¡å…³ç³»ç±»å‹å’Œè§’è‰²æšä¸¾ï¼‰
        var rolePatterns = new Dictionary<string, PersonRole>
        {
            [@"é¡¹ç›®ç»ç†[ï¼š:]\s*(\S+)"] = PersonRole.ProjectManager,
            [@"é¡¹ç›®è´Ÿè´£äºº[ï¼š:]\s*(\S+)"] = PersonRole.ProjectManager,
            [@"å®¡æ ¸äºº[ï¼š:]\s*(\S+)"] = PersonRole.Reviewer,
            [@"å®¡æ‰¹äºº[ï¼š:]\s*(\S+)"] = PersonRole.Reviewer,
            [@"ä¸“å®¶[ï¼š:]\s*(\S+)"] = PersonRole.Expert,
            [@"é¡¾é—®[ï¼š:]\s*(\S+)"] = PersonRole.Expert,
            [@"è´£ä»»äºº[ï¼š:]\s*(\S+)"] = PersonRole.Responsible,
            [@"è´Ÿè´£äºº[ï¼š:]\s*(\S+)"] = PersonRole.Responsible,
            [@"è”ç³»äºº[ï¼š:]\s*(\S+)"] = PersonRole.Contact,
            [@"å‚ä¸äºº[ï¼š:]\s*(\S+)"] = PersonRole.Participant
        };

        foreach (var pattern in rolePatterns)
        {
            var matches = Regex.Matches(content, pattern.Key, RegexOptions.IgnoreCase);
            foreach (Match match in matches)
            {
                if (match.Groups.Count > 1)
                {
                    var personName = match.Groups[1].Value.Trim();
                    // é€šè¿‡äººå‘˜å§“åæŸ¥è¯¢äººå‘˜ID
                    var personId = await FindPersonIdByNameAsync(personName);
                    if (personId.HasValue)
                    {
                        await _knowledgeGraphService.CreateRelationshipAsync(new CreateRelationshipInput
                        {
                            SourceEntityId = personId.Value,
                            SourceEntityType = "Person",
                            TargetEntityId = catalogue.Id,
                            TargetEntityType = "Catalogue",
                            RelationshipType = RelationshipType.PersonRelatesToCatalogue,
                            Role = pattern.Value.ToString(), // ä½¿ç”¨æŠ½è±¡å…³ç³»ç±»å‹ï¼Œé€šè¿‡ role å±æ€§åŒºåˆ†å…·ä½“è§’è‰²
                            Description = $"ä»æ–‡ä»¶å†…å®¹è‡ªåŠ¨æå–ï¼š{personName}",
                            Properties = new Dictionary<string, object>
                            {
                                ["autoCreated"] = true,
                                ["createdReason"] = "æ–‡ä»¶å†…å®¹æå–",
                                ["extractedText"] = match.Value,
                                ["personName"] = personName
                            }
                        });
                    }
                }
            }
        }
    }

    private async Task<Guid?> FindPersonIdByNameAsync(string personName)
    {
        // é€šè¿‡ç”¨æˆ·ç³»ç»ŸæŸ¥è¯¢äººå‘˜ID
        // var person = await _userRepository.FindByNameAsync(personName);
        // return person?.Id;
        return null; // ç®€åŒ–ç¤ºä¾‹ï¼Œå®é™…å®ç°éœ€è¦æŸ¥è¯¢ç”¨æˆ·ç³»ç»Ÿ
    }
}
```

### 7.3 æ•°æ®åŒæ­¥æ–¹æ¡ˆ

#### 7.2.1 æ•°æ®åŒæ­¥æµç¨‹

```
PostgreSQL (ä¸šåŠ¡æ•°æ®)
    â†“ (ABP Entity Change Events)
é¢†åŸŸäº‹ä»¶å¤„ç†å™¨
    â†“ (ABP Background Jobs)
æ•°æ®åŒæ­¥æœåŠ¡
    â†“
Neo4j (å›¾æ•°æ®åº“)
PostgreSQL (å…¨æ–‡æœç´¢ç´¢å¼•æ›´æ–°)
```

#### 7.2.2 é¢†åŸŸäº‹ä»¶å¤„ç†å™¨ï¼ˆåŸºäº ABP å®ä½“å˜æ›´äº‹ä»¶ï¼‰

```csharp
// CatalogueGraphSyncEventHandler.cs
using Volo.Abp.DependencyInjection;
using Volo.Abp.Domain.Entities.Events;
using Volo.Abp.EventBus;

public class CatalogueGraphSyncEventHandler :
    ILocalEventHandler<EntityCreatedEventData<AttachCatalogue>>,
    ILocalEventHandler<EntityUpdatedEventData<AttachCatalogue>>,
    ILocalEventHandler<EntityDeletedEventData<AttachCatalogue>>,
    ITransientDependency
{
    private readonly IKnowledgeGraphSyncService _syncService;

    public CatalogueGraphSyncEventHandler(IKnowledgeGraphSyncService syncService)
    {
        _syncService = syncService;
    }

    public async Task HandleEventAsync(EntityCreatedEventData<AttachCatalogue> eventData)
    {
        await _syncService.SyncEntityAsync(
            eventData.Entity.Id,
            "Catalogue",
            "CREATE",
            eventData.Entity
        );
    }

    public async Task HandleEventAsync(EntityUpdatedEventData<AttachCatalogue> eventData)
    {
        await _syncService.SyncEntityAsync(
            eventData.Entity.Id,
            "Catalogue",
            "UPDATE",
            eventData.Entity
        );
    }

    public async Task HandleEventAsync(EntityDeletedEventData<AttachCatalogue> eventData)
    {
        await _syncService.SyncEntityAsync(
            eventData.Entity.Id,
            "Catalogue",
            "DELETE",
            null
        );
    }
}

// æ³¨æ„ï¼šFile å’Œ Template ä¸å†æ˜¯çŸ¥è¯†å›¾è°±çš„ç‹¬ç«‹ç»´åº¦
// File é€šè¿‡ Catalogue ç›´æ¥è®¿é—®ï¼ŒTemplate ä¿¡æ¯å·²ä½“ç°åœ¨ Catalogue ä¸­
// å› æ­¤ä¸éœ€è¦å•ç‹¬çš„ FileGraphSyncEventHandler å’Œ TemplateGraphSyncEventHandler
```

#### 7.2.3 çŸ¥è¯†å›¾è°±åŒæ­¥æœåŠ¡

```csharp
// IKnowledgeGraphSyncService.cs
public interface IKnowledgeGraphSyncService
{
    /// <summary>
    /// åŒæ­¥å®ä½“åˆ°çŸ¥è¯†å›¾è°±ï¼ˆå¼‚æ­¥å¤„ç†ï¼Œä½¿ç”¨åå°ä½œä¸šï¼‰
    /// </summary>
    Task SyncEntityAsync(Guid entityId, string entityType, string operation, object? entityData = null);
}

// KnowledgeGraphSyncService.cs
public class KnowledgeGraphSyncService : IKnowledgeGraphSyncService, ITransientDependency
{
    private readonly IBackgroundJobManager _backgroundJobManager;
    private readonly ILogger<KnowledgeGraphSyncService> _logger;

    public KnowledgeGraphSyncService(
        IBackgroundJobManager backgroundJobManager,
        ILogger<KnowledgeGraphSyncService> logger)
    {
        _backgroundJobManager = backgroundJobManager;
        _logger = logger;
    }

    /// <summary>
    /// åŒæ­¥å®ä½“åˆ°çŸ¥è¯†å›¾è°±ï¼ˆä½¿ç”¨ABPåå°ä½œä¸šå¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹ï¼‰
    /// </summary>
    public async Task SyncEntityAsync(Guid entityId, string entityType, string operation, object? entityData = null)
    {
        try
        {
            // ä½¿ç”¨ABPåå°ä½œä¸šå¼‚æ­¥å¤„ç†ï¼Œé¿å…é˜»å¡ä¸»ä¸šåŠ¡æµç¨‹
            await _backgroundJobManager.EnqueueAsync(
                new KnowledgeGraphSyncJobArgs
                {
                    EntityId = entityId,
                    EntityType = entityType,
                    Operation = operation
                },
                delay: TimeSpan.Zero // ç«‹å³æ‰§è¡Œ
            );

            _logger.LogDebug(
                "çŸ¥è¯†å›¾è°±åŒæ­¥ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—: EntityId={EntityId}, EntityType={EntityType}, Operation={Operation}",
                entityId, entityType, operation
            );
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "çŸ¥è¯†å›¾è°±åŒæ­¥ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—å¤±è´¥: EntityId={EntityId}, EntityType={EntityType}, Operation={Operation}",
                entityId, entityType, operation
            );
            // ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¿å…å½±å“ä¸»ä¸šåŠ¡æµç¨‹
        }
    }
}

// åå°ä½œä¸šå‚æ•°
public class KnowledgeGraphSyncJobArgs
{
    public Guid EntityId { get; set; }
    public string EntityType { get; set; }
    public string Operation { get; set; }
}

// åå°ä½œä¸šå¤„ç†å™¨ï¼ˆApache AGE ç‰ˆæœ¬ï¼‰
public class KnowledgeGraphSyncJob : AsyncBackgroundJob<KnowledgeGraphSyncJobArgs>, ITransientDependency
{
    private readonly IDbContextProvider<AttachmentDbContext> _dbContextProvider;
    private readonly IRepository<KnowledgeGraphEntityGraphMetadata, Guid> _graphMetadataRepository;
    private readonly IRepository<AttachCatalogue, Guid> _catalogueRepository;
    private readonly ILogger<KnowledgeGraphSyncJob> _logger;
    private const string GraphName = "kg_graph";

    public KnowledgeGraphSyncJob(
        IDbContextProvider<AttachmentDbContext> dbContextProvider,
        IRepository<KnowledgeGraphEntityGraphMetadata, Guid> graphMetadataRepository,
        IRepository<AttachCatalogue, Guid> catalogueRepository,
        ILogger<KnowledgeGraphSyncJob> logger)
    {
        _dbContextProvider = dbContextProvider;
        _graphMetadataRepository = graphMetadataRepository;
        _catalogueRepository = catalogueRepository;
        _logger = logger;
    }

    public override async Task ExecuteAsync(KnowledgeGraphSyncJobArgs args)
    {
        try
        {
            var entityProperties = await GetEntityPropertiesAsync(args.EntityId, args.EntityType);

            switch (args.Operation.ToUpper())
            {
                case "CREATE":
                case "UPDATE":
                    await SyncEntityToAgeGraph(args.EntityId, args.EntityType, entityProperties);
                    await UpdateFullTextSearchIndex(args.EntityId, args.EntityType, entityProperties);
                    break;
                case "DELETE":
                    await DeleteEntityFromAgeGraph(args.EntityId, args.EntityType);
                    await DeleteFullTextSearchIndex(args.EntityId, args.EntityType);
                    break;
            }

            _logger.LogInformation(
                "çŸ¥è¯†å›¾è°±åŒæ­¥æˆåŠŸ: EntityId={EntityId}, EntityType={EntityType}, Operation={Operation}",
                args.EntityId, args.EntityType, args.Operation
            );
        }
        catch (Exception ex)
        {
            _logger.LogError(ex,
                "çŸ¥è¯†å›¾è°±åŒæ­¥å¤±è´¥: EntityId={EntityId}, EntityType={EntityType}, Operation={Operation}",
                args.EntityId, args.EntityType, args.Operation
            );
            throw; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ï¼Œè®©ABPåå°ä½œä¸šç®¡ç†å™¨é‡è¯•
        }
    }

    /// <summary>
    /// ä»ç°æœ‰å®ä½“è¡¨è·å–å®ä½“å±æ€§
    /// </summary>
    private async Task<Dictionary<string, object>> GetEntityPropertiesAsync(Guid entityId, string entityType)
    {
        return entityType switch
        {
            "Catalogue" => await GetCataloguePropertiesAsync(entityId),
            "Person" => await GetPersonPropertiesAsync(entityId),
            "Department" => await GetDepartmentPropertiesAsync(entityId),
            "BusinessEntity" => await GetBusinessEntityPropertiesAsync(entityId),
            "Workflow" => await GetWorkflowPropertiesAsync(entityId),
            _ => new Dictionary<string, object>()
        };
    }

    private async Task<Dictionary<string, object>> GetCataloguePropertiesAsync(Guid catalogueId)
    {
        var catalogue = await _catalogueRepository.GetAsync(catalogueId);
        return new Dictionary<string, object>
        {
            ["name"] = catalogue.CatalogueName,
            ["reference"] = catalogue.Reference,
            ["referenceType"] = catalogue.ReferenceType,
            ["facetType"] = catalogue.CatalogueFacetType,
            ["tags"] = catalogue.Tags ?? new List<string>(),
            ["isArchived"] = catalogue.IsArchived,
            ["attachCount"] = catalogue.AttachCount
        };
    }

    private async Task<Dictionary<string, object>> GetPersonPropertiesAsync(Guid personId)
    {
        // ä»ç”¨æˆ·ç³»ç»Ÿè·å–äººå‘˜ä¿¡æ¯
        // var person = await _userRepository.GetAsync(personId);
        return new Dictionary<string, object>
        {
            ["employeeId"] = "", // person.EmployeeId,
            ["departmentId"] = null, // person.DepartmentId,
            // å…¶ä»–å­—æ®µä»ç”¨æˆ·ç³»ç»Ÿè·å–
        };
    }

    private async Task<Dictionary<string, object>> GetDepartmentPropertiesAsync(Guid departmentId)
    {
        // ä»ç»„ç»‡ç³»ç»Ÿè·å–éƒ¨é—¨ä¿¡æ¯
        // var department = await _departmentRepository.GetAsync(departmentId);
        return new Dictionary<string, object>
        {
            ["departmentCode"] = "", // department.DepartmentCode,
            ["parentDepartmentId"] = null, // department.ParentDepartmentId,
            // å…¶ä»–å­—æ®µä»ç»„ç»‡ç³»ç»Ÿè·å–
        };
    }

    private async Task<Dictionary<string, object>> GetBusinessEntityPropertiesAsync(Guid businessEntityId)
    {
        // ä»å¤–éƒ¨ä¸šåŠ¡ç³»ç»Ÿè·å–ä¸šåŠ¡å®ä½“ä¿¡æ¯
        // æ ¹æ®ReferenceTypeæŸ¥è¯¢å¯¹åº”çš„ä¸šåŠ¡ç³»ç»Ÿ
        return new Dictionary<string, object>
        {
            ["referenceId"] = "",
            ["referenceType"] = 0,
            ["businessType"] = "",
            // å…¶ä»–å­—æ®µä»å¤–éƒ¨ä¸šåŠ¡ç³»ç»Ÿè·å–
        };
    }

    private async Task<Dictionary<string, object>> GetWorkflowPropertiesAsync(Guid workflowId)
    {
        // ä»å·¥ä½œæµå¼•æ“è·å–å·¥ä½œæµä¿¡æ¯
        // var workflow = await _workflowRepository.GetAsync(workflowId);
        return new Dictionary<string, object>
        {
            ["workflowCode"] = "", // workflow.WorkflowCode,
            ["workflowType"] = "", // workflow.WorkflowType,
            ["status"] = "", // workflow.Status,
            ["templateDefinitionId"] = null, // workflow.TemplateDefinitionId,
            ["templateDefinitionVersion"] = 0, // workflow.TemplateDefinitionVersion,
            ["ownerDepartmentId"] = null, // workflow.OwnerDepartmentId,
            ["managerPersonId"] = null, // workflow.ManagerPersonId,
            // å…¶ä»–å­—æ®µä»å·¥ä½œæµå¼•æ“è·å–
        };
    }

    /// <summary>
    /// åŒæ­¥å®ä½“åˆ° Apache AGE å›¾æ•°æ®åº“
    /// </summary>
    private async Task SyncEntityToAgeGraph(Guid entityId, string entityType, Dictionary<string, object> entityProperties)
    {
        var dbContext = await _dbContextProvider.GetDbContextAsync();
        var connection = dbContext.Database.GetDbConnection() as NpgsqlConnection;

        if (connection == null)
            throw new InvalidOperationException("Database connection is not NpgsqlConnection");

        var cypherQuery = $@"
            MERGE (e:Entity {{id: $id}})
            SET e.type = $type,
                e.name = $name,
                e.tags = $tags,
                e.properties = $properties,
                e.updatedTime = $updatedTime
            RETURN e";

        var sqlQuery = $@"
            SELECT * FROM cypher('{GraphName}', ${cypherQuery}$$, $1) AS (e agtype)";

        await using var command = new NpgsqlCommand(sqlQuery, connection);
        command.Parameters.AddWithValue("cypherQuery", cypherQuery);
        command.Parameters.AddWithValue("$1", JsonSerializer.Serialize(new
        {
            id = entityId.ToString(),
            type = entityType,
            name = entityProperties.GetValueOrDefault("name")?.ToString() ?? "",
            tags = entityProperties.GetValueOrDefault("tags") as string[] ?? Array.Empty<string>(),
            properties = entityProperties,
            updatedTime = DateTime.UtcNow
        }));

        await command.ExecuteNonQueryAsync();
    }

    private async Task UpdateEntityInAgeGraph(Guid entityId, string entityType, Dictionary<string, object> entityProperties)
    {
        await SyncEntityToAgeGraph(entityId, entityType, entityProperties); // æ›´æ–°é€»è¾‘ä¸åˆ›å»ºç›¸åŒ
    }

    private async Task DeleteEntityFromAgeGraph(Guid entityId, string entityType)
    {
        var dbContext = await _dbContextProvider.GetDbContextAsync();
        var connection = dbContext.Database.GetDbConnection() as NpgsqlConnection;

        if (connection == null)
            throw new InvalidOperationException("Database connection is not NpgsqlConnection");

        var cypherQuery = "MATCH (e:Entity {id: $id}) DETACH DELETE e";
        var sqlQuery = $@"
            SELECT * FROM cypher('{GraphName}', ${cypherQuery}$$, $1) AS (result agtype)";

        await using var command = new NpgsqlCommand(sqlQuery, connection);
        command.Parameters.AddWithValue("cypherQuery", cypherQuery);
        command.Parameters.AddWithValue("$1", JsonSerializer.Serialize(new { id = entityId.ToString() }));

        await command.ExecuteNonQueryAsync();
    }

    /// <summary>
    /// æ›´æ–°PostgreSQLå…¨æ–‡æœç´¢ç´¢å¼•
    /// </summary>
    private async Task UpdateFullTextSearchIndex(Guid entityId, string entityType, Dictionary<string, object> entityProperties)
    {
        // æ›´æ–°æˆ–åˆ›å»ºå›¾å…ƒæ•°æ®è®°å½•ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰
        var metadata = await _graphMetadataRepository.FindAsync(entityId);
        if (metadata == null)
        {
            metadata = new KnowledgeGraphEntityGraphMetadata
            {
                EntityId = entityId,
                EntityType = entityType,
                GraphProperties = entityProperties,
                Tags = entityProperties.GetValueOrDefault("tags") as List<string> ?? new List<string>(),
                LastGraphUpdate = DateTime.UtcNow
            };
            await _graphMetadataRepository.InsertAsync(metadata);
        }
        else
        {
            metadata.GraphProperties = entityProperties;
            metadata.Tags = entityProperties.GetValueOrDefault("tags") as List<string> ?? new List<string>();
            metadata.LastGraphUpdate = DateTime.UtcNow;
            await _graphMetadataRepository.UpdateAsync(metadata);
        }
    }

    /// <summary>
    /// åˆ é™¤PostgreSQLå…¨æ–‡æœç´¢ç´¢å¼•
    /// </summary>
    private async Task DeleteFullTextSearchIndex(Guid entityId, string entityType)
    {
        var metadata = await _graphMetadataRepository.FindAsync(entityId);
        if (metadata != null)
        {
            await _graphMetadataRepository.DeleteAsync(metadata);
        }
    }

    /// <summary>
    /// åŒæ­¥å…³ç³»åˆ°Neo4j
    /// </summary>
    public async Task SyncRelationshipToNeo4jAsync(KnowledgeGraphRelationship relationship)
    {
        var session = _neo4jDriver.AsyncSession();
        try
        {
            // è·å–æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹çš„æ ‡ç­¾ï¼ˆæ ¹æ®å®ä½“ç±»å‹ï¼‰
            var sourceLabel = GetEntityLabel(relationship.SourceEntityType);
            var targetLabel = GetEntityLabel(relationship.TargetEntityType);
            var relType = GetNeo4jRelationshipType(relationship.Type);

            var query = $@"
                MATCH (source:{sourceLabel} {{id: $sourceId}})
                MATCH (target:{targetLabel} {{id: $targetId}})
                MERGE (source)-[r:{relType} {{id: $relId}}]->(target)
                SET r.description = $description,
                    r.weight = $weight,
                    r.properties = $properties,
                    r.createdTime = $createdTime,
                    r.updatedTime = $updatedTime
                RETURN r";

            await session.RunAsync(query, new
            {
                sourceId = relationship.SourceEntityId.ToString(),
                targetId = relationship.TargetEntityId.ToString(),
                relId = relationship.Id.ToString(),
                description = relationship.Description,
                weight = relationship.Weight,
                properties = relationship.Properties,
                createdTime = relationship.CreatedTime,
                updatedTime = relationship.UpdatedTime
            });
        }
        finally
        {
            await session.CloseAsync();
        }
    }

    /// <summary>
    /// ä»Neo4jåˆ é™¤å…³ç³»
    /// </summary>
    public async Task DeleteRelationshipFromNeo4jAsync(Guid relationshipId)
    {
        var session = _neo4jDriver.AsyncSession();
        try
        {
            var query = "MATCH ()-[r {id: $relId}]-() DELETE r";
            await session.RunAsync(query, new { relId = relationshipId.ToString() });
        }
        finally
        {
            await session.CloseAsync();
        }
    }

    /// <summary>
    /// è·å–Neo4jå®ä½“æ ‡ç­¾
    /// </summary>
    private string GetEntityLabel(string entityType)
    {
        return entityType switch
        {
            "Catalogue" => "Catalogue",
            "Person" => "Person",
            "Department" => "Department",
            "BusinessEntity" => "BusinessEntity",
            "Workflow" => "Workflow",
            _ => "Entity"
        };
    }

    /// <summary>
    /// è·å–Neo4jå…³ç³»ç±»å‹ï¼ˆé‡‡ç”¨æŠ½è±¡åŒ–è®¾è®¡ï¼‰
    /// </summary>
    private string GetNeo4jRelationshipType(RelationshipType relationshipType, string? role = null, string? semanticType = null)
    {
        return relationshipType switch
        {
            // æŠ½è±¡å…³ç³»ç±»å‹ç»Ÿä¸€ä½¿ç”¨ RELATES_TO
            RelationshipType.CatalogueRelatesToCatalogue => "RELATES_TO",
            RelationshipType.PersonRelatesToCatalogue => "RELATES_TO",
            RelationshipType.PersonRelatesToWorkflow => "RELATES_TO",
            RelationshipType.WorkflowRelatesToWorkflow => "RELATES_TO",

            // è¯­ä¹‰æ˜ç¡®çš„å…³ç³»ç±»å‹ä¿ç•™ç‹¬ç«‹ç±»å‹
            RelationshipType.CatalogueHasChild => "HAS_CHILD",
            RelationshipType.CatalogueReferencesBusiness => "REFERENCES",
            RelationshipType.PersonBelongsToDepartment => "BELONGS_TO",
            RelationshipType.DepartmentOwnsCatalogue => "OWNS",
            RelationshipType.DepartmentManagesCatalogue => "MANAGES",
            RelationshipType.DepartmentHasParent => "HAS_PARENT",
            RelationshipType.BusinessEntityHasCatalogue => "HAS",
            RelationshipType.BusinessEntityManagesCatalogue => "MANAGES",
            RelationshipType.CatalogueUsesWorkflow => "USES",
            RelationshipType.WorkflowManagesCatalogue => "MANAGES",
            RelationshipType.WorkflowInstanceBelongsToCatalogue => "INSTANCE_OF",
            RelationshipType.DepartmentOwnsWorkflow => "OWNS",

            _ => relationshipType.ToString().ToUpper()
        };
    }

    /// <summary>
    /// åŒæ­¥å…³ç³»åˆ°Neo4jï¼ˆæ”¯æŒæŠ½è±¡å…³ç³»ç±»å‹ï¼‰
    /// </summary>
    public async Task SyncRelationshipToNeo4jAsync(KnowledgeGraphRelationship relationship)
    {
        var session = _neo4jDriver.AsyncSession();
        try
        {
            // è·å–æºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹çš„æ ‡ç­¾ï¼ˆæ ¹æ®å®ä½“ç±»å‹ï¼‰
            var sourceLabel = GetEntityLabel(relationship.SourceEntityType);
            var targetLabel = GetEntityLabel(relationship.TargetEntityType);
            var relType = GetNeo4jRelationshipType(relationship.Type, relationship.Role, relationship.SemanticType);

            // æ„å»ºå…³ç³»å±æ€§
            var relProperties = new Dictionary<string, object>
            {
                ["id"] = relationship.Id.ToString(),
                ["description"] = relationship.Description ?? "",
                ["weight"] = relationship.Weight,
                ["createdTime"] = relationship.CreationTime,
                ["updatedTime"] = relationship.LastModificationTime ?? relationship.CreationTime
            };

            // æ·»åŠ  role æˆ– semanticType å±æ€§
            if (!string.IsNullOrEmpty(relationship.Role))
            {
                relProperties["role"] = relationship.Role;
            }

            if (!string.IsNullOrEmpty(relationship.SemanticType))
            {
                relProperties["semanticType"] = relationship.SemanticType;
            }

            // æ·»åŠ å…¶ä»–æ‰©å±•å±æ€§
            if (relationship.Properties != null)
            {
                foreach (var prop in relationship.Properties)
                {
                    relProperties[prop.Key] = prop.Value;
                }
            }

            var query = $@"
                MATCH (source:{sourceLabel} {{id: $sourceId}})
                MATCH (target:{targetLabel} {{id: $targetId}})
                MERGE (source)-[r:{relType} {{id: $relId}}]->(target)
                SET r += $properties
                RETURN r";

            await session.RunAsync(query, new
            {
                sourceId = relationship.SourceEntityId.ToString(),
                targetId = relationship.TargetEntityId.ToString(),
                relId = relationship.Id.ToString(),
                properties = relProperties
            });
        }
        finally
        {
            await session.CloseAsync();
        }
    }
}
```

---

## 8. æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 8.1 å›¾æŸ¥è¯¢ä¼˜åŒ–

-   **ç´¢å¼•ä¼˜åŒ–**ï¼šä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•ï¼ˆname, type, tagsï¼‰
-   **æŸ¥è¯¢æ·±åº¦é™åˆ¶**ï¼šé»˜è®¤é™åˆ¶æŸ¥è¯¢æ·±åº¦ä¸º 2-3 è·³
-   **èŠ‚ç‚¹æ•°é‡é™åˆ¶**ï¼šå•æ¬¡æŸ¥è¯¢æœ€å¤šè¿”å› 500-1000 ä¸ªèŠ‚ç‚¹
-   **ç¼“å­˜ç­–ç•¥**ï¼šçƒ­ç‚¹å›¾è°±æ•°æ®ç¼“å­˜ 30 åˆ†é’Ÿ

### 8.2 æœç´¢æ€§èƒ½ä¼˜åŒ–

-   **PostgreSQL å…¨æ–‡æœç´¢ä¼˜åŒ–**ï¼š
    -   ä½¿ç”¨ GIN ç´¢å¼•æå‡å…¨æ–‡æœç´¢æ€§èƒ½
    -   åˆç†ä½¿ç”¨ `ts_rank_cd` å‡½æ•°è®¡ç®—åŒ¹é…åº¦
    -   ä¸ºå¸¸ç”¨æœç´¢å­—æ®µï¼ˆåç§°ã€æ ‡ç­¾ã€æè¿°ï¼‰åˆ›å»ºå¤åˆå…¨æ–‡æœç´¢ç´¢å¼•
    -   ä½¿ç”¨ `plainto_tsquery` è¿›è¡Œä¸­æ–‡åˆ†è¯æœç´¢
    -   å®šæœŸæ‰§è¡Œ `VACUUM ANALYZE` ä¼˜åŒ–ç´¢å¼•
-   **ç»“æœç¼“å­˜**ï¼šç›¸åŒå…³é”®è¯æœç´¢ç»“æœç¼“å­˜ 5 åˆ†é’Ÿ

### 8.3 å‰ç«¯æ€§èƒ½ä¼˜åŒ–

-   **è™šæ‹Ÿæ»šåŠ¨**ï¼šæœç´¢ç»“æœåˆ—è¡¨ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨
-   **å›¾è°±æ¸²æŸ“ä¼˜åŒ–**ï¼š
    -   ä½¿ç”¨ Web Worker è¿›è¡Œå¸ƒå±€è®¡ç®—
    -   èŠ‚ç‚¹æ•°é‡è¶…è¿‡ 1000 æ—¶ä½¿ç”¨ç®€åŒ–æ¸²æŸ“
    -   æ”¯æŒæŒ‰éœ€åŠ è½½ï¼ˆæ‡’åŠ è½½ï¼‰
-   **é˜²æŠ–å’ŒèŠ‚æµ**ï¼šæœç´¢è¾“å…¥é˜²æŠ– 300msï¼Œæ»šåŠ¨äº‹ä»¶èŠ‚æµ

---

## 9. å®‰å…¨æ–¹æ¡ˆ

### 9.1 æ•°æ®å®‰å…¨

#### 9.1.1 å¯†çº§æ§åˆ¶

-   **å¯†çº§è¿‡æ»¤**ï¼šæ ¹æ®å®ä½“å¯†çº§ï¼ˆå†…éƒ¨ã€ç§˜å¯†ã€æœºå¯†ç­‰ï¼‰è¿‡æ»¤æŸ¥è¯¢ç»“æœ
-   **å¯†çº§ç»§æ‰¿**ï¼šå­åˆ†ç±»ç»§æ‰¿çˆ¶åˆ†ç±»çš„å¯†çº§è®¾ç½®
-   **å¯†çº§éªŒè¯**ï¼šåœ¨å®ä½“è¯¦æƒ…å’Œå…³ç³»æŸ¥è¯¢æ—¶è‡ªåŠ¨éªŒè¯ç”¨æˆ·å¯†çº§æƒé™

#### 9.1.2 è®¿é—®æ§åˆ¶

çŸ¥è¯†å›¾è°±ç³»ç»Ÿé›†æˆ `AttachCatalogue.Permissions` æƒé™ç³»ç»Ÿï¼Œå®ç°ç»†ç²’åº¦çš„è®¿é—®æ§åˆ¶ï¼š

**æƒé™æ£€æŸ¥æœºåˆ¶**ï¼š

-   æ‰€æœ‰å›¾è°±æŸ¥è¯¢å’Œæœç´¢æ¥å£è‡ªåŠ¨åº”ç”¨æƒé™è¿‡æ»¤
-   åˆ©ç”¨ `AttachCatalogue.HasPermission()` æ–¹æ³•æ£€æŸ¥ç”¨æˆ·æƒé™
-   æ”¯æŒæƒé™ç»§æ‰¿ï¼šå­åˆ†ç±»ç»§æ‰¿çˆ¶åˆ†ç±»æƒé™ï¼ˆé€šè¿‡ `HasInheritedPermission()` æ–¹æ³•ï¼‰
-   æƒé™ä¼˜å…ˆçº§ï¼š`Deny` > `Allow` > `Inherit`

**æƒé™è¿‡æ»¤ç­–ç•¥**ï¼š

-   **å›¾è°±æŸ¥è¯¢**ï¼šåªè¿”å›ç”¨æˆ·æœ‰ `Read` æƒé™çš„å®ä½“èŠ‚ç‚¹
-   **æœç´¢æ¥å£**ï¼šæœç´¢ç»“æœè‡ªåŠ¨è¿‡æ»¤æ— æƒé™çš„å®ä½“
-   **å…³ç³»æŸ¥è¯¢**ï¼šåªè¿”å›ç”¨æˆ·å¯è®¿é—®çš„å…³ç³»
-   **æ—¶é—´è½´æŸ¥è¯¢**ï¼šç»Ÿè®¡ä¿¡æ¯åªåŒ…å«ç”¨æˆ·å¯è®¿é—®çš„å®ä½“

**æƒé™ç±»å‹æ”¯æŒ**ï¼š

-   **ç”¨æˆ·æƒé™ï¼ˆUserï¼‰**ï¼šç›´æ¥æˆäºˆç‰¹å®šç”¨æˆ·çš„æƒé™
-   **è§’è‰²æƒé™ï¼ˆRoleï¼‰**ï¼šæˆäºˆè§’è‰²çš„æƒé™ï¼Œè§’è‰²æˆå‘˜è‡ªåŠ¨ç»§æ‰¿
-   **ç­–ç•¥æƒé™ï¼ˆPolicyï¼‰**ï¼šåŸºäºå±æ€§æ¡ä»¶çš„åŠ¨æ€æƒé™

**æƒé™ç¼“å­˜**ï¼š

-   è®¿é—®æ§åˆ¶ç»“æœç¼“å­˜ 5 åˆ†é’Ÿï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
-   æƒé™å˜æ›´æ—¶è‡ªåŠ¨å¤±æ•ˆç›¸å…³ç¼“å­˜

#### 9.1.3 æ•°æ®è„±æ•

-   **æ•æ„Ÿä¿¡æ¯è„±æ•**ï¼šæ ¹æ®ç”¨æˆ·æƒé™çº§åˆ«è„±æ•æ˜¾ç¤ºæ•æ„Ÿä¿¡æ¯
-   **äººå‘˜ä¿¡æ¯ä¿æŠ¤**ï¼šäººå‘˜è”ç³»æ–¹å¼ã€èº«ä»½è¯å·ç­‰æ•æ„Ÿä¿¡æ¯æ ¹æ®æƒé™è„±æ•
-   **æ–‡ä»¶å†…å®¹è„±æ•**ï¼šOCR å†…å®¹ã€æ–‡ä»¶é¢„è§ˆç­‰æ ¹æ®æƒé™æ§åˆ¶è®¿é—®

### 9.2 API å®‰å…¨

-   **è®¤è¯æˆæƒ**ï¼šä½¿ç”¨ JWT Token è®¤è¯ï¼Œé›†æˆ ABP æ¡†æ¶çš„è®¤è¯ç³»ç»Ÿ
-   **æƒé™éªŒè¯**ï¼šæ‰€æœ‰ API æ¥å£è‡ªåŠ¨éªŒè¯ç”¨æˆ·æƒé™ï¼Œåˆ©ç”¨ `AttachCatalogue.Permissions` è¿›è¡Œè®¿é—®æ§åˆ¶
-   **æ¥å£é™æµ**ï¼šé˜²æ­¢æ¶æ„æŸ¥è¯¢ï¼Œä½¿ç”¨ä»¤ç‰Œæ¡¶ç®—æ³•é™åˆ¶è¯·æ±‚é¢‘ç‡
-   **å‚æ•°éªŒè¯**ï¼šä¸¥æ ¼éªŒè¯æ‰€æœ‰è¾“å…¥å‚æ•°ï¼Œé˜²æ­¢ SQL æ³¨å…¥å’Œ XSS æ”»å‡»
-   **å®¡è®¡æ—¥å¿—**ï¼šè®°å½•æ‰€æœ‰æƒé™ç›¸å…³çš„æ“ä½œï¼Œæ”¯æŒåˆè§„æ€§å®¡è®¡

---

## 10. éƒ¨ç½²æ–¹æ¡ˆ

### 10.1 å®¹å™¨åŒ–éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'
services:
    neo4j:
        image: neo4j:5.15
        ports:
            - '7474:7474'
            - '7687:7687'
        environment:
            - NEO4J_AUTH=neo4j/password
        volumes:
            - neo4j_data:/data

    elasticsearch:
        image: elasticsearch:8.11.0
        ports:
            - '9200:9200'
        environment:
            - discovery.type=single-node
        volumes:
            - es_data:/usr/share/elasticsearch/data

volumes:
    neo4j_data:
    es_data:
```

### 10.2 ç›‘æ§å’Œæ—¥å¿—

-   **åº”ç”¨ç›‘æ§**ï¼šé›†æˆ APM å·¥å…·ï¼ˆå¦‚ Application Insightsï¼‰
-   **å›¾æ•°æ®åº“ç›‘æ§**ï¼šç›‘æ§ Neo4j æŸ¥è¯¢æ€§èƒ½å’Œèµ„æºä½¿ç”¨
-   **æ—¥å¿—èšåˆ**ï¼šä½¿ç”¨ ELK Stack è¿›è¡Œæ—¥å¿—æ”¶é›†å’Œåˆ†æ

---

## 11. å®æ–½è®¡åˆ’

### 11.1 ç¬¬ä¸€é˜¶æ®µï¼ˆ2 å‘¨ï¼‰

-   æ•°æ®æ¨¡å‹è®¾è®¡å’Œæ•°æ®åº“æ­å»º
-   åŸºç¡€ API æ¥å£å¼€å‘
-   å‰ç«¯å›¾è°±å¯è§†åŒ–ç»„ä»¶å¼€å‘

### 11.2 ç¬¬äºŒé˜¶æ®µï¼ˆ2 å‘¨ï¼‰

-   æœç´¢åŠŸèƒ½å®ç°
-   æ—¶é—´è½´åŠŸèƒ½å®ç°
-   èŠ‚ç‚¹è¯¦æƒ…é¢æ¿å¼€å‘

### 11.3 ç¬¬ä¸‰é˜¶æ®µï¼ˆ2 å‘¨ï¼‰

-   å½±å“åˆ†æç®—æ³•å®ç°
-   é£é™©è¯„ä¼°åŠŸèƒ½å¼€å‘
-   é£é™©é¢„è­¦åŠŸèƒ½å®ç°

### 11.4 ç¬¬å››é˜¶æ®µï¼ˆ1 å‘¨ï¼‰

-   æ•°æ®åŒæ­¥æ–¹æ¡ˆå®æ–½
-   æ€§èƒ½ä¼˜åŒ–
-   æµ‹è¯•å’Œ bug ä¿®å¤

---

## 12. æ•°æ®æ¨¡å‹ä¼˜åŒ–è¯´æ˜

### 12.1 å·²é‡‡çº³çš„ä¼˜åŒ–å»ºè®®

åŸºäºå¤šç»´çŸ¥è¯†å›¾è°±æœ€ä½³å®è·µå’Œæ¡£æ¡ˆç³»ç»Ÿç‰¹ç‚¹ï¼Œä»¥ä¸‹ä¼˜åŒ–å·²æ•´åˆåˆ°è®¾è®¡ä¸­ï¼š

#### 12.1.1 æ–‡ä»¶å®ä½“å¢å¼º

-   âœ… **FileSize ç±»å‹ä¼˜åŒ–**ï¼šä» `int` æ”¹ä¸º `long`ï¼Œæ”¯æŒå¤§æ–‡ä»¶ï¼ˆ>2GBï¼‰
-   âœ… **æ–‡ä»¶å®Œæ•´æ€§æ ¡éªŒ**ï¼šæ–°å¢ `Checksum` å­—æ®µï¼ˆMD5/SHA256ï¼‰ï¼Œç”¨äºæ–‡ä»¶å®Œæ•´æ€§éªŒè¯
-   âœ… **MIME ç±»å‹**ï¼šæ–°å¢ `MimeType` å­—æ®µï¼Œä¾¿äºæ–‡ä»¶ç±»å‹è¯†åˆ«å’Œå¤„ç†
-   âœ… **æœ€åè®¿é—®æ—¶é—´**ï¼šæ–°å¢ `LastAccessTime` å­—æ®µï¼Œæ”¯æŒè®¿é—®ç»Ÿè®¡å’Œåˆ†æ

#### 12.1.2 å…³ç³»æ¨¡å‹ä¼˜åŒ–ï¼ˆæŠ½è±¡åŒ–è®¾è®¡ï¼‰

-   âœ… **æŠ½è±¡å…³ç³»ç±»å‹**ï¼šé‡‡ç”¨ `PersonRelatesToCatalogue` å’Œ `CatalogueRelatesToCatalogue` æŠ½è±¡å…³ç³»ç±»å‹ï¼Œé€šè¿‡ `role` å’Œ `semanticType` å±æ€§æè¿°å…·ä½“è¯­ä¹‰
-   âœ… **è§’è‰²æšä¸¾**ï¼šå®šä¹‰ `PersonRole` æšä¸¾ï¼ˆCreatorã€Managerã€ProjectManagerã€Reviewerã€Expertã€Responsibleã€Contactã€Participantï¼‰ï¼Œæ”¯æŒçµæ´»æ‰©å±•
-   âœ… **è¯­ä¹‰ç±»å‹æšä¸¾**ï¼šå®šä¹‰ `CatalogueSemanticType` æšä¸¾ï¼ˆTemporalã€Businessã€Versionã€Replacesã€DependsOnã€Referencesã€SimilarToï¼‰ï¼Œæ”¯æŒçµæ´»æ‰©å±•
-   âœ… **å¯æ‰©å±•æ€§**ï¼šæ–°å¢è§’è‰²æˆ–è¯­ä¹‰ç±»å‹æ— éœ€ä¿®æ”¹å…³ç³»ç±»å‹æšä¸¾ï¼Œåªéœ€æ‰©å±•å¯¹åº”çš„æšä¸¾ç±»å‹
-   âœ… **æ•°æ®åº“æ”¯æŒ**ï¼šåœ¨ `kg_relationships` è¡¨ä¸­æ–°å¢ `role` å’Œ `semantic_type` å­—æ®µï¼Œå¹¶åˆ›å»ºç›¸åº”ç´¢å¼•

#### 12.1.3 çŠ¶æ€ç®¡ç†ä¼˜åŒ–

-   âœ… **ç»Ÿä¸€çŠ¶æ€å­—æ®µ**ï¼šåœ¨å®ä½“åŸºç±»ä¸­æ–°å¢ `Status` å­—æ®µï¼Œç»Ÿä¸€ç®¡ç†å®ä½“çŠ¶æ€ï¼ˆACTIVE, ARCHIVED, DELETED ç­‰ï¼‰
-   âœ… **çŠ¶æ€ç´¢å¼•**ï¼šä¸ºçŠ¶æ€å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œæ”¯æŒæŒ‰çŠ¶æ€å¿«é€ŸæŸ¥è¯¢

#### 12.1.4 æ•°æ®åº“ä¼˜åŒ–

-   âœ… **ç´¢å¼•å¢å¼º**ï¼š
    -   æ–°å¢æ–‡ä»¶æ ¡éªŒå’Œç´¢å¼•ï¼ˆ`file_checksum_index`ï¼‰ï¼Œæ”¯æŒæ–‡ä»¶å»é‡å’Œå®Œæ•´æ€§éªŒè¯
    -   æ–°å¢çŠ¶æ€ç´¢å¼•ï¼ˆ`entity_status_index`ï¼‰ï¼Œæå‡çŠ¶æ€æŸ¥è¯¢æ€§èƒ½
    -   æ–°å¢åˆ†ç±»çŠ¶æ€ç´¢å¼•ï¼ˆ`catalogue_status_index`ï¼‰
-   âœ… **é£é™©é¢„è­¦è¡¨å¢å¼º**ï¼š
    -   æ–°å¢ `risk_category` å­—æ®µï¼Œæ”¯æŒé£é™©åˆ†ç±»ï¼ˆæ•°æ®å®Œæ•´æ€§ã€å®‰å…¨æ€§ã€åˆè§„æ€§ç­‰ï¼‰
    -   æ–°å¢ `due_date` å­—æ®µï¼Œæ”¯æŒå¤„ç†æˆªæ­¢æ—¥æœŸç®¡ç†
-   âœ… **å®¡è®¡è½¨è¿¹è¡¨**ï¼šæ–°å¢ `kg_audit_trail` è¡¨ï¼Œè®°å½•å®ä½“å˜æ›´å†å²ï¼Œæ”¯æŒåˆè§„æ€§å®¡è®¡

### 12.2 å…³ç³»å‹æ•°æ®åº“è®¾è®¡ä¼˜åŒ–

#### 12.2.1 è®¾è®¡åŸåˆ™

çŸ¥è¯†å›¾è°±çš„å…³ç³»å‹æ•°æ®åº“è®¾è®¡é‡‡ç”¨**å¼•ç”¨æ¨¡å¼**ï¼Œé¿å…æ•°æ®å†—ä½™ï¼š

1. **ä¸é‡å¤å­˜å‚¨å®ä½“æ•°æ®**ï¼š

    - å·²æœ‰å®ä½“è¡¨ï¼š`APPATTACH_CATALOGUES`ï¼ˆåˆ†ç±»ï¼‰
    - çŸ¥è¯†å›¾è°±è¡¨åªå­˜å‚¨å›¾è°±ç‰¹æœ‰çš„æ•°æ®ï¼ˆå…³ç³»ã€å›¾æŸ¥è¯¢ä¼˜åŒ–ã€æ—¶é—´è½´å¿«ç…§ç­‰ï¼‰

2. **é€šè¿‡å®ä½“ ID å’Œç±»å‹å…³è”**ï¼š

    - `kg_relationships` è¡¨é€šè¿‡ `source_entity_id` + `source_entity_type` å’Œ `target_entity_id` + `target_entity_type` å…³è”åˆ°ç°æœ‰å®ä½“è¡¨
    - ä¸åˆ›å»º `kg_entities` è¡¨ï¼Œé¿å…æ•°æ®å†—ä½™å’ŒåŒæ­¥é—®é¢˜

3. **è§†å›¾æ”¯æŒ**ï¼š
    - åˆ›å»ºç±»å‹ç‰¹å®šçš„è§†å›¾ï¼ˆå¦‚ `v_kg_catalogue_relationships`ï¼‰
    - é€šè¿‡ JOIN ç°æœ‰å®ä½“è¡¨æä¾›å®Œæ•´çš„å®ä½“å…³ç³»ä¿¡æ¯
    - æ–¹ä¾¿æŸ¥è¯¢ï¼Œæ— éœ€æ‰‹åŠ¨ JOIN

#### 12.2.2 æ ¸å¿ƒè¡¨ç»“æ„

-   **kg_relationships**ï¼šå…³ç³»è¡¨ï¼ˆæ ¸å¿ƒè¡¨ï¼‰ï¼Œå­˜å‚¨å®ä½“é—´çš„å…³ç³»
-   **kg_entity_graph_metadata**ï¼šå®ä½“å›¾æŸ¥è¯¢ä¼˜åŒ–è¡¨ï¼ˆå¯é€‰ï¼‰ï¼Œå­˜å‚¨å›¾æŸ¥è¯¢ç›¸å…³å…ƒæ•°æ®
-   **kg_timeline_snapshots**ï¼šæ—¶é—´è½´å¿«ç…§è¡¨ï¼Œå­˜å‚¨ä¸šåŠ¡é˜¶æ®µçš„æ—¶é—´è½´æ•°æ®
-   **kg_risk_alerts**ï¼šé£é™©é¢„è­¦è¡¨ï¼Œå­˜å‚¨çŸ¥è¯†å›¾è°±ç›¸å…³çš„é£é™©é¢„è­¦
-   **kg_graph_audit_trail**ï¼šçŸ¥è¯†å›¾è°±å®¡è®¡è½¨è¿¹è¡¨ï¼ˆä»…è®°å½•å›¾è°±ç›¸å…³æ“ä½œï¼‰

#### 12.2.3 æ•°æ®åŒæ­¥ç­–ç•¥

ç”±äºä¸é‡å¤å­˜å‚¨å®ä½“æ•°æ®ï¼Œæ•°æ®åŒæ­¥ç­–ç•¥å¦‚ä¸‹ï¼š

1. **å…³ç³»æ•°æ®åŒæ­¥**ï¼š

    - å½“å®ä½“å…³ç³»å‘ç”Ÿå˜åŒ–æ—¶ï¼ˆå¦‚åˆ†ç±»åŒ…å«æ–‡ä»¶ã€åˆ†ç±»æœ‰å­åˆ†ç±»ï¼‰ï¼ŒåŒæ­¥æ›´æ–° `kg_relationships` è¡¨
    - é€šè¿‡ CDC æˆ–åº”ç”¨å±‚äº‹ä»¶ç›‘å¬å®ç°

2. **å›¾æŸ¥è¯¢å…ƒæ•°æ®åŒæ­¥**ï¼š

    - å®šæœŸè®¡ç®—å®ä½“çš„å›¾æŸ¥è¯¢ç›¸å…³å±æ€§ï¼ˆå¦‚é‡è¦æ€§è¯„åˆ†ã€ä¸­å¿ƒåº¦ï¼‰
    - æ›´æ–° `kg_entity_graph_metadata` è¡¨

3. **æ—¶é—´è½´å¿«ç…§**ï¼š
    - æŒ‰ä¸šåŠ¡é˜¶æ®µå®šæœŸåˆ›å»ºå¿«ç…§
    - ç»Ÿè®¡å®ä½“æ•°é‡å’Œå…³ç³»æ•°é‡ï¼Œå­˜å‚¨åˆ° `kg_timeline_snapshots` è¡¨

### 12.3 æœªé‡‡çº³çš„å»ºè®®åŠåŸå› 

#### 12.3.1 ArchiveSeriesï¼ˆæ¡£æ¡ˆç³»åˆ—ï¼‰ç»´åº¦

-   âŒ **æœªé‡‡çº³åŸå› **ï¼š
    -   å½“å‰ä¸šåŠ¡æ¨¡å‹ä¸­æ²¡æœ‰æ¡£æ¡ˆç³»åˆ—çš„æ¦‚å¿µ
    -   `AttachCatalogue` å·²é€šè¿‡ `IsArchived` å­—æ®µæ”¯æŒå½’æ¡£åŠŸèƒ½
    -   å¦‚æœæœªæ¥ä¸šåŠ¡éœ€è¦ï¼Œå¯ä»¥é€šè¿‡ `BusinessEntity` ç»´åº¦æ‰©å±•ï¼Œæ— éœ€æ–°å¢ç‹¬ç«‹ç»´åº¦
    -   é¿å…è¿‡åº¦è®¾è®¡ï¼Œä¿æŒæ¨¡å‹ç®€æ´

#### 12.3.2 CreatedBy/UpdatedBy å­—æ®µ

-   âŒ **æœªé‡‡çº³åŸå› **ï¼š
    -   ABP æ¡†æ¶å·²æä¾›å®Œæ•´çš„å®¡è®¡å­—æ®µï¼ˆ`CreatorId`, `LastModifierId`, `CreationTime`, `LastModificationTime`ï¼‰
    -   çŸ¥è¯†å›¾è°±å®ä½“é€šè¿‡ `Properties` å­—æ®µå¯ä»¥å­˜å‚¨è¿™äº›ä¿¡æ¯
    -   é¿å…æ•°æ®å†—ä½™ï¼Œä¿æŒä¸ ABP æ¡†æ¶çš„ä¸€è‡´æ€§

#### 12.3.3 Version å­—æ®µï¼ˆå®ä½“åŸºç±»ï¼‰

-   âŒ **æœªé‡‡çº³åŸå› **ï¼š
    -   ä¸æ˜¯æ‰€æœ‰å®ä½“éƒ½éœ€è¦ç‰ˆæœ¬æ§åˆ¶ï¼ˆå¦‚ Personã€Facet ç­‰ï¼‰
    -   æ¨¡æ¿å®ä½“å·²æœ‰ `Version` å­—æ®µï¼Œæ–‡ä»¶ç‰ˆæœ¬é€šè¿‡å…³ç³»ç®¡ç†
    -   ç‰ˆæœ¬æ§åˆ¶åº”ä½œä¸ºå¯é€‰åŠŸèƒ½ï¼Œè€Œéæ‰€æœ‰å®ä½“çš„å¿…éœ€å­—æ®µ

#### 12.3.4 CatalogueCodeï¼ˆåˆ†ç±»ç¼–ç ï¼‰

-   âŒ **æœªé‡‡çº³åŸå› **ï¼š
    -   å½“å‰ä¸šåŠ¡æ¨¡å‹ä¸­æ²¡æœ‰åˆ†ç±»ç¼–ç çš„éœ€æ±‚
    -   åˆ†ç±»é€šè¿‡ `Reference` + `ReferenceType` + `CatalogueName` å”¯ä¸€æ ‡è¯†
    -   å¦‚æœæœªæ¥éœ€è¦ï¼Œå¯ä»¥é€šè¿‡ `Properties` å­—æ®µæ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒæ¨¡å‹

#### 12.3.5 ArchiveDate/ReviewDateï¼ˆåˆ†ç±»å®ä½“ï¼‰

-   âŒ **æœªé‡‡çº³åŸå› **ï¼š
    -   å½’æ¡£æ—¥æœŸå¯é€šè¿‡å®¡è®¡å­—æ®µ `LastModificationTime` å’ŒçŠ¶æ€å˜æ›´è®°å½•è·å–
    -   å®¡æ ¸æ—¥æœŸå¯é€šè¿‡å®¡è®¡è½¨è¿¹è¡¨æŸ¥è¯¢
    -   é¿å…å­—æ®µå†—ä½™ï¼Œä¿æŒæ¨¡å‹ç®€æ´

### 12.4 è®¾è®¡åŸåˆ™

åœ¨ä¼˜åŒ–è¿‡ç¨‹ä¸­éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š

1. **ä¸ç°æœ‰æ¡†æ¶é›†æˆ**ï¼šå……åˆ†åˆ©ç”¨ ABP æ¡†æ¶çš„å®¡è®¡ã€æƒé™ç­‰åŠŸèƒ½ï¼Œé¿å…é‡å¤å®ç°
2. **ä¸šåŠ¡é©±åŠ¨**ï¼šåªæ·»åŠ å½“å‰ä¸šåŠ¡ç¡®å®éœ€è¦çš„åŠŸèƒ½ï¼Œé¿å…è¿‡åº¦è®¾è®¡
3. **æ‰©å±•æ€§**ï¼šé€šè¿‡ `Properties` å­—æ®µå’Œå…³ç³»æ¨¡å‹æ”¯æŒæœªæ¥æ‰©å±•
4. **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†ä½¿ç”¨ç´¢å¼•ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
5. **åˆè§„æ€§**ï¼šé€šè¿‡å®¡è®¡è½¨è¿¹è¡¨æ”¯æŒåˆè§„æ€§è¦æ±‚

### 12.5 æœªæ¥æ‰©å±•å»ºè®®

å¦‚æœæœªæ¥ä¸šåŠ¡éœ€è¦ä»¥ä¸‹åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ‰©å±•ï¼š

1. **æ¡£æ¡ˆç³»åˆ—ç®¡ç†**ï¼šé€šè¿‡ `BusinessEntity` ç»´åº¦æˆ–æ–°å¢å…³ç³»ç±»å‹å®ç°
2. **åˆ†ç±»ç¼–ç **ï¼šé€šè¿‡ `Properties` å­—æ®µæˆ–æ–°å¢å¯é€‰å­—æ®µå®ç°
3. **æ›´ç»†ç²’åº¦çš„ç‰ˆæœ¬æ§åˆ¶**ï¼šé€šè¿‡å…³ç³»æ¨¡å‹å’Œå®¡è®¡è½¨è¿¹è¡¨å®ç°
4. **æ–‡ä»¶å®Œæ•´æ€§çŠ¶æ€**ï¼šé€šè¿‡ `Checksum` å­—æ®µå’Œå®šæœŸæ ¡éªŒä»»åŠ¡å®ç°

---

## 13. æ€»ç»“

æœ¬æŠ€æœ¯æ–¹æ¡ˆæä¾›äº†å¤šç»´çŸ¥è¯†å›¾è°±ç³»ç»Ÿçš„å®Œæ•´è®¾è®¡å’Œå®ç°æ–¹æ¡ˆï¼Œæ¶µç›–äº†æ•°æ®æ¨¡å‹ã€API è®¾è®¡ã€å‰ç«¯ç»„ä»¶ã€æ ¸å¿ƒç®—æ³•ç­‰å„ä¸ªæ–¹é¢ã€‚ç³»ç»Ÿé‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆï¼Œå…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§å’Œæ€§èƒ½è¡¨ç°ï¼Œèƒ½å¤Ÿæ»¡è¶³ä¸šåŠ¡éœ€æ±‚å¹¶æ”¯æŒæœªæ¥æ‰©å±•ã€‚

### æ ¸å¿ƒç‰¹ç‚¹

-   **å…­ç»´å®ä½“æ¨¡å‹**ï¼šåˆ†ç±»ã€æ–‡ä»¶ã€æ¨¡æ¿ã€åˆ†é¢ã€äººå‘˜ã€ä¸šåŠ¡å®ä½“
-   **å®Œæ•´çš„å…³ç³»ç½‘ç»œ**ï¼šæ”¯æŒå¤æ‚çš„ä¸šåŠ¡å…³ç³»å»ºæ¨¡å’ŒæŸ¥è¯¢
-   **ç»Ÿä¸€ç‰ˆæœ¬ç®¡ç†**ï¼šæ”¯æŒæ–‡ä»¶å’Œåˆ†ç±»çš„ç‰ˆæœ¬å†å²ç®¡ç†ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬åˆ›å»ºã€å›æ»šå’Œå˜æ›´è¿½è¸ª
-   **ç»†ç²’åº¦è®¿é—®æ§åˆ¶**ï¼šé›†æˆ `AttachCatalogue.Permissions` æƒé™ç³»ç»Ÿï¼Œè‡ªåŠ¨è¿‡æ»¤æ— æƒé™çš„å®ä½“
-   **æ€§èƒ½ä¼˜åŒ–**ï¼šåˆç†çš„ç´¢å¼•è®¾è®¡å’ŒæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥
-   **åˆè§„æ€§æ”¯æŒ**ï¼šå®Œæ•´çš„å®¡è®¡è½¨è¿¹å’Œé£é™©é¢„è­¦æœºåˆ¶
-   **æ‰©å±•æ€§å¼º**ï¼šé€šè¿‡ Properties å­—æ®µå’Œå…³ç³»æ¨¡å‹æ”¯æŒçµæ´»æ‰©å±•
