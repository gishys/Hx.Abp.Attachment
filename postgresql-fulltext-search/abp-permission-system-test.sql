-- 基于ABP vNext的权限系统测试脚本
-- 简化实现，权限集合直接通过实体关联存储

-- 设置测试环境
SET client_min_messages TO notice;

-- 测试数据准备
DO $$
DECLARE
    template_id uuid := '55555555-5555-5555-5555-555555555555';
    user_id uuid := '11111111-1111-1111-1111-111111111111';
BEGIN
    -- 插入测试模板
    INSERT INTO "APPATTACH_CATALOGUE_TEMPLATES" ("ID", "TEMPLATE_NAME", "TEMPLATE_TYPE", "TEMPLATE_PURPOSE") VALUES
    (template_id, '测试模板', 1, 1)
    ON CONFLICT (id) DO NOTHING;
    
    RAISE NOTICE '测试数据准备完成';
END $$;

-- 测试权限检查功能（简化版本）
DO $$
DECLARE
    template_id uuid := '55555555-5555-5555-5555-555555555555';
    user_id uuid := '11111111-1111-1111-1111-111111111111';
    has_permission boolean;
BEGIN
    -- 测试简化权限检查函数
    SELECT "FN_CHECK_TEMPLATE_PERMISSION_SIMPLE"(template_id, user_id, 1) INTO has_permission;
    RAISE NOTICE '简化权限检查结果: %', has_permission;
    
    -- 注意：实际权限检查通过应用层进行，这里只是测试数据库层面的基本检查
END $$;

-- 测试权限视图
SELECT 
    "TEMPLATE_ID",
    "TEMPLATE_NAME",
    "TOTAL_PERMISSIONS",
    "ENABLED_PERMISSIONS",
    "EFFECTIVE_PERMISSIONS"
FROM "V_APPATTACH_PERMISSION_SUMMARY"
WHERE "TEMPLATE_ID" = '55555555-5555-5555-5555-555555555555';

-- 测试权限统计视图
SELECT 
    "TEMPLATE_ID",
    "TEMPLATE_NAME",
    "TOTAL_PERMISSIONS",
    "ROLE_PERMISSIONS",
    "USER_PERMISSIONS",
    "POLICY_PERMISSIONS"
FROM "V_APPATTACH_PERMISSION_STATISTICS"
WHERE "TEMPLATE_ID" = '55555555-5555-5555-5555-555555555555';

-- 测试权限分析视图
SELECT 
    "TEMPLATE_ID",
    "TEMPLATE_NAME",
    "PERMISSION_STATUS"
FROM "V_APPATTACH_PERMISSION_ANALYSIS"
WHERE "TEMPLATE_ID" = '55555555-5555-5555-5555-555555555555';

-- 清理测试数据
DELETE FROM "APPATTACH_CATALOGUE_TEMPLATES"
WHERE "ID" = '55555555-5555-5555-5555-555555555555';

SELECT '基于ABP vNext的权限系统测试完成！（简化版本）' AS "TEST_STATUS";
