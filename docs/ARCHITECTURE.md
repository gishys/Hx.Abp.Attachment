# 系统架构设计文档

## 概述

本文档详细描述了 Hx.Abp.Attachment 智能档案管理系统的架构设计，包括系统架构、技术选型、模块设计、数据流等核心内容。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                       前端展示层                                │
├─────────────────────────────────────────────────────────────────┤
│  Web UI (MVC)  │  Mobile App  │  API Client  │  Admin Portal  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       API 网关层                                │
├─────────────────────────────────────────────────────────────────┤
│  HTTP API  │  Authentication  │  Rate Limiting  │  CORS  │  Logging │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      应用服务层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Attachment App Service  │  AI Classification Service  │  Search Service │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      领域服务层                                 │
├─────────────────────────────────────────────────────────────────┤
│  Domain Services  │  Business Rules  │  Validation  │  Events  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      基础设施层                                 │
├─────────────────────────────────────────────────────────────────┤
│  EF Core  │  PostgreSQL  │  Redis  │  File Storage  │  External APIs │
└─────────────────────────────────────────────────────────────────┘
```

## 架构原则

### 1. 分层架构 (Layered Architecture)

系统严格遵循分层架构原则，每一层都有明确的职责和边界：

-   **表现层 (Presentation Layer)**: 处理用户交互和请求
-   **应用层 (Application Layer)**: 协调领域对象完成业务用例
-   **领域层 (Domain Layer)**: 包含业务逻辑和规则
-   **基础设施层 (Infrastructure Layer)**: 提供技术实现支持

### 2. 依赖倒置原则 (Dependency Inversion Principle)

-   高层模块不依赖低层模块，都依赖抽象
-   抽象不依赖细节，细节依赖抽象
-   通过接口和抽象类实现依赖倒置

### 3. 单一职责原则 (Single Responsibility Principle)

每个模块、类和方法都有单一的、明确的职责，避免职责混淆。

### 4. 开闭原则 (Open-Closed Principle)

对扩展开放，对修改关闭，通过接口和抽象实现功能扩展。

## 技术架构

### 核心技术栈

| 技术领域     | 技术选型              | 版本 | 说明                |
| ------------ | --------------------- | ---- | ------------------- |
| **开发框架** | ABP Framework         | 8.0  | 企业级应用开发框架  |
| **运行时**   | .NET                  | 8.0  | 跨平台开发平台      |
| **Web 框架** | ASP.NET Core          | 8.0  | 高性能 Web 应用框架 |
| **ORM 框架** | Entity Framework Core | 8.0  | 对象关系映射        |
| **数据库**   | PostgreSQL            | 14+  | 关系型数据库        |
| **缓存**     | Redis                 | 7.0+ | 分布式缓存          |
| **AI 服务**  | 阿里云 OpenNLU        | v1   | 自然语言处理        |
| **消息队列** | RabbitMQ              | 3.9+ | 异步消息处理        |
| **日志**     | Serilog               | 3.0+ | 结构化日志记录      |
| **监控**     | Prometheus + Grafana  | -    | 系统监控            |

### 技术选型理由

#### ABP Framework

-   **成熟稳定**: 经过大量企业级项目验证
-   **DDD 支持**: 内置领域驱动设计支持
-   **模块化**: 支持功能模块的独立开发和部署
-   **生态丰富**: 提供完整的开发工具链

#### PostgreSQL

-   **JSONB 支持**: 原生支持 JSON 数据类型，适合存储非结构化数据
-   **全文搜索**: 内置全文搜索功能，支持中文分词
-   **扩展性**: 支持自定义扩展和函数
-   **性能优秀**: 在大数据量场景下性能表现优异

#### Entity Framework Core

-   **LINQ 支持**: 强类型查询，编译时检查
-   **迁移支持**: 数据库架构版本管理
-   **性能优化**: 支持查询优化和缓存
-   **跨平台**: 支持多种数据库平台

## 模块设计

### 1. 核心业务模块

#### Attachment Management Module

负责档案的基本管理功能，包括创建、读取、更新、删除等操作。

**核心组件**:

-   `AttachCatalogue`: 档案目录实体
-   `AttachCatalogueAppService`: 档案管理应用服务
-   `AttachCatalogueRepository`: 档案数据访问层

**设计特点**:

-   支持批量操作
-   实现软删除
-   支持审计日志
-   权限控制集成

#### AI Classification Module

负责档案的智能分类功能，集成阿里云 OpenNLU 服务。

**核心组件**:

-   `AliyunAIService`: 阿里云 AI 服务封装
-   `IntelligentClassificationService`: 智能分类服务
-   `ClassificationResult`: 分类结果模型

**设计特点**:

-   异步处理支持
-   批量分类优化
-   置信度评估
-   分类结果缓存

#### Search Module

负责档案的检索功能，支持全文搜索和语义搜索。

**核心组件**:

-   `DocumentAnalysisService`: 文档分析服务
-   `FullTextSearchService`: 全文搜索服务
-   `SemanticSearchService`: 语义搜索服务

**设计特点**:

-   多维度搜索
-   搜索结果排序
-   搜索建议
-   搜索历史记录

### 2. 基础设施模块

#### Data Access Module

负责数据访问和持久化，基于 Entity Framework Core 实现。

**核心组件**:

-   `AttachmentDbContext`: 数据库上下文
-   `Repository<T>`: 通用仓储接口
-   `UnitOfWork`: 工作单元模式

**设计特点**:

-   仓储模式实现
-   工作单元模式
-   查询优化
-   连接池管理

#### Caching Module

负责系统缓存管理，提升系统性能。

**核心组件**:

-   `ICacheService`: 缓存服务接口
-   `RedisCacheService`: Redis 缓存实现
-   `MemoryCacheService`: 内存缓存实现

**设计特点**:

-   多级缓存
-   缓存失效策略
-   分布式缓存
-   缓存监控

#### Security Module

负责系统安全控制，包括认证、授权和审计。

**核心组件**:

-   `IPermissionService`: 权限服务
-   `IAuditService`: 审计服务
-   `IEncryptionService`: 加密服务

**设计特点**:

-   基于角色的访问控制
-   细粒度权限控制
-   操作审计日志
-   数据加密存储

## 数据架构

### 数据模型设计

#### 核心实体关系

```
AttachCatalogue (档案目录)
    ├── AttachCatalogueTemplate (目录模板)
    ├── Attachment (附件)
    └── AttachCataloguePermission (目录权限)

AttachCatalogueTemplate (目录模板)
    ├── AttachCatalogueTemplatePermission (模板权限)
    └── AttachCatalogue (使用该模板的目录)

Attachment (附件)
    └── AttachCatalogue (所属目录)
```

#### 数据存储策略

**结构化数据**: 存储在关系型数据库 PostgreSQL 中
**非结构化数据**: 存储在文件系统中，元数据存储在数据库
**半结构化数据**: 使用 JSONB 类型存储在 PostgreSQL 中
**向量数据**: 使用专门的向量存储或 PostgreSQL 的数组类型

### 数据访问模式

#### 查询模式

-   **简单查询**: 直接使用 EF Core 的 LINQ 查询
-   **复杂查询**: 使用原生 SQL 或存储过程
-   **全文搜索**: 使用 PostgreSQL 的全文搜索功能
-   **向量搜索**: 使用相似度计算算法

#### 更新模式

-   **乐观并发**: 使用版本号控制并发更新
-   **批量更新**: 支持批量操作提升性能
-   **事务管理**: 使用工作单元模式管理事务

## 安全架构

### 认证与授权

#### 认证机制

-   **JWT Token**: 无状态认证，支持分布式部署
-   **OAuth 2.0**: 支持第三方认证集成
-   **多因素认证**: 支持短信、邮箱等二次验证

#### 授权策略

-   **基于角色**: 用户通过角色获得权限
-   **基于策略**: 支持复杂的权限策略定义
-   **动态权限**: 支持运行时权限调整

### 数据安全

#### 数据加密

-   **传输加密**: 使用 HTTPS/TLS 加密传输
-   **存储加密**: 敏感数据使用 AES 加密存储
-   **密钥管理**: 使用密钥管理服务管理加密密钥

#### 数据脱敏

-   **显示脱敏**: 敏感信息显示时进行脱敏处理
-   **导出脱敏**: 数据导出时自动脱敏
-   **日志脱敏**: 日志记录时敏感信息脱敏

## 性能架构

### 性能优化策略

#### 数据库优化

-   **索引优化**: 合理设计数据库索引
-   **查询优化**: 优化 SQL 查询语句
-   **连接池**: 使用数据库连接池
-   **读写分离**: 支持主从数据库分离

#### 应用优化

-   **缓存策略**: 多级缓存提升响应速度
-   **异步处理**: 使用异步编程模式
-   **负载均衡**: 支持多实例负载均衡
-   **CDN 加速**: 静态资源使用 CDN 加速

### 监控与告警

#### 性能监控

-   **应用性能**: 监控应用响应时间和吞吐量
-   **数据库性能**: 监控数据库查询性能
-   **系统资源**: 监控 CPU、内存、磁盘等资源使用

#### 告警机制

-   **阈值告警**: 设置性能指标阈值告警
-   **异常告警**: 系统异常时自动告警
-   **趋势告警**: 性能下降趋势告警

## 部署架构

### 部署模式

#### 单体部署

适用于中小型项目，所有服务部署在同一个进程中。

#### 微服务部署

适用于大型项目，将系统拆分为多个独立的微服务。

#### 容器化部署

使用 Docker 容器化部署，支持快速部署和扩展。

### 环境管理

#### 开发环境

-   本地开发环境
-   开发服务器环境
-   集成测试环境

#### 生产环境

-   生产服务器环境
-   负载均衡环境
-   监控告警环境

## 扩展性设计

### 水平扩展

#### 应用层扩展

-   支持多实例部署
-   使用负载均衡分发请求
-   支持无状态设计

#### 数据层扩展

-   支持数据库读写分离
-   支持数据库分片
-   支持分布式缓存

### 垂直扩展

#### 功能扩展

-   模块化设计支持功能扩展
-   插件化架构支持第三方扩展
-   API 版本管理支持接口演进

#### 性能扩展

-   支持缓存扩展
-   支持异步处理扩展
-   支持批处理扩展

## 总结

Hx.Abp.Attachment 系统采用现代化的分层架构设计，严格遵循 DDD 设计原则，通过模块化设计实现功能的内聚和模块间的松耦合。系统具有良好的扩展性、可维护性和性能表现，能够满足企业级档案管理的各种需求。

通过合理的技术选型和架构设计，系统在保证功能完整性的同时，也具备了良好的技术先进性和未来扩展能力。
